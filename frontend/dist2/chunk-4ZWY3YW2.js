import{a as _n}from"/static/chunk-ONCHN4RU.js";import{a as wn}from"/static/chunk-X4GKH4OI.js";import{a as xn}from"/static/chunk-67FTXEWX.js";import{a as Nn}from"/static/chunk-QUCOEN55.js";import{a as kt}from"/static/chunk-TBYU2GKH.js";import{j as Sn}from"/static/chunk-YDKHEMDP.js";import{d as Ho}from"/static/chunk-7SO55T25.js";import{a as kn}from"/static/chunk-CEZSENEJ.js";import{$a as Le,$d as Lt,Ai as vn,Bi as Fn,Cd as Oe,Ce as Ze,Cf as an,Do as z,Eh as hn,Eo as ot,Gm as Ln,If as sn,Io as W,Jg as ye,Kg as et,Ko as Pn,Lh as Et,Mb as qt,Nf as ln,Nk as Tn,Od as Yt,Of as cn,Pf as un,Qd as Tt,Rd as Be,Rf as pn,Sa as Te,Sb as zt,Sc as Ce,Sd as F,Ta as We,Tf as N,Uf as dn,Vd as ge,Wb as Wt,Wd as V,Xd as ce,Yh as bn,Ym as It,Za as Xe,Zm as nt,_f as De,a as O,ae as Zt,b as Jt,cc as Ke,ce as en,ch as yn,ee as Ee,f as vt,fe as Ie,g as Ao,gb as Qt,h as Ut,hg as mn,ie as fe,ig as pe,je as D,ji as tt,kc as Xt,mn as Cn,ng as gn,np as An,oe as tn,pe as j,r as x,rp as St,se as nn,sn as En,td as Kt,ue,up as Hn,ve as Ye,vo as In,yf as rn,ze as on}from"/static/chunk-TW5IU73S.js";import{Ha as ne,a as Fe,d as bt,da as Po,jc as Ft,na as Vt,ya as jt,za as Re}from"/static/chunk-3UDJFOQH.js";import{_k as fn,cl as Ct}from"/static/chunk-HHT4SG7V.js";import{b as $t,d as m,e as y,g as h,j as b}from"/static/chunk-SJXEOBQC.js";var Wn=$t(rt=>{"use strict";y();b();h();Object.defineProperty(rt,"__esModule",{value:!0});var Je,ae=Fe(),_t=(Je=ae)&&typeof Je=="object"&&"default"in Je?Je.default:Je;function Pt(){return(Pt=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var o in n)Object.prototype.hasOwnProperty.call(n,o)&&(e[o]=n[o])}return e}).apply(this,arguments)}var qn=[],zn=!1,Un=function(){if(zn)for(var e;e=qn.shift();)e()},At=typeof window>"u"?{__unlayer_lastEditorId:0}:window;At.__unlayer_lastEditorId=At.__unlayer_lastEditorId||0;var Qn=_t.forwardRef(function(e,t){var n,o,i,r,a,s,u,l,g,C=e.onLoad,f=e.onReady,L=e.scriptUrl,E=e.minHeight,w=E===void 0?500:E,A=e.style,$=A===void 0?{}:A,X=ae.useState(null),B=X[0],Ae=X[1],se=ae.useState(!1),le=se[0],k=se[1],ee=ae.useMemo(function(){return e.editorId||"editor-"+ ++At.__unlayer_lastEditorId},[e.editorId]),te=Pt({},e.options||{},{appearance:(n=e.appearance)!=null?n:(o=e.options)==null?void 0:o.appearance,displayMode:e?.displayMode||((i=e.options)==null?void 0:i.displayMode)||"email",locale:(r=e.locale)!=null?r:(a=e.options)==null?void 0:a.locale,projectId:(s=e.projectId)!=null?s:(u=e.options)==null?void 0:u.projectId,tools:(l=e.tools)!=null?l:(g=e.options)==null?void 0:g.tools,id:ee,source:{name:"react-email-editor",version:"1.7.11"}});ae.useImperativeHandle(t,function(){return{editor:B}},[B]),ae.useEffect(function(){return function(){B?.destroy()}},[]),ae.useEffect(function(){k(!1),function(K,me){if(me===void 0&&(me="https://editor.unlayer.com/embed.js?2"),qn.push(function(){return k(!0)}),function(mt){var gt=document.querySelectorAll("script"),Me=!1;return gt.forEach(function(ft){ft.src.includes(mt)&&(Me=!0)}),Me}(me))Un();else{var He=document.createElement("script");He.setAttribute("src",me),He.onload=function(){zn=!0,Un()},document.head.appendChild(He)}}(0,L)},[L]),ae.useEffect(function(){le&&(B?.destroy(),Ae(unlayer.createEditor(te)))},[JSON.stringify(te),le]);var ze=Object.keys(e).filter(function(K){return/^on/.test(K)});return ae.useEffect(function(){B&&(C?.(B),ze.forEach(function(K){/^on/.test(K)&&K!=="onLoad"&&K!=="onReady"&&typeof e[K]=="function"&&B.addEventListener(K,e[K])}),f&&B.addEventListener("editor:ready",function(){f(B)}))},[B,Object.keys(ze).join(",")]),_t.createElement("div",{style:{flex:1,display:"flex",minHeight:w}},_t.createElement("div",{id:ee,style:Pt({},$,{flex:1})}))});rt.EmailEditor=Qn,rt.default=Qn});var Kn=$t((da,Xn)=>{"use strict";y();b();h();Xn.exports=Wn()});y();b();h();var oe=m(O()),Mn=m(Xe());var $e={transformation:"transformations",destination:"destinations","site-app":"site-apps",source:"sources"},Ci=(0,oe.kea)([(0,oe.props)({}),(0,oe.connect)({values:[ot,["user"]]}),(0,oe.path)(e=>["scenes","pipeline","pipelineNodeNewLogic",e]),(0,Mn.loaders)({plugins:[{},{loadPlugins:async()=>Cn("api/organizations/@current/pipeline_destinations")}]}),(0,oe.selectors)(()=>({loading:[e=>[e.pluginsLoading],e=>e],breadcrumbs:[(e,t)=>[t.stage,t.pluginId,t.batchExportDestination],(e,t,n)=>[{key:"Pipeline",name:"Data pipeline",path:z.pipeline()},{key:e||"unknown",name:e?ne($e[e]||""):"Unknown",path:z.pipeline(e?$e[e]:void 0)},{key:t||n||"Unknown",name:t?"New":n?`New ${n} destination`:"New"}]]}))]);y();b();h();var U=m(O()),it=m(vt());var Gn=(0,U.kea)([(0,U.props)({}),(0,U.key)(({id:e})=>e),(0,U.path)(e=>["scenes","pipeline","pipelineNodeLogic",e]),(0,U.actions)({setCurrentTab:(e="configuration")=>({tab:e}),setBreadcrumbTitle:e=>({title:e})}),(0,U.reducers)(()=>({currentTab:["configuration",{setCurrentTab:(e,{tab:t})=>t}],breadcrumbTitle:["",{setBreadcrumbTitle:(e,{title:t})=>t}]})),(0,U.selectors)(()=>({breadcrumbs:[(e,t)=>[t.id,t.stage,e.breadcrumbTitle],(e,t,n)=>[{key:"Pipeline",name:"Data pipeline",path:z.pipeline()},{key:t||"unknown",name:t?ne($e[t]||""):"Unknown",path:z.pipeline(t?$e[t]:void 0)},{key:["PipelineNode",e],name:n}]],[dn]:[e=>[e.node],e=>e.backend==="plugin"?{activity_scope:"Plugin",activity_item_id:`${e.id}`}:null],nodeBackend:[e=>[e.node],e=>e.backend],node:[(e,t)=>[t.id],e=>typeof e=="string"?e.indexOf("hog-")===0?{backend:"hog_function",id:`${e}`.replace("hog-","")}:e.indexOf("managed")===0?{backend:"managed_source",id:`${e}`.replace("managed-","")}:e.indexOf("self-managed")===0?{backend:"self_managed",id:`${e}`.replace("self-managed-","")}:{backend:"batch_export",id:e}:{backend:"plugin",id:e}],tabs:[e=>[e.nodeBackend],e=>{let t=Object.values(bt);return e==="batch_export"?t.filter(n=>n!=="history"):t}],id:[(e,t)=>[t.id],e=>e],stage:[(e,t)=>[t.stage],e=>e]})),(0,it.actionToUrl)(({values:e,props:t})=>({setCurrentTab:()=>[z.pipelineNode(t.stage,t.id,e.currentTab)]})),(0,it.urlToAction)(({props:e,actions:t,values:n})=>({[z.pipelineNode(e.stage,e.id,":nodeTab")]:({nodeTab:o})=>{o!==n.currentTab&&Object.values(bt).includes(o)&&t.setCurrentTab(o)}}))]);y();b();h();var dt=m(Ut()),Pe=m(O()),Lo=m(Le()),Co=m(vt());y();b();h();var wt=m(Ho()),xt=m(O());y();b();h();var he=m(Po()),P=m(O()),Bn=m(Le()),Dn=m(Xe()),J=m(vt()),$n=m(Ao());var Rn=1e3,Bo=1e3*60*5,Do={id:"new",free:!1,type:"destination",name:"",description:"",inputs_schema:[],hog:"print('Hello, world!');",status:"stable"},$o=["transformation","destination"];function Nt(e){function t(o){let i={};return o.inputs_schema?.forEach(r=>{let a=o.inputs?.[r.key]?.secret,s=o.inputs?.[r.key]?.value;if(a){i[r.key]={value:"********",secret:!0};return}if(r.type==="json"&&typeof s=="string")try{s=JSON.parse(s)}catch{}i[r.key]={value:s}}),i}return{...e,filters:e.filters,mappings:e.mappings?.map(o=>({...o,inputs:t(o)})),inputs:t(e),masking:e.masking?.hash?e.masking:null,icon_url:e.icon_url}}var On=e=>{function t(o){let i={};return o?.forEach(r=>{r.default!==void 0&&(i[r.key]={value:r.default})}),i}function n(o){let i={};return o?.forEach(r=>{r.default!==void 0&&(i[r.key]={value:r.default})}),i}return{type:e.type??"destination",name:e.name,description:e.description,inputs_schema:e.inputs_schema,filters:e.filters,mappings:e.mappings?.map(o=>({...o,inputs:n(o.inputs_schema)})),hog:e.hog,icon_url:e.icon_url,inputs:t(e.inputs_schema),enabled:e.type!=="broadcast"}};function Jo(e,t){let n=Pn.findMounted()?.values?.currentTeam,o=`${window.location.origin}/project/${n?.id}`;return{project:{id:n?.id??0,name:n?.name??"Default project",url:o},event:{uuid:e.uuid??"",event:e.event,distinct_id:e.distinct_id,elements_chain:e.elements_chain??"",properties:e.properties,timestamp:e.timestamp,url:`${o}/events/${encodeURIComponent(e.uuid??"")}/${encodeURIComponent(e.timestamp)}`},person:{id:t.id??"",properties:t.properties,name:hn(t),url:`${o}/person/${encodeURIComponent(e.distinct_id)}`},groups:{}}}var I=(0,P.kea)([(0,P.path)(e=>["scenes","pipeline","hogFunctionConfigurationLogic",e]),(0,P.props)({}),(0,P.key)(({id:e,templateId:t,logicKey:n})=>{let o=e??t??"new";return n?`${n}_${o}`:o}),(0,P.connect)(({id:e})=>({values:[mn,["currentProjectId","currentProject"],pe,["groupTypes"],ot,["hasAvailableFeature"]],actions:[Gn({id:`hog-${e}`,stage:"destination"}),["setBreadcrumbTitle"]]})),(0,P.actions)({setShowSource:e=>({showSource:e}),resetForm:!0,upsertHogFunction:e=>({configuration:e}),duplicate:!0,duplicateFromTemplate:!0,resetToTemplate:!0,deleteHogFunction:!0,sparklineQueryChanged:e=>({sparklineQuery:e}),personsCountQueryChanged:e=>({personsCountQuery:e}),loadSampleGlobals:!0,setUnsavedConfiguration:e=>({configuration:e}),persistForUnload:!0,setSampleGlobalsError:e=>({error:e}),setSampleGlobals:e=>({sampleGlobals:e}),setShowEventsList:e=>({showEventsList:e})}),(0,P.reducers)(({props:e})=>({sampleGlobals:[null,{setSampleGlobals:(t,{sampleGlobals:n})=>n}],showSource:[!!(!e.id&&e.templateId?.startsWith("template-blank-")),{setShowSource:(t,{showSource:n})=>n}],hasHadSubmissionErrors:[!1,{upsertHogFunctionFailure:()=>!0}],unsavedConfiguration:[null,{persist:!0},{setUnsavedConfiguration:(t,{configuration:n})=>n?{timestamp:Date.now(),configuration:n}:null}],sampleGlobalsError:[null,{loadSampleGlobals:()=>null,setSampleGlobalsError:(t,{error:n})=>n}],showEventsList:[!1,{setShowEventsList:(t,{showEventsList:n})=>n}]})),(0,Dn.loaders)(({actions:e,props:t,values:n})=>({template:[null,{loadTemplate:async()=>{if(!t.templateId)return null;if(t.templateId==="new")return{...Do};let o=await W.hogFunctions.getTemplate(t.templateId);if(!o)throw new Error("Template not found");return o}}],hogFunction:[null,{loadHogFunction:async()=>!t.id||t.id==="new"?null:await W.hogFunctions.get(t.id),upsertHogFunction:async({configuration:o})=>{let i=t.id&&t.id!=="new"?await W.hogFunctions.update(t.id,o):await W.hogFunctions.create(o);return Jt.capture("hog function saved",{id:i.id,template_id:i.template?.id,template_name:i.template?.name}),ge.success("Configuration saved"),i}}],sparkline:[null,{sparklineQueryChanged:async({sparklineQuery:o},i)=>{if(n.type!=="destination"&&n.type!=="site_destination")return null;n.sparkline===null?await i(100):await i(1e3);let r=await De(o);i();let a=r?.results?.[0]?.data??[],[s,u]=a.reduce((f,L)=>(f[0].push(Math.min(L,Rn)),f[1].push(Math.max(0,L-Rn)),f),[[],[]]),l=[{name:"Low volume",values:s,color:"success"},{name:"High volume",values:u,color:"warning"}],g=r?.results?.[0]?.count,C=r?.results?.[0]?.labels;return{data:l,count:g,labels:C}}}],personsCount:[null,{personsCountQueryChanged:async({personsCountQuery:o},i)=>{if(n.type!=="broadcast")return null;n.personsCount===null?await i(100):await i(1e3);let r=await De(o);return i(),r?.results?.[0]?.[0]??null}}],sampleGlobals:[null,{loadSampleGlobals:async(o,i)=>{if(!n.lastEventQuery)return n.sampleGlobals;let r="No events match these filters in the last 30 days. Showing an example $pageview event instead.";try{await i(n.sampleGlobals===null?10:1e3);let a=await De(n.lastEventQuery);if(!a?.results?.[0]&&n.lastEventSecondQuery&&(a=await De(n.lastEventSecondQuery)),!a?.results?.[0])throw new Error(r);let s=a?.results?.[0]?.[0],u=a?.results?.[0]?.[1],l=Jo(s,u);return l.groups={},n.groupTypes.forEach((g,C)=>{let f=a?.results?.[0]?.[2+C];if(f&&Array.isArray(f)&&f[2]){let L={};try{L=JSON.parse(f[3])}catch{}l.groups[g.group_type]={type:g.group_type,index:f[1],id:f[2],url:`${window.location.origin}/groups/${f[1]}/${encodeURIComponent(f[2])}`,properties:L}}}),l.source={name:n.configuration?.name??"Unnamed",url:window.location.href.split("#")[0]},l}catch(a){return(0,P.isBreakpoint)(a)||e.setSampleGlobalsError(a.message??r),n.exampleInvocationGlobals}}}]})),(0,Bn.forms)(({values:e,props:t,asyncActions:n})=>({configuration:{defaults:{},alwaysShowErrors:!0,errors:o=>({name:o.name?void 0:"Name is required",mappings:o.type==="site_destination"&&(!o.mappings||o.mappings.length===0)?"You must add at least one mapping":void 0,filters:o.type==="internal_destination"&&o.filters?.events?.length===0?"You must choose a filter":void 0,...e.inputFormErrors}),submit:async o=>{let i=Nt(o);i.template_id=t.templateId||e.hogFunction?.template?.id,e.hasAddon||(delete i.hog,delete i.inputs_schema),await n.upsertHogFunction(i)}}})),(0,P.selectors)(()=>({logicProps:[()=>[(e,t)=>t],e=>e],type:[e=>[e.configuration,e.hogFunction],(e,t)=>e?.type??t?.type??"loading"],hasAddon:[e=>[e.hasAvailableFeature],e=>e("data_pipelines")],hasGroupsAddon:[e=>[e.hasAvailableFeature],e=>e("group_analytics")],showPaygate:[e=>[e.template,e.hasAddon],(e,t)=>e&&!e.free&&!t],useMapping:[e=>[e.hogFunction,e.template],(e,t)=>Array.isArray(e?.mappings)||t?.mapping_templates?.length],defaultFormState:[e=>[e.template,e.hogFunction],(e,t)=>e?On(e):t??null],templateId:[e=>[e.template,e.hogFunction],(e,t)=>e?.id||t?.template?.id],loading:[e=>[e.hogFunctionLoading,e.templateLoading],(e,t)=>e||t],loaded:[e=>[e.hogFunction,e.template],(e,t)=>!!e||!!t],inputFormErrors:[e=>[e.configuration],e=>{let t=e.inputs??{},n={};return e.inputs_schema?.forEach(o=>{let i=o.key,r=t[i]?.value;if(t[i]?.secret)return;let a=r==null||r==="";if(o.required&&a&&(n[i]="This field is required"),o.type==="json"&&typeof r=="string")try{JSON.parse(r)}catch{n[i]="Invalid JSON"}if(o.type==="email"&&r){let s={html:r.html?void 0:"HTML is required",subject:r.subject?void 0:"Subject is required",from:r.from?void 0:"From is required",to:r.to?void 0:"To is required"};Object.values(s).some(u=>!!u)&&(n[i]={value:s})}}),Object.keys(n).length>0?{inputs:n}:null}],willReEnableOnSave:[e=>[e.configuration,e.hogFunction],(e,t)=>e?.enabled&&(t?.status?.state??0)>=3],willChangeEnabledOnSave:[e=>[e.configuration,e.hogFunction],(e,t)=>e?.enabled!==(t?.enabled??!1)],exampleInvocationGlobals:[e=>[e.configuration,e.currentProject,e.groupTypes],(e,t,n)=>{let o=window.location.href.split("#")[0],i=Re(),r=Re(),a={event:{uuid:i,distinct_id:Re(),event:"$pageview",timestamp:(0,Vt.default)().toISOString(),elements_chain:"",properties:{$current_url:o,$browser:"Chrome"},url:`${window.location.origin}/project/${t?.id}/events/`},person:{id:r,properties:{email:"example@posthog.com"},name:"Example person",url:`${window.location.origin}/person/${r}`},groups:{},project:{id:t?.id||0,name:t?.name||"",url:`${window.location.origin}/project/${t?.id}`},source:{name:e?.name??"Unnamed",url:o}};return n.forEach(s=>{let u=Re();a.groups[s.group_type]={id:u,type:s.group_type,index:s.group_type_index,url:`${window.location.origin}/groups/${s.group_type_index}/${encodeURIComponent(u)}`,properties:{}}}),a}],globalsWithInputs:[e=>[e.sampleGlobals,e.exampleInvocationGlobals,e.configuration],(e,t,n)=>{let o={};for(let i of n?.inputs_schema||[])o[i.key]=i.type;return{...e??t,inputs:o}}],matchingFilters:[e=>[e.configuration,e.useMapping],(e,t)=>{if(t&&!e.mappings?.length)return{type:"AND",values:[{type:"AND",values:[{type:"hogql",key:"false"}]}]};let n={type:"OR",values:[]},o={type:"AND",values:[n]},i=e.filters?.events??[],r=e.filters?.actions??[];if(Array.isArray(e.mappings))for(let a of e.mappings)a.filters?.events&&i.push(...a.filters.events),a.filters?.actions&&r.push(...a.filters.actions);for(let a of i){let s=[...a.properties??[]];a.id&&s.push({type:"hogql",key:St`event = ${a.id}`}),s.length===0&&s.push({type:"hogql",key:"true"}),n.values.push({type:"AND",values:s})}for(let a of r){let s=[...a.properties??[]];a.id&&s.push({type:"hogql",key:St`matchesAction(${parseInt(a.id)})`}),n.values.push({type:"AND",values:s})}if((e.filters?.properties?.length??0)>0){let a={type:"AND",values:[]};for(let s of e.filters?.properties??[])a.values.push(s);o.values.push(a)}return o},{resultEqualityCheck:he.default}],sparklineQuery:[e=>[e.configuration,e.matchingFilters,e.type],(e,t,n)=>n!=="destination"&&n!=="site_destination"?null:{kind:"TrendsQuery",filterTestAccounts:e.filters?.filter_test_accounts,series:[{kind:"EventsNode",event:null,name:"All Events",math:"total"}],properties:t,interval:"day",dateRange:{date_from:"-7d"},trendsFilter:{display:"ActionsBar"}},{resultEqualityCheck:he.default}],personsCountQuery:[e=>[e.configuration,e.type],(e,t)=>t!=="broadcast"?null:{kind:"ActorsQuery",properties:e.filters?.properties,select:["count()"]},{resultEqualityCheck:he.default}],personsListQuery:[e=>[e.configuration,e.type],(e,t)=>t!=="broadcast"?null:{kind:"DataTableNode",source:{kind:"ActorsQuery",properties:e.filters?.properties,select:["person","properties.email","created_at"]},full:!0},{resultEqualityCheck:he.default}],baseEventsQuery:[e=>[e.configuration,e.matchingFilters,e.groupTypes,e.type],(e,t,n,o)=>{if(!$o.includes(o))return null;let i={kind:"EventsQuery",filterTestAccounts:e.filters?.filter_test_accounts,fixedProperties:[t],select:["*","person"],after:"-7d",orderBy:["timestamp DESC"]};return n.forEach(r=>{let a=An(r.group_type);i.select.push(`tuple(${a}.created_at, ${a}.index, ${a}.key, ${a}.properties, ${a}.updated_at)`)}),i},{resultEqualityCheck:he.default}],eventsDataTableNode:[e=>[e.baseEventsQuery],e=>e?{kind:"DataTableNode",source:{...e,select:Hn("EventsQuery")}}:null],lastEventQuery:[e=>[e.baseEventsQuery],e=>e?{...e,limit:1}:null,{resultEqualityCheck:he.default}],lastEventSecondQuery:[e=>[e.lastEventQuery],e=>e?{...e,after:"-30d"}:null],templateHasChanged:[e=>[e.hogFunction,e.configuration],(e,t)=>e?.template?.hog&&e.template.hog!==t.hog],mappingTemplates:[e=>[e.hogFunction,e.template],(e,t)=>t?.mapping_templates??e?.template?.mapping_templates??[]],usesGroups:[e=>[e.configuration],e=>{let t=JSON.stringify(e);return t.includes("groups.")||t.includes("{groups}")}]})),(0,P.listeners)(({actions:e,values:t,cache:n})=>({loadTemplateSuccess:()=>e.resetForm(),loadHogFunctionSuccess:()=>{e.resetForm(),e.setBreadcrumbTitle(t.hogFunction?.name??"Unnamed")},upsertHogFunctionSuccess:()=>{e.resetForm(),e.setBreadcrumbTitle(t.hogFunction?.name??"Unnamed")},upsertHogFunctionFailure:({errorObject:o})=>{let i=o.data;i?.type==="validation_error"?setTimeout(()=>{i.attr.includes("inputs__")?e.setConfigurationManualErrors({inputs:{[i.attr.split("__")[1]]:i.detail}}):e.setConfigurationManualErrors({[i.attr]:i.detail})},1):(console.error(o),ge.error("Error submitting configuration"))},resetForm:()=>{let o=t.defaultFormState;if(!o)return;let i={...o,...n.configFromUrl??{}};t.template?.mapping_templates&&(i.mappings=[...i.mappings??[],...t.template.mapping_templates.filter(s=>s.include_by_default).map(s=>({...s,inputs:s.inputs_schema?.reduce((u,l)=>(u[l.key]={value:l.default},u),{})}))]);let r=n.paramsFromUrl??{},a=(t.unsavedConfiguration?.timestamp??0)>Date.now()-Bo?t.unsavedConfiguration?.configuration:null;if(e.resetConfiguration(i),a&&e.setConfigurationValues(a),e.setUnsavedConfiguration(null),r.integration_target&&r.integration_id){let s=t.configuration?.inputs??{};s[r.integration_target]={value:r.integration_id},e.setConfigurationValues({inputs:s})}},duplicate:async()=>{if(t.hogFunction){let o={...t.configuration,name:`${t.configuration.name} (copy)`},i=t.hogFunction.template?.id??"new";J.router.actions.push(It(o.type,i),void 0,{configuration:o})}},duplicateFromTemplate:async()=>{if(t.hogFunction?.template){let o={...t.hogFunction.template};J.router.actions.push(It(o.type,o.id),void 0,{configuration:o})}},resetToTemplate:async()=>{let o=t.hogFunction?.template??t.template;if(o){let i=On(o),r=i.inputs??{};Object.entries(t.configuration.inputs??{}).forEach(([a,s])=>{r[a]=r[a]??s}),e.setConfigurationValues({...i,filters:i.filters??t.configuration.filters,name:t.configuration.name,description:t.configuration.description}),ge.success("Template updates applied but not saved.")}},setConfigurationValue:()=>{t.hasHadSubmissionErrors&&e.setConfigurationManualErrors({})},deleteHogFunction:async()=>{if(!t.hogFunction)return;let{id:o,name:i,type:r,template:a}=t.hogFunction;await gn({endpoint:`projects/${t.currentProjectId}/hog_functions`,object:{id:o,name:i},callback(s){s&&J.router.actions.replace(nt(r,o,a?.id))}}),J.router.actions.replace(nt(r,void 0,a?.id))},persistForUnload:()=>{e.setUnsavedConfiguration(t.configuration)}})),(0,P.afterMount)(({props:e,actions:t,cache:n})=>{if(n.paramsFromUrl={integration_id:J.router.values.searchParams.integration_id,integration_target:J.router.values.searchParams.integration_target},e.templateId?(n.configFromUrl=J.router.values.hashParams.configuration,t.loadTemplate()):e.id&&e.id!=="new"&&t.loadHogFunction(),J.router.values.searchParams.integration_target){let o=J.router.values.searchParams;delete o.integration_id,delete o.integration_target,J.router.actions.replace(J.router.values.location.pathname,o,J.router.values.hashParams)}}),(0,$n.subscriptions)(({props:e,actions:t,cache:n})=>({hogFunction:o=>{o&&e.templateId&&(n.disabledBeforeUnload=!0,J.router.actions.replace(nt(o.type,o.id,o.template.id)))},sparklineQuery:async o=>{o&&t.sparklineQueryChanged(o)},personsCountQuery:async o=>{o&&t.personsCountQueryChanged(o)}})),(0,J.beforeUnload)(({values:e,cache:t})=>({enabled:()=>!t.disabledBeforeUnload&&!e.unsavedConfiguration&&e.configurationChanged,message:"Changes you made will be discarded.",onConfirm:()=>{t.disabledBeforeUnload=!0}}))]);y();b();h();var Jn=m(O());var be=m(x()),Vo=e=>e&&e==="errorTracking"?[{label:"Error tracking issue created",value:"$error_tracking_issue_created"}]:[{label:"Team activity",value:"$activity_log_entry_created"}],jo=e=>e?.events?.[0]?.id,Uo=(e,t)=>({events:[{name:e.find(n=>n.value===t)?.label,id:t,type:"events"}]});function Vn(){let{logicProps:e}=(0,Jn.useValues)(I),t=Vo(e.logicKey);return(0,be.jsx)("div",{className:"p-3 space-y-2 border rounded bg-surface-primary",children:(0,be.jsx)(N,{name:"filters",label:"Trigger",help:"Choose what event should trigger this destination",children:({value:n,onChange:o})=>(0,be.jsx)(be.Fragment,{children:(0,be.jsx)(j,{options:t,value:jo(n),onChange:i=>o(Uo(t,i)),placeholder:"Select a filter"})})})})}var T=m(x());function Wo(e){if(!e)return{};let t={};return e.events&&(t.events=e.events.map(n=>({id:n.id,type:"events",name:n.name,order:n.order,properties:n.properties}))),e.actions&&(t.actions=e.actions.map(n=>({id:n.id,type:"actions",name:n.name,order:n.order,properties:n.properties}))),t}function jn(){let{groupsTaxonomicTypes:e}=(0,xt.useValues)(pe),{configuration:t,type:n,useMapping:o}=(0,xt.useValues)(I);if(n==="broadcast")return(0,T.jsx)("div",{className:"p-3 space-y-2 border rounded bg-surface-primary",children:(0,T.jsx)(N,{name:"filters",label:"Filters",children:({value:s,onChange:u})=>(0,T.jsx)(Et,{propertyFilters:s?.properties??[],taxonomicGroupTypes:["person_properties","cohorts","hogql_expression"],onChange:l=>{u({...s,properties:l})},pageKey:`HogFunctionPropertyFilters.${wt.id}`,metadataSource:{kind:"ActorsQuery"}})})});if(n==="internal_destination")return(0,T.jsx)(Vn,{});let i=t?.template?.id?.startsWith("plugin-"),r=n==="destination"&&!i,a=n==="transformation";return(0,T.jsxs)("div",{className:"p-3 space-y-2 border rounded bg-surface-primary",children:[(0,T.jsx)(N,{name:"filters",label:o?"Global filters":"Filters",info:o?"Filters applied to all events before they reach a mapping":null,children:({value:s,onChange:u})=>{let l=s??{};return(0,T.jsxs)(T.Fragment,{children:[o&&(0,T.jsx)("p",{className:"mb-0 text-sm text-secondary",children:"Filters here apply for all events that could trigger this function, regardless of mappings."}),(0,T.jsx)(Tn,{checked:l?.filter_test_accounts??!1,onChange:g=>u({...l,filter_test_accounts:g}),fullWidth:!0}),(0,T.jsx)(Et,{propertyFilters:l?.properties??[],taxonomicGroupTypes:["event_properties","person_properties","event_feature_flags","elements","hogql_expression"],onChange:g=>{u({...l,properties:g})},pageKey:`HogFunctionPropertyFilters.${wt.id}`}),o?null:(0,T.jsxs)(T.Fragment,{children:[(0,T.jsx)("div",{className:"flex justify-between w-full gap-2",children:(0,T.jsx)(D,{children:"Match events and actions"})}),(0,T.jsxs)("p",{className:"mb-0 text-xs text-secondary",children:["If set, the destination will only run if the ",(0,T.jsx)("b",{children:"event matches any"})," of the below."]}),(0,T.jsx)(tt,{bordered:!0,filters:s??{},setFilters:g=>{u({...s,...Wo(g)})},typeKey:"plugin-filters",mathAvailability:3,hideRename:!0,hideDuplicate:!0,showNestedArrow:!1,actionsTaxonomicGroupTypes:["events","actions"],propertiesTaxonomicGroupTypes:["event_properties","event_feature_flags","elements","person_properties","hogql_expression",...e],propertyFiltersPopover:!0,addFilterDefaultOptions:{id:"$pageview",name:"$pageview",type:"events"},buttonCopy:"Add event matcher"}),a&&(0,T.jsxs)(T.Fragment,{children:[(0,T.jsx)(D,{children:(0,T.jsxs)("span",{className:"flex items-center justify-between flex-1 gap-2",children:["Drop events that don't match",(0,T.jsx)(ce,{checked:s?.drop_events??!1,onChange:g=>u({...s,drop_events:g})})]})}),s?.drop_events?(0,T.jsx)(V,{type:"error",children:"This will drop all events that don't match the above conditions. Please ensure this is definitely intended."}):(0,T.jsx)("p",{children:"Currently, this will run for all events that match the above conditions. Any that do not match will be unmodified and ingested as they are."})]})]})]})}}),r?(0,T.jsx)(N,{name:"masking",label:"Trigger options",children:({value:s,onChange:u})=>(0,T.jsxs)("div",{className:"flex flex-wrap items-center gap-1",children:[(0,T.jsx)(j,{options:[{value:null,label:"Run every time"},{value:"all",label:"Run once per interval"},{value:"{person.id}",label:"Run once per person per interval"},{value:"{concat(person.id, event.event)}",label:"Run once per person per event name per interval"}],value:s?.hash??null,onChange:l=>u({hash:l,ttl:s?.ttl??60*30})}),t.masking?.hash?(0,T.jsxs)(T.Fragment,{children:[(0,T.jsxs)("div",{className:"flex flex-wrap items-center gap-1",children:[(0,T.jsx)("span",{children:"of"}),(0,T.jsx)(j,{value:s?.ttl,onChange:l=>u({...s,ttl:l}),options:[{value:5*60,label:"5 minutes"},{value:15*60,label:"15 minutes"},{value:30*60,label:"30 minutes"},{value:60*60,label:"1 hour"},{value:2*60*60,label:"2 hours"},{value:4*60*60,label:"4 hours"},{value:8*60*60,label:"8 hours"},{value:12*60*60,label:"12 hours"},{value:24*60*60,label:"24 hours"}]})]}),(0,T.jsxs)("div",{className:"flex flex-wrap items-center gap-1",children:[(0,T.jsx)("span",{children:"or until"}),(0,T.jsx)(j,{value:s?.threshold,onChange:l=>u({...s,threshold:l}),options:[{value:null,label:"Not set"},{value:1e3,label:"1000 events"},{value:1e4,label:"10,000 events"},{value:1e5,label:"100,000 events"},{value:1e6,label:"1,000,000 events"}]})]})]}):null]})}):null]})}y();b();h();var xe=m(O());var de=m(Fe());y();b();h();var Ve=m(O()),Yn=m(Le());var Zn=m(Kn());y();b();h();var Q=m(O());var at=(0,Q.kea)([(0,Q.props)({}),(0,Q.connect)({}),(0,Q.path)(()=>["scenes","pipeline","hogfunctions","emailTemplaterLogic"]),(0,Q.actions)({onSave:!0,setEmailEditorRef:e=>({emailEditorRef:e}),emailEditorReady:!0,setIsModalOpen:e=>({isModalOpen:e})}),(0,Q.reducers)({emailEditorRef:[null,{setEmailEditorRef:(e,{emailEditorRef:t})=>t}],isModalOpen:[!1,{setIsModalOpen:(e,{isModalOpen:t})=>t}]}),(0,Q.listeners)(({props:e,values:t,actions:n})=>({onSave:async()=>{let o=t.emailEditorRef?.editor;if(!o)return;let i=await new Promise(s=>o.exportHtml(s)),r=e.formLogic.findMounted(e.formLogicProps)?.actions?.[`set${ne(e.formKey)}Value`],a=e.formFieldsPrefix?e.formFieldsPrefix.split("."):[];r(a.concat("design"),i.design),r(a.concat("html"),Xo(i.html)),n.setIsModalOpen(!1)},emailEditorReady:()=>{let o=(e.formFieldsPrefix?e.formFieldsPrefix.split("."):[]).concat("design"),i=e.formLogic.findMounted(e.formLogicProps)?.values?.[e.formKey];for(;o.length&&i;)i=i[o.shift()];i&&t.emailEditorRef?.editor?.loadDesign(i)}}))]);function Xo(e){let n=new DOMParser().parseFromString(e,"text/html");function o(a){return a.replace(/{/g,"\\{")}function i(a){if(a.nodeType===Node.ELEMENT_NODE){let s=a;s.tagName==="STYLE"||s.tagName==="SCRIPT"?s.textContent=o(s.textContent||""):Array.from(a.childNodes).forEach(i)}else if(a.nodeType===Node.COMMENT_NODE){let s=a.nodeValue||"";a.nodeValue=o(s)}}return i(n.head),i(n.body),new XMLSerializer().serializeToString(n)}var S=m(x());function eo({mode:e,...t}){let{setEmailEditorRef:n,emailEditorReady:o,setIsModalOpen:i}=(0,Ve.useActions)(at(t));return(0,S.jsxs)(Yn.Form,{className:"flex flex-col border rounded overflow-hidden flex-1",logic:t.formLogic,props:t.formLogicProps,formKey:t.formKey,children:[["from","to","subject"].map(r=>(0,S.jsx)(N,{name:`${t.formFieldsPrefix?t.formFieldsPrefix+".":""}${r}`,className:"border-b shrink-0 gap-1 pl-2",renderError:()=>null,children:({value:a,onChange:s,error:u})=>(0,S.jsxs)("div",{className:"flex items-center",children:[(0,S.jsx)(D,{className:u?"text-danger":"",children:ne(r)}),(0,S.jsx)(et,{embedded:!0,className:"flex-1",globals:t.globals,value:a,onChange:s})]})},r)),e==="full"?(0,S.jsx)(Zn.default,{ref:r=>n(r),onReady:()=>o()}):(0,S.jsx)(N,{name:`${t.formFieldsPrefix?t.formFieldsPrefix+".":""}html`,className:"relative flex flex-col",children:({value:r})=>(0,S.jsxs)(S.Fragment,{children:[(0,S.jsxs)("div",{className:"absolute inset-0 p-2 flex items-end justify-center transition-opacity opacity-0 hover:opacity-100",children:[(0,S.jsx)("div",{className:"opacity-50 bg-surface-primary absolute inset-0"}),(0,S.jsx)(F,{type:"primary",size:"small",onClick:()=>i(!0),children:"Click to modify content"})]}),(0,S.jsx)("iframe",{srcDoc:r,className:"flex-1"})]})})]})}function Ko({...e}){let{isModalOpen:t}=(0,Ve.useValues)(at(e)),{setIsModalOpen:n,onSave:o}=(0,Ve.useActions)(at(e));return(0,S.jsx)(en,{isOpen:t,width:"90vw",onClose:()=>n(!1),children:(0,S.jsx)("div",{className:"h-[80vh] flex",children:(0,S.jsxs)("div",{className:"flex flex-col flex-1",children:[(0,S.jsx)("div",{className:"shrink-0",children:(0,S.jsx)("h2",{children:"Editing email template"})}),(0,S.jsx)(eo,{...e,mode:"full"}),(0,S.jsxs)("div",{className:"flex items-center mt-2 gap-2",children:[(0,S.jsx)("div",{className:"flex-1"}),(0,S.jsx)(F,{onClick:()=>n(!1),children:"Cancel"}),(0,S.jsx)(F,{type:"primary",onClick:()=>o(),children:"Save"})]})]})})})}function to(e){return(0,S.jsxs)("div",{className:"flex flex-col flex-1",children:[(0,S.jsx)(eo,{...e,mode:"preview"}),(0,S.jsx)(Ko,{...e})]})}y();b();h();var no=m(O());var je=m(x());function oo({schema:e,...t}){let{persistForUnload:n}=(0,no.useActions)(I);return(0,je.jsx)(je.Fragment,{children:(0,je.jsx)(wn,{...t,schema:e,integration:e.integration,redirectUrl:`${window.location.pathname}?integration_target=${e.key}`,beforeRedirect:()=>n()})})}y();b();h();var Ht=m(O());y();b();h();var ke=m(O()),Se=m(Fe());y();b();h();var ie=m(O()),io=m(Xe());var Ue=(0,ie.kea)([(0,ie.props)({}),(0,ie.key)(e=>e.id),(0,ie.path)(e=>["lib","integrations","googleAdsIntegrationLogic",e]),(0,ie.actions)({loadGoogleAdsConversionActions:e=>e,loadGoogleAdsAccessibleAccounts:!0}),(0,io.loaders)(({props:e})=>({googleAdsConversionActions:[null,{loadGoogleAdsConversionActions:async t=>(await W.integrations.googleAdsConversionActions(e.id,t)).conversionActions}],googleAdsAccessibleAccounts:[null,{loadGoogleAdsAccessibleAccounts:async()=>(await W.integrations.googleAdsAccounts(e.id)).accessibleAccounts}]}))]);var Y=m(x()),Yo=e=>e?e.map(t=>({key:t.id,labelComponent:(0,Y.jsxs)("span",{className:"flex items-center",children:[t.name," (",t.id.replace(/(\d{3})(\d{3})(\d{4})/,"$1-$2-$3"),")"]}),label:`${t.name} (${t.id.replace(/(\d{3})(\d{3})(\d{4})/,"$1-$2-$3")})`})):null,Zo=e=>e?e.map(({id:t,name:n})=>({key:t,labelComponent:(0,Y.jsxs)("span",{className:"flex items-center",children:[n," (",t,")"]}),label:`${n} (${t})`})):null;function ro({onChange:e,value:t,requiresFieldValue:n,integration:o,disabled:i}){let{googleAdsConversionActions:r,googleAdsConversionActionsLoading:a}=(0,ke.useValues)(Ue({id:o.id})),{loadGoogleAdsConversionActions:s}=(0,ke.useActions)(Ue({id:o.id})),u=(0,Se.useMemo)(()=>Zo(r),[r]);return(0,Se.useEffect)(()=>{n&&s(n)},[s,n]),(0,Y.jsx)(Y.Fragment,{children:(0,Y.jsx)(ue,{onChange:l=>e?.(l[0]??null),value:t?[t]:[],onFocus:()=>!r&&!a&&n&&s(n),disabled:i,mode:"single","data-attr":"select-google-ads-conversion-action",placeholder:"Select a Conversion Action...",options:u??(t?[{key:t,label:t}]:[]),loading:a})})}function ao({onChange:e,value:t,integration:n,disabled:o}){let{googleAdsAccessibleAccounts:i,googleAdsAccessibleAccountsLoading:r}=(0,ke.useValues)(Ue({id:n.id})),{loadGoogleAdsAccessibleAccounts:a}=(0,ke.useActions)(Ue({id:n.id})),s=(0,Se.useMemo)(()=>Yo(i),[i]);return(0,Se.useEffect)(()=>{o||a()},[a,o]),(0,Y.jsx)(Y.Fragment,{children:(0,Y.jsx)(ue,{onChange:u=>e?.(u[0]??null),value:t?[t]:[],onFocus:()=>!i&&!r&&a(),disabled:o,mode:"single","data-attr":"select-google-ads-customer-id-channel",placeholder:"Select a Customer ID...",options:s??(t?[{key:t,label:t.replace(/(\d{3})(\d{3})(\d{4})/,"$1-$2-$3")}]:[]),loading:r})})}y();b();h();var Ne=m(O()),we=m(Fe());y();b();h();var re=m(O()),so=m(Xe());var Qe=(0,re.kea)([(0,re.props)({}),(0,re.key)(e=>e.id),(0,re.path)(e=>["lib","integrations","linkedInAdsIntegrationLogic",e]),(0,re.actions)({loadLinkedInAdsConversionRules:e=>e,loadLinkedInAdsAccounts:!0}),(0,so.loaders)(({props:e})=>({linkedInAdsConversionRules:[null,{loadLinkedInAdsConversionRules:async t=>(await W.integrations.linkedInAdsConversionRules(e.id,t)).conversionRules}],linkedInAdsAccounts:[null,{loadLinkedInAdsAccounts:async()=>(await W.integrations.linkedInAdsAccounts(e.id)).adAccounts}]}))]);var Z=m(x()),ei=e=>e?e.map(t=>({key:t.id.toString(),labelComponent:(0,Z.jsxs)("span",{className:"flex items-center",children:[t.name," (",t.id.toString(),")"]}),label:`${t.name}`})):null,ti=e=>e?e.map(({id:t,name:n})=>({key:t.toString(),labelComponent:(0,Z.jsxs)("span",{className:"flex items-center",children:[n," (",t,")"]}),label:`${n} (${t})`})):null;function lo({onChange:e,value:t,requiresFieldValue:n,integration:o,disabled:i}){let{linkedInAdsConversionRules:r,linkedInAdsConversionRulesLoading:a}=(0,Ne.useValues)(Qe({id:o.id})),{loadLinkedInAdsConversionRules:s}=(0,Ne.useActions)(Qe({id:o.id})),u=(0,we.useMemo)(()=>ti(r),[r]);return(0,we.useEffect)(()=>{n&&s(n)},[s,n]),(0,Z.jsx)(Z.Fragment,{children:(0,Z.jsx)(ue,{onChange:l=>e?.(l[0]??null),value:t?[t]:[],onFocus:()=>!r&&!a&&n&&s(n),disabled:i,mode:"single","data-attr":"select-linkedin-ads-conversion-action",placeholder:"Select a Conversion Action...",options:u??(t?[{key:t,label:t}]:[]),loading:a})})}function co({onChange:e,value:t,integration:n,disabled:o}){let{linkedInAdsAccounts:i,linkedInAdsAccountsLoading:r}=(0,Ne.useValues)(Qe({id:n.id})),{loadLinkedInAdsAccounts:a}=(0,Ne.useActions)(Qe({id:n.id})),s=(0,we.useMemo)(()=>ei(i),[i]);return(0,we.useEffect)(()=>{o||a()},[a]),(0,Z.jsx)(Z.Fragment,{children:(0,Z.jsx)(ue,{onChange:u=>e?.(u[0]??null),value:t?[t]:[],onFocus:()=>!i&&!r&&a(),disabled:o,mode:"single","data-attr":"select-linkedin-ads-customer-id-channel",placeholder:"Select a Account ID...",options:s??(t?[{key:t,label:t.replace(/(\d{3})(\d{3})(\d{4})/,"$1-$2-$3")}]:[]),loading:r})})}var q=m(x());function uo({schema:e,value:t,onChange:n}){let{configuration:o}=(0,Ht.useValues)(I),{integrationsLoading:i,integrations:r}=(0,Ht.useValues)(Nn);if(i)return(0,q.jsx)(nn,{className:"h-10"});let a=o.inputs_schema?.find(g=>g.key===e.integration_key);if(!a)return(0,q.jsxs)("div",{className:"text-danger",children:["Bad configuration: integration key ",e.integration_key," not found in schema"]});let s=o.inputs?.[a.key]?.value,u=r?.find(g=>g.id===s),l;if(e.requires_field){let g=o.inputs_schema?.find(f=>f.key===e.requires_field);if(!g)return(0,q.jsxs)("div",{className:"text-danger",children:["Bad configuration: required key ",e.requires_field," not found in schema"]});if(l=o.inputs?.[g.key]?.value,!l)return(0,q.jsxs)("div",{className:"border border-dashed h-10 rounded p-2 text-secondary italic",children:["Configure ",g.label," to continue"]})}return u?e.integration_field==="slack_channel"?(0,q.jsx)(xn,{value:t,onChange:g=>n?.(g?.split("|")[0]),integration:u}):e.integration_field==="google_ads_conversion_action"&&l?(0,q.jsx)(ro,{value:t,requiresFieldValue:l,onChange:g=>n?.(g?.split("|")[0]),integration:u}):e.integration_field==="google_ads_customer_id"?(0,q.jsx)(ao,{value:t,onChange:g=>n?.(g?.split("|")[0]),integration:u}):e.integration_field==="linkedin_ads_conversion_rule_id"&&l?(0,q.jsx)(lo,{value:t,requiresFieldValue:l,onChange:g=>n?.(g?.split("|")[0]),integration:u}):e.integration_field==="linkedin_ads_account_id"?(0,q.jsx)(co,{value:t,onChange:g=>n?.(g?.split("|")[0]),integration:u}):(0,q.jsx)("div",{className:"text-danger",children:(0,q.jsxs)("p",{children:["Unsupported integration type: ",e.integration]})}):(0,q.jsxs)("div",{className:"border border-dashed h-10 rounded p-2 text-secondary italic",children:["Configure ",a.label," to continue"]})}var p=m(x()),ni=["string","boolean","dictionary","choice","json","integration","email"];function oi(e){let{globalsWithInputs:t}=(0,xe.useValues)(I);return(0,p.jsx)(ye,{language:e.templating?"hogJson":"json",value:typeof e.value!="string"?JSON.stringify(e.value,null,2):e.value,onChange:n=>e.onChange?.(n??""),options:{lineNumbers:"off",minimap:{enabled:!1},scrollbar:{vertical:"hidden",verticalScrollbarSize:0}},globals:e.templating?t:void 0})}function ii({schema:e}){let{globalsWithInputs:t,logicProps:n}=(0,xe.useValues)(I);return(0,p.jsx)(p.Fragment,{children:(0,p.jsx)(to,{formLogic:I,formLogicProps:n,formKey:"configuration",formFieldsPrefix:`inputs.${e.key}.value`,globals:t})})}function po(e){let{globalsWithInputs:t}=(0,xe.useValues)(I);return e.templating?(0,p.jsx)(et,{...e,globals:t}):(0,p.jsx)(fe,{type:"text",value:e.value,onChange:e.onChange})}function ri({onChange:e,value:t,templating:n}){let[o,i]=(0,de.useState)(Object.entries(t??{}));return(0,de.useEffect)(()=>{let r=Object.fromEntries(o.filter(([a,s])=>a.trim()!==""||s.trim()!==""));e?.(r)},[o]),(0,p.jsxs)("div",{className:"space-y-2",children:[o.map(([r,a],s)=>(0,p.jsxs)("div",{className:"flex items-center gap-2",children:[(0,p.jsx)(fe,{value:r,className:"flex-1 min-w-60",onChange:u=>{let l=[...o];l[s]=[u,l[s][1]],i(l)},placeholder:"Key"}),(0,p.jsx)(po,{className:"overflow-hidden flex-2",value:a,language:"hogTemplate",onChange:u=>{let l=[...o];l[s]=[l[s][0],u??""],i(l)},templating:n}),(0,p.jsx)(F,{icon:(0,p.jsx)(Oe,{}),size:"small",onClick:()=>{let u=[...o];u.splice(s,1),i(u)}})]},s)),(0,p.jsx)(F,{icon:(0,p.jsx)(Ce,{}),size:"small",type:"secondary",onClick:()=>{i([...o,["",""]])},children:"Add entry"})]})}function mo({value:e,onChange:t,schema:n,disabled:o}){let i=n.templating??!0;switch(n.type){case"string":return(0,p.jsx)(po,{language:"hogTemplate",value:e,onChange:o?()=>{}:t,className:"ph-no-capture",templating:i});case"json":return(0,p.jsx)(oi,{value:e,onChange:t,className:"ph-no-capture",templating:i});case"choice":return(0,p.jsx)(j,{fullWidth:!0,value:e,className:"ph-no-capture",onChange:t,options:n.choices??[],disabled:o});case"dictionary":return(0,p.jsx)(ri,{value:e,onChange:t,templating:i});case"boolean":return(0,p.jsx)(ce,{checked:e,onChange:r=>t?.(r),disabled:o});case"integration":return(0,p.jsx)(oo,{schema:n,value:e,onChange:t});case"integration_field":return(0,p.jsx)(uo,{schema:n,value:e,onChange:t});case"email":return(0,p.jsx)(ii,{schema:n});default:return(0,p.jsxs)("strong",{className:"text-danger",children:['Unknown field type "',(0,p.jsx)("code",{children:n.type}),'".']})}}function ai({value:e,onChange:t,onDone:n,supportsSecrets:o}){let i=l=>{if(l?.key?.length===0){u("Input variable name cannot be empty");return}t(l?{...e,...l}:null)},[r,a]=(0,de.useState)(e.key),[s,u]=(0,de.useState)(null);return(0,p.jsxs)("div",{className:"flex flex-col gap-2",children:[(0,p.jsxs)("div",{className:"flex flex-wrap items-center flex-1 gap-2",children:[(0,p.jsx)(j,{size:"small",options:ni.map(l=>({label:ne(l),value:l})),value:e.type,className:"w-30",onChange:l=>i({type:l})}),(0,p.jsx)(Lt,{size:"small",checked:e.required,onChange:l=>i({required:l}),label:"Required",bordered:!0}),o?(0,p.jsx)(Lt,{size:"small",checked:e.secret,onChange:l=>i({secret:l}),label:"Secret",bordered:!0}):null,(0,p.jsx)("div",{className:"flex-1"}),(0,p.jsx)(F,{status:"danger",icon:(0,p.jsx)(Kt,{}),size:"small",onClick:()=>t(null)}),(0,p.jsx)(F,{type:"secondary",size:"small",onClick:()=>n(),children:"Done"})]}),(0,p.jsxs)("div",{className:"flex flex-wrap flex-1 gap-2",children:[(0,p.jsx)(N.Pure,{label:"Display label",children:(0,p.jsx)(fe,{className:"min-w-60",size:"small",value:e.label,onChange:l=>i({label:l}),placeholder:"Display label"})}),(0,p.jsx)(N.Pure,{label:"Input variable name",error:s,children:(0,p.jsx)(fe,{size:"small",value:r,onChange:l=>a(l),onBlur:()=>i({key:r}),placeholder:"Variable name"})})]}),(0,p.jsx)(N.Pure,{label:"Description",children:(0,p.jsx)(Ze,{minRows:1,value:e.description,onChange:l=>i({description:l}),placeholder:"Description"})}),e.type==="choice"&&(0,p.jsx)(N.Pure,{label:"Choices",children:(0,p.jsx)(ue,{mode:"multiple",allowCustomValues:!0,value:e.choices?.map(l=>l.value),onChange:l=>i({choices:l.map(g=>({label:g,value:g}))}),placeholder:"Choices"})}),e.type==="integration"&&(0,p.jsx)(N.Pure,{label:"Integration kind",children:(0,p.jsx)(j,{value:e.integration,onChange:l=>i({integration:l}),options:[{label:"Slack",value:"slack"},{label:"Salesforce",value:"salesforce"},{label:"Hubspot",value:"hubspot"}],placeholder:"Choose kind"})}),(0,p.jsx)(N.Pure,{label:"Default value",children:(0,p.jsx)(mo,{schema:e,value:e.default,onChange:l=>i({default:l})})})]})}function si({schema:e,configuration:t,setConfigurationValue:n}){let{attributes:o,listeners:i,setNodeRef:r,transform:a,transition:s}=pn({id:e.key}),{showSource:u}=(0,xe.useValues)(I),[l,g]=(0,de.useState)(!1),C=t.inputs?.[e.key],f=w=>{let A=t.inputs_schema||[];if(!w)A=A.filter($=>$.key!==e.key);else{let $={...e,...w};A=A.map(X=>X.key===e.key?$:X)}w?.key&&n(`inputs.${w.key}`,C),w?.type&&w.type!==e.type&&n(`inputs.${e.key}`,null),n("inputs_schema",A)};(0,de.useEffect)(()=>{u||g(!1)},[u]);let L=["string","json","dictionary","email"].includes(e.type)&&e.templating!==!1,E="type"in t;return(0,p.jsx)("div",{className:"group",ref:r,style:{transform:rn.Transform.toString(a),transition:s},children:l?(0,p.jsx)("div",{className:"p-2 space-y-4 border border-dashed rounded",children:(0,p.jsx)(ai,{value:e,onChange:f,onDone:()=>g(!1),supportsSecrets:E})}):(0,p.jsx)(N,{name:`inputs.${e.key}`,help:e.description,children:({value:w,onChange:A})=>(0,p.jsxs)(p.Fragment,{children:[(0,p.jsxs)("div",{className:"flex items-center gap-2",children:[(0,p.jsxs)(D,{className:u?"cursor-grab":"",showOptional:!e.required,...o,...i,children:[e.label||e.key,e.secret?(0,p.jsx)(Te,{title:"This input is marked as secret. It will be encrypted and not visible after saving.",children:(0,p.jsx)(Xt,{})}):void 0]}),u&&(0,p.jsxs)(Ie,{type:"muted",className:"font-mono",children:["inputs.",e.key]}),(0,p.jsx)("div",{className:"flex-1"}),L&&(0,p.jsx)(F,{size:"xsmall",to:"https://posthog.com/docs/cdp/destinations/customizing-destinations#customizing-payload",sideIcon:(0,p.jsx)(Ke,{}),noPadding:!0,className:"p-1 transition-opacity opacity-0 group-hover:opacity-100",children:"Supports templating"}),u&&(0,p.jsx)(F,{size:"small",noPadding:!0,icon:(0,p.jsx)(Wt,{}),onClick:()=>g(!0)})]}),w?.secret?(0,p.jsxs)("div",{className:"flex items-center gap-2 p-1 border border-dashed rounded",children:[(0,p.jsx)("span",{className:"flex-1 p-1 italic text-secondary",children:"This value is secret and is not displayed here."}),(0,p.jsx)(F,{onClick:()=>{A({value:void 0})},size:"small",type:"secondary",children:"Edit"})]}):(0,p.jsx)(mo,{schema:e,value:w?.value,onChange:$=>A({value:$})})]})})})}function st({configuration:e,setConfigurationValue:t}){let{showSource:n}=(0,xe.useValues)(I);if(!e?.inputs_schema?.length)return"type"in e?(0,p.jsx)("span",{className:"italic text-secondary",children:"This function does not require any input variables."}):null;let o=e.inputs_schema,i=o.map(r=>r.key);return(0,p.jsx)(p.Fragment,{children:(0,p.jsx)(sn,{collisionDetection:an,onDragEnd:({active:r,over:a})=>{if(a&&r.id!==a.id){let s=i.indexOf(r.id),u=i.indexOf(a.id);t("inputs_schema",ln(o,s,u))}},children:(0,p.jsx)(un,{disabled:!n,items:i,strategy:cn,children:e.inputs_schema?.filter(r=>!r.hidden).map(r=>(0,p.jsx)(si,{schema:r,configuration:e,setConfigurationValue:t},r.key))})})})}y();b();h();var fo=m(Ut()),qe=m(O()),yo=m(Le());var ct=m(Fe());y();b();h();var R=m(O()),go=m(Le());var li=e=>{let t=e.properties??{};return t.$ip=t.$ip??"89.160.20.129",delete t.$transformations_failed,delete t.$transformations_succeeded,{event:e.event,uuid:e.uuid,distinct_id:e.distinct_id,timestamp:e.timestamp,properties:t}},ci=e=>(delete e.properties.$transformations_failed,delete e.properties.$transformations_succeeded,{event:e.event,uuid:e.uuid,distinct_id:e.distinct_id,timestamp:e.timestamp,properties:e.properties}),lt=(0,R.kea)([(0,R.props)({}),(0,R.key)(({id:e,templateId:t})=>e??t??"new"),(0,R.path)(e=>["scenes","pipeline","hogfunctions","hogFunctionTestLogic",e]),(0,R.connect)(e=>({values:[I(e),["configuration","templateId","configurationHasErrors","sampleGlobals","sampleGlobalsLoading","exampleInvocationGlobals","sampleGlobalsError","type"],pe,["groupTypes"]],actions:[I(e),["touchConfigurationField","loadSampleGlobalsSuccess","loadSampleGlobals","setSampleGlobals"]]})),(0,R.actions)({setTestResult:e=>({result:e}),toggleExpanded:e=>({expanded:e}),saveGlobals:(e,t)=>({name:e,globals:t}),deleteSavedGlobals:e=>({index:e}),setTestResultMode:e=>({mode:e}),receiveExampleGlobals:e=>({globals:e}),setJsonError:e=>({error:e}),validateJson:(e,t,n)=>({value:e,editor:t,decorations:n}),setDecorationIds:e=>({decorationIds:e}),cancelSampleGlobalsLoading:!0}),(0,R.reducers)({expanded:[!1,{toggleExpanded:(e,{expanded:t})=>t===void 0?!e:t}],testResult:[null,{setTestResult:(e,{result:t})=>t}],testResultMode:["diff",{setTestResultMode:(e,{mode:t})=>t}],savedGlobals:[[],{persist:!0,prefix:`${jt()}__`},{saveGlobals:(e,{name:t,globals:n})=>[...e,{name:t,globals:n}],deleteSavedGlobals:(e,{index:t})=>e.filter((n,o)=>o!==t)}],jsonError:[null,{setJsonError:(e,{error:t})=>t}],currentDecorationIds:[[],{setDecorationIds:(e,{decorationIds:t})=>t,setJsonError:()=>[]}],fetchCancelled:[!1,{loadSampleGlobals:()=>!1,cancelSampleGlobalsLoading:()=>!0,toggleExpanded:()=>!1}]}),(0,R.listeners)(({values:e,actions:t})=>({loadSampleGlobalsSuccess:()=>{e.expanded&&!e.fetchCancelled&&e.sampleGlobals&&t.receiveExampleGlobals(e.sampleGlobals)},setSampleGlobals:({sampleGlobals:n})=>{t.receiveExampleGlobals(n)},receiveExampleGlobals:({globals:n})=>{if(n)if(e.type==="transformation"){let o=li(n.event);t.setTestInvocationValue("globals",JSON.stringify(o,null,2))}else t.setTestInvocationValue("globals",JSON.stringify(n,null,2))},validateJson:({value:n,editor:o,decorations:i})=>{if(!o?.getModel())return;let r=o.getModel();try{JSON.parse(n),t.setJsonError(null),o.removeDecorations(i)}catch(a){t.setJsonError(a.message);let s=a.message.match(/position (\d+)/);if(!s)return;let u=parseInt(s[1],10),l=r.getPositionAt(u);o.createDecorationsCollection([{range:{startLineNumber:l.lineNumber,startColumn:l.column,endLineNumber:l.lineNumber,endColumn:l.column+1},options:{isWholeLine:!0,className:"bg-danger-highlight",glyphMarginClassName:"text-danger flex items-center justify-center",glyphMarginHoverMessage:{value:a.message}}}]),o.revealLineInCenter(l.lineNumber)}},setTestResult:({result:n})=>{n&&setTimeout(()=>{let o=document.querySelector('[data-attr="test-results"]');o&&o.scrollIntoView({behavior:"smooth",block:"start"});let i=document.querySelectorAll('[data-attr="test-results"] .monaco-editor');if(i.length>0&&e.sortedTestsResult?.hasDiff){let a=i[i.length-1].querySelector(".monaco-scrollable-element");if(a){let s=e.sortedTestsResult.input.split(`
`),u=e.sortedTestsResult.output.split(`
`),l=0;for(let C=0;C<Math.max(s.length,u.length);C++)if(s[C]!==u[C]){l=C;break}let g=19;a.scrollTop=Math.max(0,(l-2)*g)}}},100)},cancelSampleGlobalsLoading:()=>{}})),(0,go.forms)(({props:e,actions:t,values:n})=>({testInvocation:{defaults:{mock_async_functions:!1},alwaysShowErrors:!0,errors:({globals:o})=>({globals:o?Ft(o)?void 0:"Invalid JSON":"Required"}),submit:async o=>{if(n.configurationHasErrors){ge.error("Please fix the configuration errors before testing.");return}let i=Ft(o.globals),r=Nt(n.configuration);r.template_id=n.templateId;let a=n.type==="transformation"?{event:i}:i;try{let s=await W.hogFunctions.createTestInvocation(e.id??"new",{globals:a,mock_async_functions:o.mock_async_functions,configuration:r});n.type==="transformation"&&s.result&&(s.result=ci(s.result)),t.setTestResult(s)}catch(s){ge.error(`An unexpected server error occurred while testing the function. ${s}`)}}}})),(0,R.selectors)(()=>({sortedTestsResult:[e=>[e.configuration,e.testResult,e.testInvocation],(e,t,n)=>{if(!t||e.type!=="transformation")return null;let o=JSON.stringify(JSON.parse(n.globals),null,2),i=JSON.stringify(t.result,null,2);return{input:o,output:i,hasDiff:o!==i}}]})),(0,R.afterMount)(({actions:e,values:t})=>{e.receiveExampleGlobals(t.exampleInvocationGlobals)})]);var d=m(x()),ui=({value:e,onChange:t,readOnly:n=!1})=>{let o=(0,ct.useRef)(null),i=(0,ct.useRef)([]),r=a=>{if(!o.current?.getModel())return;let s=o.current.getModel();Ct.setModelMarkers(s,"owner",[]),i.current=o.current.deltaDecorations(i.current,[]);try{JSON.parse(a)}catch(u){let l=u.message.match(/position (\d+)/);if(l){let g=parseInt(l[1],10),C=s.getPositionAt(g);Ct.setModelMarkers(s,"owner",[{startLineNumber:C.lineNumber,startColumn:C.column,endLineNumber:C.lineNumber,endColumn:C.column+1,message:u.message,severity:fn.Error}]),i.current=o.current.deltaDecorations(i.current,[{range:{startLineNumber:C.lineNumber,startColumn:1,endLineNumber:C.lineNumber,endColumn:s.getLineLength(C.lineNumber)+1},options:{isWholeLine:!0,className:"bg-danger-highlight",glyphMarginClassName:"text-danger flex items-center justify-center",glyphMarginHoverMessage:{value:u.message}}}]),o.current.revealLineInCenter(C.lineNumber)}}};return(0,d.jsx)(ye,{language:"json",value:e,height:400,onChange:a=>{n||(t?.(a),r(a??""))},onMount:a=>{o.current=a,r(e)},options:{lineNumbers:"on",minimap:{enabled:!1},quickSuggestions:{other:!0,strings:!0},suggest:{showWords:!1,showFields:!1,showKeywords:!1},scrollbar:{vertical:"auto",verticalScrollbarSize:14},folding:!0,glyphMargin:!0,readOnly:n}})};function ho(){let{logicProps:e}=(0,qe.useValues)(I),{isTestInvocationSubmitting:t,testResult:n,expanded:o,sampleGlobalsLoading:i,sampleGlobalsError:r,type:a,savedGlobals:s,testInvocation:u,testResultMode:l,sortedTestsResult:g,jsonError:C,fetchCancelled:f}=(0,qe.useValues)(lt(e)),{submitTestInvocation:L,setTestResult:E,toggleExpanded:w,loadSampleGlobals:A,deleteSavedGlobals:$,setSampleGlobals:X,saveGlobals:B,setTestResultMode:Ae,cancelSampleGlobalsLoading:se}=(0,qe.useActions)(lt(e)),le=(0,ct.useRef)(null);return(0,d.jsxs)(yo.Form,{logic:lt,props:e,formKey:"testInvocation",enableFormOnSubmit:!0,children:[(0,d.jsxs)("div",{ref:le,className:(0,fo.default)("border rounded p-3 space-y-2",o?"bg-surface-secondary min-h-120":"bg-surface-primary"),children:[(0,d.jsxs)("div",{className:"flex items-center justify-end gap-2",children:[(0,d.jsxs)("div",{className:"flex-1 space-y-2",children:[(0,d.jsxs)("h2",{className:"flex items-center gap-2 mb-0",children:[(0,d.jsx)("span",{children:"Testing"}),i&&!f?(0,d.jsx)(Tt,{}):null]}),!o&&(0,d.jsx)("p",{children:"Click here to test your function with an example event"})]}),o?(0,d.jsxs)(d.Fragment,{children:[n?(0,d.jsx)(F,{type:"primary",onClick:()=>E(null),loading:t,"data-attr":"clear-hog-test-result",children:"Clear test result"}):(0,d.jsxs)(d.Fragment,{children:[(0,d.jsx)(Ye,{dropdown:{closeOnClickInside:!1},overlay:(0,d.jsxs)(d.Fragment,{children:[(0,d.jsx)(N,{name:"mock_async_functions",children:({value:k,onChange:ee})=>(0,d.jsx)(ce,{onChange:te=>ee(!te),checked:!k,"data-attr":"toggle-hog-test-mocking",className:"px-2 py-1",label:(0,d.jsx)(Te,{title:(0,d.jsx)(d.Fragment,{children:"When disabled, async functions such as `fetch` will not be called. Instead they will be mocked out and logged."}),children:(0,d.jsxs)("span",{className:"flex gap-2",children:["Make real HTTP requests",(0,d.jsx)(Ke,{className:"text-lg"})]})})})}),(0,d.jsx)(Ee,{}),(0,d.jsx)(F,{fullWidth:!0,onClick:A,loading:i&&!f,tooltip:"Find the last event matching filters, and use it to populate the globals below.",children:"Fetch new event"}),(0,d.jsx)(Ee,{}),s.map(({name:k,globals:ee},te)=>(0,d.jsxs)("div",{className:"flex justify-between w-full",children:[(0,d.jsx)(F,{"data-attr":"open-hog-test-data",onClick:()=>X(ee),fullWidth:!0,className:"flex-1",children:k},te),(0,d.jsx)(F,{"data-attr":"delete-hog-test-data",size:"small",icon:(0,d.jsx)(Oe,{}),onClick:()=>$(te),tooltip:"Delete saved test data"})]},te)),u.globals&&(0,d.jsx)(F,{fullWidth:!0,"data-attr":"save-hog-test-data",onClick:()=>{let k=prompt("Name this test data");k&&B(k,JSON.parse(u.globals))},disabledReason:(()=>{try{JSON.parse(u.globals)}catch{return"Invalid globals JSON"}})(),children:"Save test data"})]})}),(0,d.jsx)(F,{type:"primary","data-attr":"test-hog-function",onClick:L,loading:t,children:"Test function"})]}),(0,d.jsx)(F,{"data-attr":"hide-hog-testing",icon:(0,d.jsx)(Oe,{}),onClick:()=>w(),tooltip:"Hide testing"})]}):(0,d.jsx)(F,{"data-attr":"expand-hog-testing",type:"secondary",onClick:()=>{w(),setTimeout(()=>{le.current?.scrollIntoView({behavior:"smooth",block:"start"})},100)},children:"Start testing"})]}),o&&(0,d.jsx)(d.Fragment,{children:n?(0,d.jsxs)("div",{className:"space-y-2","data-attr":"test-results",children:[(0,d.jsx)(V,{type:n.status==="success"?"success":"error",children:n.status==="success"?"Success":"Error"}),a==="transformation"&&n.status==="success"?(0,d.jsxs)(d.Fragment,{children:[(0,d.jsxs)("div",{className:"flex items-center justify-between gap-2",children:[(0,d.jsx)(D,{children:"Transformation result"}),g?.hasDiff&&(0,d.jsx)(tn,{size:"xsmall",options:[{value:"raw",label:"Output"},{value:"diff",label:"Diff"}],onChange:k=>Ae(k),value:l})]}),(0,d.jsx)("p",{children:"Below you can see the event after the transformation has been applied."}),n.result?(0,d.jsxs)(d.Fragment,{children:[!g?.hasDiff&&(0,d.jsx)(V,{type:"info",children:"The event was unmodified by the transformation."}),(0,d.jsx)(ye,{language:"json",originalValue:g?.hasDiff&&l==="diff"?g?.input:void 0,value:g?.output,height:400,options:{readOnly:!0,lineNumbers:"off",minimap:{enabled:!1},quickSuggestions:{other:!0,strings:!0},suggest:{showWords:!1,showFields:!1,showKeywords:!1},scrollbar:{vertical:"hidden",verticalScrollbarSize:0},folding:!0}})]}):(0,d.jsx)(V,{type:"warning",children:"The event was dropped by the transformation. If this is expected then great news! If not, you should double check the configuration."})]}):null,(0,d.jsx)(D,{children:"Test invocation logs"}),(0,d.jsx)(on,{dataSource:n.logs??[],columns:[{title:"Timestamp",key:"timestamp",dataIndex:"timestamp",render:k=>(0,d.jsx)(yn,{time:k}),width:0},{width:100,title:"Level",key:"level",dataIndex:"level"},{title:"Message",key:"message",dataIndex:"message",render:k=>(0,d.jsx)("code",{className:"whitespace-pre-wrap",children:k})}],className:"ph-no-capture",rowKey:"timestamp",pagination:{pageSize:200,hideOnSinglePage:!0}})]}):(0,d.jsx)("div",{className:"space-y-2",children:(0,d.jsx)(N,{name:"globals",children:({value:k,onChange:ee})=>(0,d.jsxs)(d.Fragment,{children:[(0,d.jsxs)("div",{className:"space-y-2",children:[(0,d.jsx)("div",{children:a==="broadcast"?"The test broadcast will be sent with this sample data:":a==="email"?"The provider will be tested with this sample data:":"Here are all the global variables you can use in your code:"}),i&&!f&&(0,d.jsxs)("div",{className:"flex items-center gap-2 text-muted",children:[(0,d.jsx)(Tt,{}),(0,d.jsx)("span",{children:"Fetching new event..."}),(0,d.jsx)(F,{size:"small",type:"secondary",onClick:()=>se(),children:"Cancel"})]}),r?(0,d.jsx)("div",{className:"text-warning",children:r}):null]}),(0,d.jsx)(ui,{value:k,onChange:ee,readOnly:i})]})})})})]}),C&&(0,d.jsxs)(V,{type:"error",children:["JSON Error: ",C]})]})}y();b();h();var ut=m(O()),vo=m(Le());var _e=m(Fe());var v=m(x()),bo=e=>e.toLowerCase().replace(/_/g," ").replace(/-/g," ").replace(/\b\w/g,t=>t.toUpperCase()),pi=(0,_e.memo)(function({mapping:t}){let n=t.filters?.events?.map(u=>u.name??u.id)??[],o=t.filters?.actions?.map(u=>u.name??u.id)??[],i=(t.filters?.events?.filter(u=>u.properties?.length??0)??[]).length+(t.filters?.actions?.filter(u=>u.properties?.length??0)??[]).length,r=[...n,...o].join(", "),a=t.inputs_schema?.[0],s=(a?.key?t.inputs?.[a.key]?.value:null)??"(custom value)";return(0,v.jsxs)("span",{className:"flex items-center flex-1 gap-4",children:[(0,v.jsxs)("span",{children:[r?bo(r):(0,v.jsx)("span",{className:"text-secondary",children:"All events"})," ",i?(0,v.jsx)("span",{className:"text-secondary",children:(0,v.jsx)(Te,{title:`Events have ${i} additional filters`,children:(0,v.jsx)(zt,{})})}):null]}),(0,v.jsx)(Qt,{className:"text-secondary"}),(0,v.jsx)("span",{children:typeof s=="object"?JSON.stringify(s):bo(s)}),(0,v.jsx)("span",{className:"flex-1"}),t.disabled?(0,v.jsx)(Ie,{type:"danger",children:"Disabled"}):null]})});function di({index:e,mapping:t,onChange:n}){let{groupsTaxonomicTypes:o}=(0,ut.useValues)(pe),{showSource:i}=(0,ut.useValues)(I);return(0,v.jsx)(v.Fragment,{children:(0,v.jsxs)("div",{className:"p-3 pl-10 space-y-2",children:[t.disabled?(0,v.jsx)(V,{type:"warning",className:"p-2",action:{children:"Enable",onClick:()=>n({...t,disabled:!1})},children:"This mapping is disabled. It will not trigger the function."}):null,(0,v.jsx)(D,{children:"Match events and actions"}),(0,v.jsx)(tt,{filters:t.filters??{},setFilters:r=>n({...t,filters:r}),typeKey:"match-group",mathAvailability:3,hideRename:!0,hideDuplicate:!0,showNestedArrow:!1,actionsTaxonomicGroupTypes:["events","actions"],propertiesTaxonomicGroupTypes:["event_properties","event_feature_flags","elements","person_properties","hogql_expression",...o],propertyFiltersPopover:!0,addFilterDefaultOptions:{id:"$pageview",name:"$pageview",type:"events"},buttonProps:{type:"secondary"},buttonCopy:"Add event matcher"}),(0,v.jsx)(vo.Group,{name:["mappings",e],children:(0,v.jsx)(st,{configuration:t,setConfigurationValue:(r,a)=>{n({...t,[r]:a})}})}),i?(0,v.jsx)(F,{icon:(0,v.jsx)(Ce,{}),size:"small",type:"secondary",className:"my-4",onClick:()=>{n({...t,inputs_schema:[...t.inputs_schema??[],{type:"string",key:`var_${(t.inputs_schema?.length??0)+1}`,label:"",required:!1}]})},children:"Add input variable"}):null]})})}function Fo(){let{useMapping:e,mappingTemplates:t,configuration:n}=(0,ut.useValues)(I),[o,i]=(0,_e.useState)([]);return(0,_e.useEffect)(()=>{n.mappings?.length===1&&i([0])},[n.mappings?.length]),e?(0,v.jsx)(N,{name:"mappings",children:({value:r,onChange:a})=>{let s=f=>{let L=t.find(E=>E.name===f);if(L){let{name:E,...w}=L,A=w.inputs_schema?Object.fromEntries(w.inputs_schema.filter($=>$.default!==void 0).map($=>[$.key,{value:structuredClone($.default)}])):{};a([...r,{...w,name:E,inputs:A}]),i([...o,r.length])}},u=f=>{let L=r.findIndex(E=>E===f);if(L!==-1){let E=[...r];E.splice(L+1,0,f),a(E),i([L+1])}},l=f=>{let L=r.findIndex(E=>E===f);L!==-1&&(a(r.filter((E,w)=>w!==L)),i(o.filter(E=>E!==L)))},g=f=>{let L=r.findIndex(E=>E===f);L!==-1&&a(r.map((E,w)=>w===L?{...E,disabled:!E.disabled}:E))},C=t.length?(0,v.jsx)(j,{placeholder:"Add mapping",onChange:f=>{s(f)},options:t.map(f=>({label:f.name,value:f.name}))}):null;return(0,v.jsxs)("div",{className:"p-3 border rounded bg-surface-primary",children:[(0,v.jsxs)("div",{className:"flex items-start justify-between",children:[(0,v.jsxs)("div",{className:"flex-1",children:[(0,v.jsx)(D,{children:"Mappings"}),(0,v.jsx)("p",{className:"text-sm text-secondary",children:"Configure which events should act as triggers including filters and custom transformations"})]}),C]}),(0,v.jsx)("div",{className:"space-y-2",children:r.length?(0,v.jsx)("div",{className:"-mx-3 border-t border-b",children:(0,v.jsx)(Zt,{multiple:!0,embedded:!0,activeKeys:o,onChange:f=>i(f),panels:r.map((f,L)=>({key:L,header:{children:(0,v.jsx)(pi,{mapping:f}),sideAction:{icon:(0,v.jsx)(qt,{}),dropdown:{overlay:(0,v.jsxs)("div",{className:"space-y-px",children:[(0,v.jsx)(F,{onClick:()=>g(f),children:f.disabled?"Enable":"Disable"}),(0,v.jsx)(F,{onClick:()=>u(f),children:"Duplicate"}),(0,v.jsx)(F,{status:"danger",onClick:()=>l(f),children:"Remove"})]})}}},className:"p-0 bg-accent-light",content:(0,v.jsx)(di,{index:L,mapping:f,onChange:E=>{a(E?r.map((w,A)=>A===L?E:w):r.filter((w,A)=>A!==L))}},L)}))})}):(0,v.jsx)(V,{type:"warning",className:"p-2",children:"You have no mappings configured which effectively means the function is disabled as there is nothing to trigger it."})})]})}}):null}y();b();h();var pt=m(O());var _=m(x()),mi=8e3;function To(){let{sparkline:e,sparklineLoading:t,eventsDataTableNode:n,showEventsList:o}=(0,pt.useValues)(I),{setShowEventsList:i}=(0,pt.useActions)(I);if(!n)return null;let r={...n,full:!0},a=z.insightNew({type:"SQL",query:r}),s={type:"doc",content:[{type:"ph-query",attrs:{query:r}}]},u=z.canvas()+"#\u{1F994}="+btoa(JSON.stringify(s));return(0,_.jsxs)("div",{className:"relative p-3 space-y-2 border rounded bg-surface-primary",children:[(0,_.jsx)(D,{children:"Matching events"}),e&&!t?(0,_.jsxs)(_.Fragment,{children:[e.count>mi?(0,_.jsxs)(V,{type:"warning",children:[(0,_.jsx)("b",{children:"Warning:"})," This destination would have triggered"," ",(0,_.jsxs)("strong",{children:[e.count??0," time",e.count!==1?"s":""]})," ","in the last 7 days. Consider the impact of this function on your destination."]}):(0,_.jsxs)("p",{children:["This destination would have triggered"," ",(0,_.jsxs)("strong",{children:[e.count??0," time",e.count!==1?"s":""]})," ","in the last 7 days."]}),(0,_.jsx)(kn,{type:"bar",className:"w-full h-20",data:e.data,labels:e.labels})]}):t?(0,_.jsx)("div",{className:"min-h-20",children:(0,_.jsx)(Be,{})}):(0,_.jsx)("p",{children:"The expected volume could not be calculated"}),(0,_.jsxs)("div",{className:"flex flex-col gap-2 pt-2 border-t border-dashed",children:[(0,_.jsx)(F,{onClick:()=>i(!o),fullWidth:!0,center:!0,children:o?"Hide matching events":"Show matching events"}),o?(0,_.jsxs)(_.Fragment,{children:[(0,_.jsx)("div",{className:"flex items-start justify-end",children:(0,_.jsx)(j,{placeholder:"Open in...",onChange:l=>{l==="insight"?window.open(a,"_blank"):l==="canvas"&&window.open(u,"_blank")},options:[{label:"New insight",value:"insight"},{label:"New canvas",value:"canvas"}]})}),(0,_.jsx)("div",{className:"flex flex-col flex-1 overflow-y-auto border rounded max-h-200",children:n&&(0,_.jsx)(Sn,{query:{...n,full:!1,showEventFilter:!1,showPropertyFilter:!1,embedded:!0,showOpenEditorButton:!1,showHogQLEditor:!1,showTimings:!1}})})]}):null]})]})}var c=m(x());function ic({templateId:e,id:t,logicKey:n,displayOptions:o={}}){let i={templateId:e,id:t,logicKey:n},r=I(i),{isConfigurationSubmitting:a,configurationChanged:s,showSource:u,configuration:l,loading:g,loaded:C,hogFunction:f,willReEnableOnSave:L,willChangeEnabledOnSave:E,globalsWithInputs:w,showPaygate:A,hasAddon:$,personsCount:X,personsCountLoading:B,personsListQuery:Ae,template:se,templateHasChanged:le,type:k,usesGroups:ee,hasGroupsAddon:te}=(0,Pe.useValues)(r),{submitConfiguration:ze,resetForm:K,setShowSource:me,duplicate:He,resetToTemplate:mt,duplicateFromTemplate:gt,setConfigurationValue:Me,deleteHogFunction:ft}=(0,Pe.useActions)(r),Eo=bn("HOG_TRANSFORMATIONS_CUSTOM_HOG_ENABLED");if(g&&!C)return(0,c.jsx)(Be,{});if(!C)return(0,c.jsx)(Ln,{object:"Hog function"});let yt=(se?.id||f?.template?.id)?.startsWith("plugin-"),Io=(0,c.jsx)(c.Fragment,{children:!e&&(0,c.jsxs)(c.Fragment,{children:[(0,c.jsx)(Ye,{overlay:(0,c.jsxs)(c.Fragment,{children:[!yt&&(0,c.jsx)(F,{fullWidth:!0,onClick:()=>He(),children:"Duplicate"}),(0,c.jsx)(Ee,{}),(0,c.jsx)(F,{status:"danger",fullWidth:!0,onClick:()=>ft(),children:"Delete"})]})}),(0,c.jsx)(Ee,{vertical:!0})]})}),Mt=(0,c.jsxs)(c.Fragment,{children:[s?(0,c.jsx)(F,{type:"secondary",htmlType:"reset",onClick:()=>K(),disabledReason:s?a?"Saving in progress\u2026":void 0:"No changes",children:"Clear changes"}):null,(0,c.jsxs)(F,{type:"primary",htmlType:"submit",onClick:ze,loading:a,children:[e?"Create":"Save",L?" & re-enable":E?` & ${l.enabled?"enable":"disable"}`:""]})]});if(A)return(0,c.jsx)(Fn,{feature:"data_pipelines"});let Gt=o.embedded??!1,ko=!(o.hidePageHeader??!1),So=!(o.hideOverview??!1),Rt=o.showFilters??["destination","internal_destination","site_destination","broadcast"].includes(k),Ot=o.showExpectedVolume??["destination","site_destination"].includes(k),No=o.showStatus??["destination","internal_destination","email","transformation"].includes(k),wo=o.showEnabled??["destination","internal_destination","email","site_destination","site_app","transformation"].includes(k),Bt=o.canEditSource??(!yt&&(["destination","email","site_destination","site_app"].includes(k)||k==="transformation"&&Eo)),Dt=o.showPersonsCount??["broadcast"].includes(k),xo=o.showTesting??["destination","internal_destination","transformation","broadcast","email"].includes(k),_o=So||Ot||Dt||Rt;return(0,c.jsx)("div",{className:"space-y-3",children:(0,c.jsxs)(Pe.BindLogic,{logic:I,props:i,children:[ko&&(0,c.jsx)(In,{buttons:(0,c.jsxs)(c.Fragment,{children:[Io,Mt]})}),f?.filters?.bytecode_error?(0,c.jsx)("div",{children:(0,c.jsxs)(V,{type:"error",children:[(0,c.jsx)("b",{children:"Error saving filters:"})," ",f.filters.bytecode_error]})}):null,(0,c.jsx)(Lo.Form,{logic:I,props:i,formKey:"configuration",className:"space-y-3",children:(0,c.jsxs)("div",{className:"flex flex-wrap items-start gap-4",children:[_o&&(0,c.jsxs)("div",{className:"flex flex-col flex-1 gap-4 min-w-100",children:[(0,c.jsxs)("div",{className:(0,dt.default)("p-3 space-y-2 bg-surface-primary",!Gt&&"border rounded"),children:[(0,c.jsxs)("div",{className:"flex flex-row items-center gap-2 min-h-16",children:[(0,c.jsx)(N,{name:"icon_url",children:({value:ve,onChange:Ge})=>(0,c.jsx)(En,{logicKey:t??e??"new",src:ve,onChange:ht=>Ge(ht)})}),(0,c.jsxs)("div",{className:"flex flex-col items-start justify-start flex-1 py-1",children:[(0,c.jsx)("span",{className:"font-semibold",children:l.name}),se&&(0,c.jsx)(kt,{status:se.status})]}),No&&(0,c.jsx)(_n,{hogFunction:f}),wo&&(0,c.jsx)(N,{name:"enabled",children:({value:ve,onChange:Ge})=>(0,c.jsx)(ce,{label:"Enabled",onChange:()=>Ge(!ve),checked:ve,disabled:g,bordered:!0})})]}),(0,c.jsx)(N,{name:"name",label:"Name",children:(0,c.jsx)(fe,{type:"text",disabled:g})}),(0,c.jsx)(N,{name:"description",label:"Description",info:"Add a description to share context with other team members",children:(0,c.jsx)(Ze,{disabled:g})}),yt?null:f?.template&&!f.template.id.startsWith("template-blank-")?(0,c.jsx)(Yt,{showArrow:!0,overlay:(0,c.jsxs)("div",{className:"p-1 max-w-120",children:[(0,c.jsxs)("p",{children:["This function was built from the template"," ",(0,c.jsx)("b",{children:f.template.name}),". If the template is updated, this function is not affected unless you choose to update it."]}),(0,c.jsxs)("div",{className:"flex items-center flex-1 gap-2 pt-2 border-t",children:[(0,c.jsx)("div",{className:"flex-1",children:(0,c.jsx)(F,{children:"Close"})}),(0,c.jsx)(F,{type:"secondary",onClick:()=>gt(),children:"New function from template"}),le?(0,c.jsx)(F,{type:"primary",onClick:()=>mt(),children:"Update"}):null]})]}),children:(0,c.jsx)("div",{className:"text-xs border border-dashed rounded text-secondary",children:(0,c.jsxs)(We,{subtle:!0,className:"flex flex-wrap items-center gap-1 p-2",children:["Built from template:",(0,c.jsx)("span",{className:"font-semibold",children:f?.template.name}),(0,c.jsx)(kt,{status:f.template.status}),le?(0,c.jsx)(Ie,{type:"success",children:"Update available!"}):null]})})}):null]}),Rt&&(0,c.jsx)(jn,{}),Dt&&(0,c.jsxs)("div",{className:"relative p-3 space-y-2 border rounded bg-surface-primary",children:[(0,c.jsx)("div",{children:(0,c.jsx)(D,{children:"Matching persons"})}),X&&!B?(0,c.jsxs)(c.Fragment,{children:["Found"," ",(0,c.jsx)(We,{to:(0,Co.combineUrl)(z.activity(),{},{q:Ae}).url,children:(0,c.jsxs)("strong",{children:[X??0," ",X!==1?"people":"person"]})})," ","to send to."]}):B?(0,c.jsx)("div",{className:"min-h-20",children:(0,c.jsx)(Be,{})}):(0,c.jsx)("p",{children:"The expected volume could not be calculated"})]}),Ot?(0,c.jsx)(To,{}):null]}),(0,c.jsxs)("div",{className:"space-y-4 flex-2 min-w-100",children:[(0,c.jsx)("div",{className:(0,dt.default)("p-3 space-y-2 bg-surface-primary",!Gt&&"border rounded"),children:(0,c.jsxs)("div",{className:"space-y-2",children:[ee&&!te?(0,c.jsx)(V,{type:"warning",children:(0,c.jsxs)("span",{className:"flex items-center gap-2",children:["This function appears to use Groups but you do not have the Groups Analytics addon. Without it, you may see empty values where you use templates like ",'"{groups.kind.properties}"',(0,c.jsx)(vn,{feature:"group_analytics",type:"secondary"})]})}):null,(0,c.jsx)(st,{configuration:l,setConfigurationValue:Me}),u&&Bt?(0,c.jsx)(F,{icon:(0,c.jsx)(Ce,{}),size:"small",type:"secondary",className:"my-4",onClick:()=>{Me("inputs_schema",[...l.inputs_schema??[],{type:"string",key:`input_${(l.inputs_schema?.length??0)+1}`,label:"",required:!1}])},children:"Add input variable"}):null]})}),(0,c.jsx)(Fo,{}),Bt&&(0,c.jsxs)("div",{className:(0,dt.default)("border rounded p-3 space-y-2",u?"bg-surface-primary":"bg-surface-secondary"),children:[(0,c.jsxs)("div",{className:"flex items-center justify-end gap-2",children:[(0,c.jsxs)("div",{className:"flex-1 space-y-2",children:[(0,c.jsx)("h2",{className:"mb-0",children:"Edit source"}),u?null:(0,c.jsx)("p",{children:"Click here to edit the function's source code"})]}),u?(0,c.jsx)(F,{size:"xsmall",type:"secondary",onClick:()=>me(!1),children:"Hide source code"}):(0,c.jsx)(F,{type:"secondary",onClick:()=>me(!0),disabledReason:$?void 0:"Editing the source code requires the Data Pipelines addon",children:"Edit source code"})]}),u?(0,c.jsx)(N,{name:"hog",children:({value:ve,onChange:Ge})=>(0,c.jsxs)(c.Fragment,{children:[k.startsWith("site_")?null:(0,c.jsxs)("span",{className:"text-xs text-secondary",children:["This is the underlying Hog code that will run whenever the filters match."," ",(0,c.jsx)(We,{to:"https://posthog.com/docs/hog",children:"See the docs"})," ","for more info"]}),(0,c.jsx)(ye,{language:k.startsWith("site_")?"typescript":"hog",value:ve??"",onChange:ht=>Ge(ht??""),globals:w,options:{minimap:{enabled:!1},wordWrap:"on",scrollBeyondLastLine:!1,automaticLayout:!0,fixedOverflowWidgets:!0,suggest:{showInlineDetails:!0},quickSuggestionsDelay:300}})]})}):null]}),xo?(0,c.jsx)(ho,{}):null,(0,c.jsx)("div",{className:"flex justify-end gap-2",children:Mt})]})]})})]})})}export{Ci as a,Gn as b,ic as c};
//# sourceMappingURL=/static/chunk-4ZWY3YW2.js.map
