import{a as I,b as oe,c as ce,d as ue,e as de}from"/static/chunk-YDCIUJDU.js";import{a as V}from"/static/chunk-KYJ4OXJI.js";import{a as se}from"/static/chunk-KYV72GAC.js";import{j as L}from"/static/chunk-YDKHEMDP.js";import"/static/chunk-7SO55T25.js";import"/static/chunk-KBNOIM2W.js";import"/static/chunk-BB32DDTD.js";import"/static/chunk-QB3AUFV2.js";import"/static/chunk-PWG7LMNW.js";import"/static/chunk-CEZSENEJ.js";import"/static/chunk-GOBPXP3Z.js";import{Ae as J,Cg as re,Ei as te,Io as E,Ip as ae,Ko as Q,Ne as Z,Nk as N,Qd as K,Sd as W,Vd as q,Wd as w,Xh as S,Za as be,a as D,de as X,ef as ee,em as A,f as ve,fe as G,ie as $,je as P,ji as F,m as H,pl as B,ql as ne,r as b,rl as ie,tb as M}from"/static/chunk-TW5IU73S.js";import"/static/chunk-XPJ4MQJV.js";import"/static/chunk-KQJ3FYBQ.js";import{B as v,F as j,a as ge,na as U}from"/static/chunk-3UDJFOQH.js";import"/static/chunk-HHT4SG7V.js";import"/static/chunk-K7LQKAJG.js";import"/static/chunk-QQTK3LZH.js";import"/static/chunk-IJQNM355.js";import"/static/chunk-4CN6THWS.js";import"/static/chunk-272RTCFX.js";import"/static/chunk-2ROB4QWU.js";import"/static/chunk-ALT2ZZSO.js";import"/static/chunk-UE6SLBBN.js";import"/static/chunk-GINZUAUY.js";import"/static/chunk-SQELCOUW.js";import"/static/chunk-IGYUTZ65.js";import"/static/chunk-YM6UBNGD.js";import"/static/chunk-C6TQ5FFZ.js";import"/static/chunk-GXGA523B.js";import"/static/chunk-N4MMWRNK.js";import"/static/chunk-NRLAI7OY.js";import"/static/chunk-LVVHNICT.js";import"/static/chunk-2AXSSSSX.js";import"/static/chunk-DGXQI7RB.js";import"/static/chunk-HUCRWDLX.js";import"/static/chunk-RFEQG3YN.js";import"/static/chunk-PUISI233.js";import{d as l,e as p,g as y,j as f}from"/static/chunk-SJXEOBQC.js";p();f();y();var _=l(D());p();f();y();var k=l(D());p();f();y();var u=l(D()),me=l(be()),x=l(ve());var le={name:"",description:"",query:void 0,tags:[]},m=(0,u.kea)([(0,u.props)({}),(0,u.path)(r=>["scenes","experiments","sharedMetricLogic",r]),(0,u.key)(r=>r.sharedMetricId||"new"),(0,u.connect)(()=>({actions:[se,["loadSharedMetrics"],ae,["reportExperimentSharedMetricCreated"]],values:[H,["featureFlags"]]})),(0,u.actions)({setSharedMetric:r=>({metric:r}),createSharedMetric:!0,updateSharedMetric:!0,deleteSharedMetric:!0}),(0,me.loaders)(({props:r,values:t})=>({sharedMetric:{loadSharedMetric:async()=>r.sharedMetricId&&r.sharedMetricId!=="new"?await E.get(`api/projects/@current/experiment_saved_metrics/${r.sharedMetricId}`):{...t.newSharedMetric}}})),(0,u.listeners)(({actions:r,values:t})=>({createSharedMetric:async()=>{let o=await E.create("api/projects/@current/experiment_saved_metrics/",t.sharedMetric);o.id&&(q.success("Shared metric created successfully"),r.reportExperimentSharedMetricCreated(o),r.loadSharedMetrics(),x.router.actions.push("/experiments/shared-metrics"))},updateSharedMetric:async()=>{(await E.update(`api/projects/@current/experiment_saved_metrics/${t.sharedMetricId}`,t.sharedMetric)).id&&(q.success("Shared metric updated successfully"),r.loadSharedMetrics(),x.router.actions.push("/experiments/shared-metrics"))},deleteSharedMetric:async()=>{try{await E.delete(`api/projects/@current/experiment_saved_metrics/${t.sharedMetricId}`),q.success("Shared metric deleted successfully"),r.loadSharedMetrics(),x.router.actions.push("/experiments/shared-metrics")}catch(o){q.error("Failed to delete shared metric"),console.error(o)}}})),(0,u.reducers)({sharedMetric:[{...le},{setSharedMetric:(r,{metric:t})=>({...r,...t})}]}),(0,u.selectors)({sharedMetricId:[()=>[(r,t)=>t.sharedMetricId??"new"],r=>r],isNew:[r=>[r.sharedMetricId],r=>r==="new"],newSharedMetric:[r=>[r.featureFlags],r=>({...le,query:r[j.EXPERIMENTS_NEW_QUERY_RUNNER]?ie():B()})]}),(0,x.urlToAction)(({actions:r,values:t})=>({"/experiments/shared-metrics/:id":({id:o},h,g,s,e)=>{let a=s.initial||s.pathname!==e?.pathname;if(o&&a){let c=o==="new"?"new":parseInt(o);c==="new"&&r.setSharedMetric({...t.newSharedMetric}),c!=="new"&&c===t.sharedMetricId&&r.loadSharedMetric()}}}))]);var d=l(b());function ye(){let{sharedMetric:r}=(0,k.useValues)(m),{setSharedMetric:t}=(0,k.useActions)(m),{currentTeam:o}=(0,k.useValues)(Q),h=(o?.test_account_filters||[]).length>0,g={...I,actionsTaxonomicGroupTypes:["events","actions"]};if(!r?.query)return(0,d.jsx)(d.Fragment,{});let s=r.query;return(0,d.jsxs)(d.Fragment,{children:[(0,d.jsx)(F,{bordered:!0,filters:S(s.funnels_query),setFilters:({actions:e,events:a,data_warehouse:c})=>{if(!r?.query)return;let T=A({actions:e,events:a,data_warehouse:c},!0,3);t({query:{...s,funnels_query:{...s.funnels_query,series:T}}})},typeKey:"experiment-metric",mathAvailability:3,buttonCopy:"Add funnel step",showSeriesIndicator:!0,seriesIndicatorType:"numeric",sortable:!0,showNestedArrow:!0,...g}),(0,d.jsxs)("div",{className:"mt-4 space-y-4",children:[(0,d.jsx)(oe,{value:te(s.funnels_query.aggregation_group_type_index??void 0,s.funnels_query.funnelsFilter?.funnelAggregateByHogQL??void 0),onChange:e=>{t({query:{...s,funnels_query:{...s.funnels_query,funnelsFilter:{...s.funnels_query.funnelsFilter,funnelAggregateByHogQL:e}}}})}}),(0,d.jsx)(ce,{funnelWindowInterval:s.funnels_query?.funnelsFilter?.funnelWindowInterval,funnelWindowIntervalUnit:s.funnels_query?.funnelsFilter?.funnelWindowIntervalUnit,onFunnelWindowIntervalChange:e=>{t({query:{...s,funnels_query:{...s.funnels_query,funnelsFilter:{...s.funnels_query.funnelsFilter,funnelWindowInterval:e}}}})},onFunnelWindowIntervalUnitChange:e=>{t({query:{...s,funnels_query:{...s.funnels_query,funnelsFilter:{...s.funnels_query.funnelsFilter,funnelWindowIntervalUnit:e||void 0}}}})}}),(0,d.jsx)(ue,{value:(()=>{let e=s.funnels_query?.funnelsFilter?.breakdownAttributionType,a=s.funnels_query?.funnelsFilter?.breakdownAttributionValue;return e?e==="step"?`${e}/${a||0}`:e:"first_touch"})(),onChange:e=>{let[a,c]=(e||"").split("/");t({query:{...s,funnels_query:{...s.funnels_query,funnelsFilter:{...s.funnels_query.funnelsFilter,breakdownAttributionType:a,breakdownAttributionValue:c?parseInt(c):void 0}}}})},stepsLength:s.funnels_query?.series?.length}),(0,d.jsx)(N,{checked:(()=>{let e=s.funnels_query?.filterTestAccounts;return h?!!e:!1})(),onChange:e=>{t({query:{...s,funnels_query:{...s.funnels_query,filterTestAccounts:e}}})},fullWidth:!0})]}),(0,d.jsxs)(w,{type:"info",className:"mt-3 mb-3",children:["Preview insights are generated based on ",v," days of data. This can cause a mismatch between the preview and the actual results."]}),(0,d.jsx)("div",{className:"mt-4",children:(0,d.jsx)(L,{query:{kind:"InsightVizNode",source:s.funnels_query,showTable:!1,showLastComputation:!0,showLastComputationRefresh:!1},readOnly:!0})})]})}p();f();y();var C=l(D());var fe=l(ge());var n=l(b());function he(){let{sharedMetric:r}=(0,C.useValues)(m),{setSharedMetric:t}=(0,C.useActions)(m),{currentTeam:o}=(0,C.useValues)(Q),h=(o?.test_account_filters||[]).length>0,[g,s]=(0,fe.useState)("main");if(!r?.query)return(0,n.jsx)(n.Fragment,{});let e=r.query;return(0,n.jsx)(n.Fragment,{children:(0,n.jsx)(J,{activeKey:g,onChange:a=>s(a),tabs:[{key:"main",label:"Main metric",content:(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(F,{bordered:!0,filters:S(e.count_query),setFilters:({actions:a,events:c,data_warehouse:T})=>{let R=A({actions:a,events:c,data_warehouse:T},!0,0);t({query:{...e,count_query:{...e.count_query,series:R}}})},typeKey:"experiment-metric",buttonCopy:"Add graph series",showSeriesIndicator:!0,entitiesLimit:1,showNumericalPropsOnly:!0,allowedMathTypes:V,...I}),(0,n.jsx)("div",{className:"mt-4 space-y-4",children:(0,n.jsx)(N,{checked:(()=>{let a=e.count_query?.filterTestAccounts;return h?!!a:!1})(),onChange:a=>{t({query:{...e,count_query:{...e.count_query,filterTestAccounts:a}}})},fullWidth:!0})}),(0,n.jsxs)(w,{type:"info",className:"mt-3 mb-3",children:["Preview insights are generated based on ",v," days of data. This can cause a mismatch between the preview and the actual results."]}),(0,n.jsx)("div",{className:"mt-4",children:(0,n.jsx)(L,{query:{kind:"InsightVizNode",source:e.count_query,showTable:!1,showLastComputation:!0,showLastComputationRefresh:!1},readOnly:!0})})]})},{key:"exposure",label:"Exposure",content:(0,n.jsxs)(n.Fragment,{children:[(0,n.jsxs)("div",{className:"flex gap-4 mb-4",children:[(0,n.jsxs)("div",{className:`flex-1 cursor-pointer p-4 rounded border ${e.exposure_query?"border-border":"border-accent-primary bg-accent-primary-highlight"}`,onClick:()=>{t({query:{...e,exposure_query:void 0}})},children:[(0,n.jsxs)("div",{className:"font-semibold flex justify-between items-center",children:[(0,n.jsx)("span",{children:"Default"}),!e.exposure_query&&(0,n.jsx)(M,{fontSize:18,color:"var(--accent-primary)"})]}),(0,n.jsxs)("div",{className:"text-secondary text-sm leading-relaxed",children:["Uses the number of unique users who trigger the"," ",(0,n.jsx)(G,{children:"$feature_flag_called"})," event as your exposure count. This is the recommended setting for most experiments, as it accurately tracks variant exposure."]})]}),(0,n.jsxs)("div",{className:`flex-1 cursor-pointer p-4 rounded border ${e.exposure_query?"border-accent-primary bg-accent-primary-highlight":"border-border"}`,onClick:()=>{t({query:{...e,exposure_query:{kind:"TrendsQuery",series:[{kind:"EventsNode",name:"$feature_flag_called",event:"$feature_flag_called",math:"dau"}],interval:"day",dateRange:{date_from:(0,U.default)().subtract(v,"day").format("YYYY-MM-DDTHH:mm"),date_to:(0,U.default)().endOf("d").format("YYYY-MM-DDTHH:mm"),explicitDate:!0},trendsFilter:{display:"ActionsLineGraph"},filterTestAccounts:!0}}})},children:[(0,n.jsxs)("div",{className:"font-semibold flex justify-between items-center",children:[(0,n.jsx)("span",{children:"Custom"}),e.exposure_query&&(0,n.jsx)(M,{fontSize:18,color:"var(--accent-primary)"})]}),(0,n.jsx)("div",{className:"text-secondary text-sm leading-relaxed",children:"Define your own exposure metric for specific use cases, such as counting by sessions instead of users. This gives you full control but requires careful configuration."})]})]}),e.exposure_query&&(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(F,{bordered:!0,filters:S(e.exposure_query),setFilters:({actions:a,events:c,data_warehouse:T})=>{let R=A({actions:a,events:c,data_warehouse:T},!0,0);t({query:{...e,exposure_query:{...e.exposure_query,series:R}}})},typeKey:"experiment-metric",buttonCopy:"Add graph series",showSeriesIndicator:!0,entitiesLimit:1,showNumericalPropsOnly:!0,allowedMathTypes:V,...I}),(0,n.jsx)("div",{className:"mt-4 space-y-4",children:(0,n.jsx)(N,{checked:(()=>{let a=e.exposure_query?.filterTestAccounts;return h?!!a:!1})(),onChange:a=>{t({query:{...e,exposure_query:{...e.exposure_query,filterTestAccounts:a}}})},fullWidth:!0})}),(0,n.jsxs)(w,{type:"info",className:"mt-3 mb-3",children:["Preview insights are generated based on ",v," days of data. This can cause a mismatch between the preview and the actual results."]}),(0,n.jsx)("div",{className:"mt-4",children:(0,n.jsx)(L,{query:{kind:"InsightVizNode",source:e.exposure_query,showTable:!1,showLastComputation:!0,showLastComputationRefresh:!1},readOnly:!0})})]})]})}]})})}var i=l(b()),Ur={component:xe,logic:m,paramsToProps:({params:{id:r}})=>({sharedMetricId:r==="new"?"new":parseInt(r)})};function xe(){let{sharedMetricId:r,sharedMetric:t}=(0,_.useValues)(m),{setSharedMetric:o,createSharedMetric:h,updateSharedMetric:g,deleteSharedMetric:s}=(0,_.useActions)(m),{isDarkModeOn:e}=(0,_.useValues)(Z),{tags:a}=(0,_.useValues)(ee);return!t||!t.query?(0,i.jsx)("div",{className:"fixed inset-0 flex justify-center items-center",children:(0,i.jsx)(K,{className:"text-5xl"})}):(0,i.jsxs)("div",{className:"max-w-[800px]",children:[t.query.kind!=="ExperimentMetric"&&(0,i.jsxs)("div",{className:"flex gap-4 mb-4",children:[(0,i.jsxs)("div",{className:`flex-1 cursor-pointer p-4 rounded border ${t.query.kind==="ExperimentTrendsQuery"?"border-accent-primary bg-accent-primary-highlight":"border-border"}`,onClick:()=>{o({query:B()})},children:[(0,i.jsxs)("div",{className:"font-semibold flex justify-between items-center",children:[(0,i.jsx)("span",{children:"Trend"}),t.query.kind==="ExperimentTrendsQuery"&&(0,i.jsx)(M,{fontSize:18,color:"var(--accent-primary)"})]}),(0,i.jsx)("div",{className:"text-secondary text-sm leading-relaxed",children:"Track a single event, action or a property value."})]}),(0,i.jsxs)("div",{className:`flex-1 cursor-pointer p-4 rounded border ${t.query.kind==="ExperimentFunnelsQuery"?"border-accent-primary bg-accent-primary-highlight":"border-border"}`,onClick:()=>{o({query:ne()})},children:[(0,i.jsxs)("div",{className:"font-semibold flex justify-between items-center",children:[(0,i.jsx)("span",{children:"Funnel"}),t.query.kind==="ExperimentFunnelsQuery"&&(0,i.jsx)(M,{fontSize:18,color:"var(--accent-primary)"})]}),(0,i.jsx)("div",{className:"text-secondary text-sm leading-relaxed",children:"Analyze conversion rates between sequential steps."})]})]}),(0,i.jsxs)("div",{className:`border rounded ${e?"bg-light":"bg-white"} p-4`,children:[(0,i.jsxs)("div",{className:"mb-4",children:[(0,i.jsx)(P,{children:"Name"}),(0,i.jsx)($,{value:t.name,onChange:c=>{o({name:c})}})]}),(0,i.jsxs)("div",{className:"mb-4",children:[(0,i.jsx)(P,{children:"Description (optional)"}),(0,i.jsx)($,{value:t.description,onChange:c=>{o({description:c})}})]}),(0,i.jsxs)("div",{className:"mb-4",children:[(0,i.jsx)(P,{children:"Tags"}),(0,i.jsx)("div",{className:"mt-2",children:(0,i.jsx)(re,{tags:t.tags||[],onChange:c=>{o({tags:c})},saving:!1,tagsAvailable:a,"data-attr":"shared-metric-tags"})})]}),t.query.kind==="ExperimentMetric"?(0,i.jsx)(de,{metric:t.query,handleSetMetric:({newMetric:c})=>{o({...t,query:c})}}):t.query.kind==="ExperimentTrendsQuery"?(0,i.jsx)(he,{}):(0,i.jsx)(ye,{})]}),(0,i.jsxs)("div",{className:"flex justify-between mt-4",children:[r!=="new"&&(0,i.jsx)(W,{size:"medium",type:"primary",status:"danger",onClick:()=>{X.open({title:"Delete this metric?",content:(0,i.jsx)("div",{className:"text-sm text-secondary",children:"This action cannot be undone."}),primaryButton:{children:"Delete",type:"primary",onClick:()=>s(),size:"small"},secondaryButton:{children:"Cancel",type:"tertiary",size:"small"}})},children:"Delete"}),(0,i.jsx)(W,{className:"ml-auto",disabledReason:t.name?void 0:"You must give your metric a name",size:"medium",type:"primary",onClick:()=>{r==="new"?h():g()},children:"Save"})]})]})}export{xe as SharedMetric,Ur as scene};
//# sourceMappingURL=/static/SharedMetric-ICNR3NOO.js.map
