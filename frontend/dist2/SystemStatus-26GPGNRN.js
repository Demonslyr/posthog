import{a as S}from"/static/chunk-B6UVSOTB.js";import{$d as D,Ae as pe,Bd as ce,Do as ve,Eo as W,Gn as he,Io as j,Ol as be,Sa as ae,Sd as b,Ta as C,Wd as B,Yi as ye,Za as Be,a as M,ae as me,af as F,cc as ie,ce as H,ch as ge,ee as de,f as Me,fe as V,ga as Q,ie as ue,kc as re,na as O,r as y,td as le,ue as fe,vo as Se,ze as U}from"/static/chunk-TW5IU73S.js";import"/static/chunk-XPJ4MQJV.js";import{Tb as Y,a as se}from"/static/chunk-3UDJFOQH.js";import"/static/chunk-HHT4SG7V.js";import"/static/chunk-K7LQKAJG.js";import"/static/chunk-QQTK3LZH.js";import"/static/chunk-IJQNM355.js";import"/static/chunk-4CN6THWS.js";import"/static/chunk-272RTCFX.js";import"/static/chunk-2ROB4QWU.js";import"/static/chunk-ALT2ZZSO.js";import"/static/chunk-UE6SLBBN.js";import"/static/chunk-GINZUAUY.js";import"/static/chunk-SQELCOUW.js";import"/static/chunk-IGYUTZ65.js";import"/static/chunk-YM6UBNGD.js";import"/static/chunk-C6TQ5FFZ.js";import"/static/chunk-GXGA523B.js";import"/static/chunk-N4MMWRNK.js";import"/static/chunk-NRLAI7OY.js";import"/static/chunk-LVVHNICT.js";import"/static/chunk-2AXSSSSX.js";import"/static/chunk-DGXQI7RB.js";import"/static/chunk-HUCRWDLX.js";import"/static/chunk-RFEQG3YN.js";import"/static/chunk-PUISI233.js";import{d as c,e as f,g as p,j as g}from"/static/chunk-SJXEOBQC.js";f();g();p();var A=c(M());f();g();p();var q=c(M());var P=c(se());var m=c(y());function Le(){let{openSections:n,queries:t,queriesLoading:e}=(0,q.useValues)(S),{setOpenSections:o,loadQueries:l}=(0,q.useActions)(S),[d,u]=(0,P.useState)(!1),v=(0,P.useMemo)(()=>t?.postgres_running?.filter(({state:h})=>d||h!=="idle"),[d,t]),T=h=>{h.stopPropagation(),l()};return(0,m.jsx)(m.Fragment,{children:(0,m.jsx)(me,{activeKeys:n,className:"bg-surface-primary",onChange:h=>o(h),multiple:!0,panels:[{key:"1",header:"PostgreSQL - currently running queries",content:(0,m.jsxs)(m.Fragment,{children:[(0,m.jsxs)("div",{className:"flex mb-4 float-right space-x-2",children:[(0,m.jsx)(D,{checked:d,onChange:u,label:"Show idle queries"}),(0,m.jsx)(b,{type:"secondary",size:"small",icon:(0,m.jsx)(O,{}),onClick:T,children:"Reload Queries"})]}),(0,m.jsx)(te,{queries:v,loading:e})]})},t?.clickhouse_running!=null&&{key:"2",header:"Clickhouse - currently running queries",content:(0,m.jsxs)(m.Fragment,{children:[(0,m.jsx)("div",{className:"flex mb-4 float-right",children:(0,m.jsx)(b,{type:"secondary",size:"small",icon:(0,m.jsx)(O,{}),onClick:T,children:"Reload Queries"})}),(0,m.jsx)(te,{queries:t?.clickhouse_running,loading:e})]})},t?.clickhouse_slow_log!=null&&{key:"3",header:"Clickhouse - slow query log (past 6 hours)",content:(0,m.jsxs)(m.Fragment,{children:[(0,m.jsx)("div",{className:"flex mb-4 float-right",children:(0,m.jsx)(b,{type:"secondary",size:"small",icon:(0,m.jsx)(O,{}),onClick:T,children:"Reload Queries"})}),(0,m.jsx)(te,{queries:t?.clickhouse_slow_log,loading:e})]})}]})})}function te(n){let t=[{title:"duration",dataIndex:"duration",key:"duration",sorter:(e,o)=>+e.duration-+o.duration},{title:"query",dataIndex:"query",render:function(o,l){return l.query},key:"query"}];return n.queries&&n.queries.length>0&&Object.keys(n.queries[0]).forEach(e=>{e!=="duration"&&e!=="query"&&t.push({title:e,dataIndex:e,key:e})}),(0,m.jsx)(U,{dataSource:n.queries||[],columns:t,loading:n.loading,pagination:{pageSize:30,hideOnSinglePage:!0},size:"small",nouns:["query","queries"]})}f();g();p();var Ne=c(M());f();g();p();var _=c(y()),We=new Set(["last_event_ingested_timestamp"]);function J(n,{key:t,value:e,value_type:o,emptyNullLabel:l,isSecret:d}){return e&&d?(0,_.jsx)(V,{className:"uppercase text-secondary bg-mark",icon:d?(0,_.jsx)(re,{className:"text-warning"}):void 0,children:"Secret"}):t&&We.has(t)&&typeof e=="string"?new Date(e).getTime()===new Date("1970-01-01T00:00:00").getTime()?"Never":(0,_.jsx)(ge,{time:e}):o==="bool"||typeof e=="boolean"?(0,_.jsx)(V,{className:"uppercase",type:e?"success":"danger",children:e?"Yes":"No"}):e==null||e===""?(0,_.jsx)(V,{className:"uppercase text-secondary",children:l??"Unknown"}):o==="int"||typeof e=="number"?e.toLocaleString("en-US"):e.toString()}var x=c(y()),Ie={async_migrations_ok:"/instance/async_migrations"};function Je(n,t){return(0,x.jsxs)("span",{children:[t.metric," ",Ie[t.key]?(0,x.jsx)(C,{to:Ie[t.key],children:(0,x.jsx)(Q,{style:{verticalAlign:"middle"}})}):null]})}function Ve(){let{overview:n,systemStatusLoading:t}=(0,Ne.useValues)(S);return(0,x.jsx)(U,{className:"system-status-table",rowKey:"metric",dataSource:n,columns:[{title:"Metric",className:"metric-column",render:Je},{title:"Value",render:J}],loading:t,expandable:{expandedRowRender:function(o){return o.subrows?.rows.length?(0,x.jsx)(Ze,{...o.subrows}):null},rowExpandable:e=>!!e.subrows?.rows.length}})}function Ze(n){return(0,x.jsx)(U,{dataSource:n.rows,columns:n.columns.map((t,e)=>({title:t,dataIndex:e})),embedded:!0})}f();g();p();var G=c(M());var Ce=c(se());f();g();p();var K=c(M());var r=c(y());function _e({metricKey:n,oldValue:t,value:e,isSecret:o}){return e?.toString()===t?.toString()?null:(0,r.jsxs)("div",{className:"bg-border-light radius p-2",children:[(0,r.jsx)("div",{children:(0,r.jsx)("code",{children:n})}),(0,r.jsxs)("div",{className:"text-secondary",children:["Value will be changed",!o&&(0,r.jsxs)(r.Fragment,{children:[" from ",(0,r.jsx)("span",{className:"font-bold text-text-3000",children:J(null,{key:n,value:t,emptyNullLabel:"Unset",isSecret:o})})]})," to ",(0,r.jsx)("span",{className:"font-bold text-text-3000",children:J(null,{key:n,value:e,emptyNullLabel:"Unset"})}),o&&(0,r.jsx)("div",{className:"text-danger",children:"This field is secret - you won't see its value once saved"})]})]})}function Ue({onClose:n,isOpen:t}){let{instanceConfigEditingState:e,editableInstanceSettings:o,updatedInstanceConfigCount:l}=(0,K.useValues)(S),{saveInstanceConfig:d}=(0,K.useActions)(S),u=l!==null,v=e.EMAIL_ENABLED!==!1&&Object.keys(e).find(I=>I.startsWith("EMAIL")),T=e.EMAIL_ENABLED===!0,h=Object.keys(e).length===1?"change":"changes";return(0,r.jsx)(H,{title:`Confirm ${h} to instance configuration`,isOpen:t,closable:!u,onClose:n,width:576,footer:(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(b,{type:"secondary",onClick:n,disabledReason:u?"Saving in progress":void 0,children:"Cancel"}),(0,r.jsxs)(b,{type:"secondary",status:"danger",loading:u,onClick:d,children:["Apply ",h]})]}),children:(0,r.jsxs)("div",{className:"space-y-2",children:[v&&(0,r.jsxs)(B,{type:"info",children:["As you are changing email settings and ",T?"enabling email":"email is enabled",", we'll\xA0attempt to send a\xA0test\xA0email so\xA0you can verify everything works."]}),Object.keys(e).includes("RECORDINGS_TTL_WEEKS")&&(0,r.jsx)(B,{type:"warning",children:(0,r.jsx)(r.Fragment,{children:"Changing your recordings TTL requires ClickHouse to have enough free space to perform the operation (even when reducing this value). In addition, please mind that removing old recordings will be removed asynchronously, not immediately."})}),Object.keys(e).includes("RECORDINGS_PERFORMANCE_EVENTS_TTL_WEEKS")&&(0,r.jsx)(B,{type:"warning",children:(0,r.jsx)(r.Fragment,{children:"Changing your performance events TTL requires ClickHouse to have enough free space to perform the operation (even when reducing this value). In addition, please mind that removing old recordings will be removed asynchronously, not immediately."})}),(0,r.jsxs)("div",{children:["The following ",h," will be immediately applied to your instance."]}),Object.keys(e).map(I=>(0,r.jsx)(_e,{metricKey:I,value:e[I],oldValue:o.find(N=>N.key===I)?.value,isSecret:o.find(N=>N.key===I)?.is_secret},I)),u&&(0,r.jsx)("div",{className:"mt-4 text-success",children:(0,r.jsxs)("b",{children:[Y(l||0,"change")," updated successfully."]})})]})})}f();g();p();var $=c(y());function Te({key:n,value:t,value_type:e,onValueChanged:o,isSecret:l}){return e==="bool"?(0,$.jsx)(D,{defaultChecked:!!t,onChange:u=>o(n,u),label:(0,$.jsx)(V,{type:t?"success":"danger",className:"uppercase",children:t?"Yes":"No"})}):(0,$.jsx)(ue,{defaultValue:l&&t?"":t,type:e==="int"?"number":"text",placeholder:l&&t?"Keep existing secret value":void 0,onBlur:u=>o(n,u.target.value)})}var i=c(y());function we(){let{configOptions:n,preflightLoading:t}=(0,G.useValues)(F),{editableInstanceSettings:e,instanceSettingsLoading:o,instanceConfigMode:l,instanceConfigEditingState:d}=(0,G.useValues)(S),{loadInstanceSettings:u,setInstanceConfigMode:v,updateInstanceConfigValue:T,clearInstanceConfigEditing:h}=(0,G.useActions)(S);(0,Ce.useEffect)(()=>{u()},[]),be({e:{action:()=>v("edit"),disabled:l!=="view"||o},escape:{action:()=>N(),disabled:l!=="edit"||o},enter:{action:()=>I(),disabled:l!=="edit"||o}});let I=()=>{Object.keys(d).length?v("saving"):v("view")},N=()=>{v("view"),h()},z=[{title:"Key",dataIndex:"key",render:function(ee){return(0,i.jsx)("code",{children:ee})}},{title:"Description",dataIndex:"description"},{title:"Value",render:function(ee,Z){let oe={value:Z.value,key:Z.key,emptyNullLabel:"Unset",value_type:Z.value_type,isSecret:Z.is_secret};return l==="view"?J(ee,oe):Te({...oe,value:d[Z.key]??Z.value,onValueChanged:T})}}],w=[{key:"metric",title:"Metric",dataIndex:"metric"},{title:"Value",dataIndex:"value"}];return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsxs)("div",{className:"flex items-center gap-2 mb-4",children:[(0,i.jsxs)("div",{className:"flex-1",children:[(0,i.jsx)("h3",{children:"Instance configuration"}),(0,i.jsxs)("div",{children:["Changing these settings will take effect on your entire instance."," ",(0,i.jsx)(C,{to:"https://posthog.com/docs/self-host/configure/instance-settings",target:"_blank",targetBlankIcon:!0,children:"Learn more"}),"."]})]}),l==="view"?(0,i.jsx)(i.Fragment,{children:(0,i.jsx)(b,{type:"primary",onClick:()=>v("edit"),"data-attr":"instance-config-edit-button",disabled:o,children:"Edit"})}):(0,i.jsxs)(i.Fragment,{children:[Object.keys(d).length>0&&(0,i.jsxs)("span",{className:"text-warning-dark flex items-center gap-2",children:[(0,i.jsx)(ce,{className:"text-xl"}),(0,i.jsxs)("span",{children:["You have ",(0,i.jsx)("b",{children:Object.keys(d).length})," unapplied"," ",Y(Object.keys(d).length,"change",void 0,!1)]})]}),(0,i.jsx)(b,{type:"secondary",disabled:o,onClick:N,children:"Discard changes"}),(0,i.jsx)(b,{type:"primary",disabled:o,onClick:I,children:"Save"})]})]}),(0,i.jsx)(U,{dataSource:e,columns:z,loading:o,rowKey:"key"}),(0,i.jsxs)("div",{className:"my-4",children:[(0,i.jsx)("h3",{children:"Environment configuration"}),(0,i.jsxs)("div",{children:["These settings can only be modified by environment variables."," ",(0,i.jsxs)(C,{to:"https://posthog.com/docs/self-host/configure/environment-variables",target:"_blank",children:["Learn more ",(0,i.jsx)(Q,{style:{verticalAlign:"middle"}})]}),"."]})]}),(0,i.jsx)(U,{dataSource:n,columns:w,loading:t,rowKey:"key"}),(0,i.jsx)(Ue,{isOpen:l==="saving",onClose:()=>v("edit")})]})}f();g();p();var X=c(M());f();g();p();var L=c(M()),ke=c(Be()),Re=c(Me());var ne=(0,L.kea)([(0,L.path)(["scenes","instance","SystemStatus","staffUsersLogic"]),(0,L.connect)({values:[W,["user"]],actions:[W,["loadUser"]]}),(0,L.actions)({setStaffUsersToBeAdded:n=>({userUuids:n}),addStaffUsers:!0,setStaffUserToBeDeleted:n=>({user:n}),deleteStaffUser:n=>({userUuid:n})}),(0,ke.loaders)(({actions:n,values:t})=>({allUsers:[[],{loadAllUsers:async()=>(await j.get("api/users")).results??[],addStaffUsers:async()=>{let{staffUsersToBeAdded:e,allUsers:o}=t;n.setStaffUsersToBeAdded([]);let l=await Promise.all(e.map(async u=>await j.update(`api/users/${u}`,{is_staff:!0}))),d=[...o.filter(({uuid:u})=>!e.includes(u)),...l];return d.sort((u,v)=>u.first_name.localeCompare(v.first_name)),d},deleteStaffUser:async({userUuid:e})=>{await j.update(`api/users/${e}`,{is_staff:!1}),t.user?.uuid===e&&(n.loadUser(),Re.router.actions.push(ve.projectHomepage()));let o=[...t.allUsers];for(let l of o)l.uuid===e&&(l.is_staff=!1);return o}}]})),(0,L.reducers)({staffUsersToBeAdded:[[],{setStaffUsersToBeAdded:(n,{userUuids:t})=>t}],staffUserToBeDeleted:[null,{setStaffUserToBeDeleted:(n,{user:t})=>t}]}),(0,L.selectors)({staffUsers:[n=>[n.allUsers],n=>n.filter(t=>t.is_staff)],nonStaffUsers:[n=>[n.allUsers],n=>n.filter(t=>!t.is_staff)]}),(0,L.events)(({actions:n})=>({afterMount:[n.loadAllUsers]}))]);var s=c(y());function Ee(){let{user:n}=(0,X.useValues)(W),{staffUsers:t,allUsersLoading:e,nonStaffUsers:o,staffUsersToBeAdded:l,staffUserToBeDeleted:d}=(0,X.useValues)(ne),{setStaffUsersToBeAdded:u,addStaffUsers:v,deleteStaffUser:T,setStaffUserToBeDeleted:h}=(0,X.useActions)(ne),I=[{key:"profile_picture",render:function(z,w){return(0,s.jsx)(ye,{user:w})},width:32},{key:"name",title:"Name",dataIndex:"first_name",render:function(z,w){return(0,s.jsxs)(s.Fragment,{children:[w.first_name,w.uuid===n?.uuid&&(0,s.jsx)(V,{className:"uppercase ml-1",children:"Me"})]})}},{key:"email",title:"Email",dataIndex:"email"},{key:"actions",width:32,render:function(z,w){return(0,s.jsx)(b,{"data-attr":"invite-delete",icon:(0,s.jsx)(le,{}),status:"danger",disabledReason:t.length<2&&"At least one staff user must remain",title:t.length<2?"You should always have at least one staff user.":"Cancel the invite",onClick:()=>h(w)})}}];return(0,s.jsxs)("div",{children:[(0,s.jsx)("h3",{className:"l3 mt-4",children:"Staff Users"}),(0,s.jsxs)("div",{className:"mb-4",children:["Users who have permissions to manage instance-wide settings. Staff user permissions are set at the"," ",(0,s.jsx)("b",{children:"instance-level and are independent of any organization or project permissions."})," ",(0,s.jsx)(C,{to:"https://posthog.com/docs/self-host/configure/instance-settings#staff-users",target:"_blank",targetBlankIcon:!0,children:"Learn more"}),"."]}),(0,s.jsx)(de,{className:"mb-4"}),(0,s.jsx)("section",{children:(0,s.jsxs)("div",{className:"flex gap-2 mb-4",children:[(0,s.jsx)("div",{className:"flex-1",children:(0,s.jsx)(fe,{placeholder:"Add staff users here\u2026",loading:e,value:l,onChange:N=>u(N),mode:"multiple","data-attr":"subscribed-emails",options:he(o,"uuid")})}),(0,s.jsx)(b,{type:"primary",loading:e,disabled:l.length===0,onClick:v,children:"Add"})]})}),(0,s.jsx)(U,{dataSource:t,columns:I,loading:e,rowKey:"uuid"}),(0,s.jsx)(Ae,{myself:n,user:d,onClose:()=>h(null),onRemove:()=>{d&&(T(d.uuid),h(null))}})]})}var Ae=({myself:n,user:t,onClose:e,onRemove:o})=>(0,s.jsx)(H,{closable:!1,isOpen:!!t,title:`Remove ${n?.uuid===t?.uuid?"yourself":t?.first_name} as a Staff User?`,onClose:e,footer:(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(b,{type:"secondary",onClick:e,children:"Cancel"}),(0,s.jsx)(b,{form:"text-tile-form",htmlType:"submit",type:"primary",status:"danger",onClick:o,children:"Remove user"})]}),children:(0,s.jsx)("div",{className:"border-none",children:n?.uuid===t?.uuid?(0,s.jsxs)(s.Fragment,{children:["Please confirm you want to ",(0,s.jsx)("b",{children:"remove yourself"})," as a staff user.",(0,s.jsx)("div",{className:"font-normal text-secondary",children:"Only another staff user will be able to add you again."})]}):`Are you sure you want to remove ${t?.first_name} as a Staff User?`})});var a=c(y()),Mn={component:Ge,logic:S};function Ge(){let{tab:n,error:t}=(0,A.useValues)(S),{setTab:e}=(0,A.useActions)(S),{preflight:o,siteUrlMisconfigured:l}=(0,A.useValues)(F),{user:d}=(0,A.useValues)(W),u=[{key:"overview",label:(0,a.jsx)(ae,{title:"System overview is cached for 60 seconds",children:(0,a.jsxs)("span",{children:["System overview ",(0,a.jsx)(ie,{})]})}),content:(0,a.jsx)(Ve,{})}];return d?.is_staff&&(u=u.concat([{key:"metrics",label:"Internal metrics",content:(0,a.jsx)(Le,{})},{key:"settings",label:(0,a.jsxs)(a.Fragment,{children:["Settings"," ",(0,a.jsx)(V,{type:"warning",className:"ml-1 uppercase",children:"Beta"})]}),content:(0,a.jsx)(we,{})},{key:"staff_users",label:"Staff Users",content:(0,a.jsx)(Ee,{})}])),(0,a.jsxs)("div",{className:"system-status-scene",children:[(0,a.jsx)(Se,{caption:(0,a.jsxs)(a.Fragment,{children:["Here you can find all the critical runtime details and settings of your PostHog instance. You have access to this because you're a ",(0,a.jsx)("b",{children:"staff user"}),"."," ",(0,a.jsx)(C,{target:"_blank",targetBlankIcon:!0,to:"https://posthog.com/docs/self-host/configure/instance-settings?utm_medium=in-product&utm_campaign=instance_status",children:"Learn more"}),"."]})}),(0,a.jsxs)("div",{className:"space-y-2",children:[t&&(0,a.jsxs)(B,{type:"error",children:[(0,a.jsx)("div",{children:"Something went wrong"}),(0,a.jsx)("div",{children:t||"An unknown error occurred. Please try again or contact us."})]}),l&&(0,a.jsxs)(B,{type:"warning",action:{children:"Learn more",to:"https://posthog.com/docs/configuring-posthog/environment-variables?utm_medium=in-product&utm_campaign=system-status-site-url-misconfig"},children:["Your ",(0,a.jsx)("code",{children:"SITE_URL"})," environment variable seems misconfigured. Your ",(0,a.jsx)("code",{children:"SITE_URL"})," ","is set to"," ",(0,a.jsx)("b",{children:(0,a.jsx)("code",{children:o?.site_url})})," ","but you're currently browsing this page from"," ",(0,a.jsx)("b",{children:(0,a.jsx)("code",{children:window.location.origin})}),". In order for PostHog to work properly, please set this to the origin where your instance is hosted."]})]}),(0,a.jsx)(pe,{activeKey:n,onChange:e,tabs:u})]})}export{Ge as SystemStatus,Mn as scene};
//# sourceMappingURL=/static/SystemStatus-26GPGNRN.js.map
