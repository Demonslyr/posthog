import{i as ge}from"/static/chunk-TIKFJXRT.js";import{Db as te,Do as A,Gp as M,Hp as v,Io as S,Lh as ue,Qd as ie,Sc as ae,Sd as f,Ta as W,Tf as le,Wd as Y,Xa as ee,Y as L,a as z,da as K,ee as Z,f as _e,fe as ne,g as we,ga as q,gg as ce,h as He,hg as pe,ie as se,ig as x,jo as me,kc as re,pe as Q,r as U,td as oe,te as V,xg as de}from"/static/chunk-TW5IU73S.js";import{Ab as O,Cb as P,Ha as D,Ua as T,fb as J,wc as $,z as j}from"/static/chunk-3UDJFOQH.js";import{d as g,e as y,g as G,j as h}from"/static/chunk-SJXEOBQC.js";y();h();G();var Ze=g(He()),b=g(z()),Ne=g(_e());y();h();G();var I=g(U());function ye(){return(0,I.jsxs)("div",{className:"cursor-default",children:[(0,I.jsx)(re,{style:{marginRight:6,color:"var(--warning)"}}),"Unique groups \u2013"," ",(0,I.jsx)(W,{to:"https://posthog.com/docs/user-guides/group-analytics?utm_medium=in-product&utm_campaign=group-analytics-learn-more",target:"_blank","data-attr":"group-analytics-learn-more",className:"font-semibold",children:"Learn more"})]})}y();h();G();var c=g(z()),Ge=g(we());var he=(0,c.kea)([(0,c.path)(["scenes","feature-flags","featureFlagReleaseConditionsLogic"]),(0,c.props)({}),(0,c.key)(({id:r})=>r??"unknown"),(0,c.connect)({values:[pe,["currentProjectId"],x,["groupTypes","aggregationLabel"]]}),(0,c.actions)({setFilters:r=>({filters:r}),setAggregationGroupTypeIndex:r=>({value:r}),addConditionSet:!0,removeConditionSet:r=>({index:r}),duplicateConditionSet:r=>({index:r}),updateConditionSet:(r,t,a,o)=>({index:r,newRolloutPercentage:t,newProperties:a,newVariant:o}),setAffectedUsers:(r,t)=>({index:r,count:t}),setTotalUsers:r=>({count:r}),calculateBlastRadius:!0}),(0,c.reducers)(({props:r})=>({filters:[r.filters,{setFilters:(t,{filters:a})=>({...a}),setAggregationGroupTypeIndex:(t,{value:a})=>{if(!t||t.aggregation_group_type_index==a)return t;let o=t.groups[0].rollout_percentage;return{...t,aggregation_group_type_index:a,groups:[{properties:[],rollout_percentage:o,variant:null}]}},addConditionSet:t=>{if(!t)return t;let a=[...t?.groups||[],{properties:[],rollout_percentage:void 0,variant:null}];return{...t,groups:a}},updateConditionSet:(t,{index:a,newRolloutPercentage:o,newProperties:l,newVariant:p})=>{if(!t)return t;let d=[...t?.groups||[]];return o!==void 0&&(d[a]={...d[a],rollout_percentage:o}),l!==void 0&&(d[a]={...d[a],properties:l}),p!==void 0&&(d[a]={...d[a],variant:p}),{...t,groups:d}},removeConditionSet:(t,{index:a})=>{if(!t)return t;let o=[...t.groups];return o.splice(a,1),{...t,groups:o}},duplicateConditionSet:(t,{index:a})=>{if(!t)return t;let o=t.groups.concat([t.groups[a]]);return{...t,groups:o}}}],affectedUsers:[{0:void 0},{setAffectedUsers:(t,{index:a,count:o})=>({...t,[a]:o})}],totalUsers:[null,{setTotalUsers:(t,{count:a})=>a}]})),(0,c.listeners)(({actions:r,values:t})=>({duplicateConditionSet:async({index:a},o)=>{await o(1e3);let l=t.affectedUsers[a],p=t.filters.groups.length-1;r.setAffectedUsers(p,l)},updateConditionSet:async({index:a,newProperties:o},l)=>{if(o&&r.setAffectedUsers(a,void 0),!o||o.some(v))return;await l(1e3);let p=await S.create(`api/projects/${t.currentProjectId}/feature_flags/user_blast_radius`,{condition:{properties:o},group_type_index:t.filters?.aggregation_group_type_index??null});r.setAffectedUsers(a,p.users_affected),r.setTotalUsers(p.total_users)},addConditionSet:()=>{r.setAffectedUsers(t.filters.groups.length-1,t.totalUsers||-1)},removeConditionSet:({index:a})=>{let o=Object.keys(t.affectedUsers).length;$(a,o).map(l=>{let p=o-1===l?void 0:t.affectedUsers[l+1];r.setAffectedUsers(l,p)})},setAggregationGroupTypeIndex:()=>{r.calculateBlastRadius()},calculateBlastRadius:async()=>{let a=[];t.filters?.groups?.forEach((l,p)=>{r.setAffectedUsers(p,void 0);let d=l.properties;if(!d||d.some(v))a.push(Promise.resolve({users_affected:-1,total_users:-1}));else if(d.length===0){let N=S.create(`api/projects/${t.currentProjectId}/feature_flags/user_blast_radius`,{condition:{properties:[]},group_type_index:t.filters?.aggregation_group_type_index??null});a.push(N)}else{let N=S.create(`api/projects/${t.currentProjectId}/feature_flags/user_blast_radius`,{condition:l,group_type_index:t.filters?.aggregation_group_type_index??null});a.push(N)}}),(await Promise.all(a)).forEach((l,p)=>{r.setAffectedUsers(p,l.users_affected),l.total_users!==-1&&r.setTotalUsers(l.total_users)})}})),(0,c.selectors)({taxonomicGroupTypes:[r=>[r.filters,r.groupTypes],(r,t)=>{let a=[],o=r?.aggregation_group_type_index!=null?t.get(r.aggregation_group_type_index):void 0;return o?(a.push(`groups_${o?.group_type_index}`),a.push(`name_groups_${r.aggregation_group_type_index}`)):(a.push("person_properties"),a.push("cohorts"),a.push("metadata")),a}],aggregationTargetName:[r=>[r.filters,r.aggregationLabel],(r,t)=>r.aggregation_group_type_index!=null?t(r.aggregation_group_type_index).plural:"users"],filtersTaxonomicOptions:[r=>[r.filters],r=>r&&r.aggregation_group_type_index!=null?{}:{metadata:[{name:"distinct_id",propertyFilterType:"person"}]}],propertySelectErrors:[r=>[r.filters],r=>r?.groups?.map(({properties:t,rollout_percentage:a})=>({properties:t?.map(o=>({value:v(o)?"Property filters can't be empty":void 0})),rollout_percentage:a===void 0?"You need to set a rollout % value":void 0,variant:null}))],computeBlastRadiusPercentage:[r=>[r.affectedUsers,r.totalUsers],(r,t)=>(a,o)=>{let l=a;if((a==null||a&&a>100)&&(l=100),r[o]===-1||t===-1||!t||r[o]===void 0)return l;let p=t;return p===0&&(p=1),l*((r[o]??0)/p)}]}),(0,c.propsChanged)(({props:r,values:t,actions:a})=>{T(r.filters,t.filters)||a.setFilters(r.filters)}),(0,Ge.subscriptions)(({props:r,values:t})=>({filters:(a,o)=>{T(a,o)||r.onChange?.(a,t.propertySelectErrors)}})),(0,c.afterMount)(({props:r,actions:t})=>{r.readOnly||t.calculateBlastRadius()})]);var e=g(U());function je({property:r}){if(r.type==="cohort")return(0,e.jsx)(f,{type:"secondary",size:"xsmall",to:A.cohort(r.value),sideIcon:(0,e.jsx)(q,{}),targetBlank:!0,children:r.cohort_name||`ID ${r.value}`});if(r.value==="is_not_set"||r.value==="is_set")return(0,e.jsx)(e.Fragment,{});let t=Array.isArray(r.value)?r.value:[r.value];return(0,e.jsx)(e.Fragment,{children:t.map((a,o)=>(0,e.jsxs)(V,{children:[a,(0,e.jsx)("span",{children:M(r)&&["is_date_before","is_date_after"].includes(r.operator)&&P(String(a))?` ( ${O(String(a),void 0,"",[],!1,String(a).slice(-1)==="h"?"MMMM D, YYYY HH:mm:ss":"MMMM D, YYYY",!0)}{' '}
                                                            )`:""})]},o))})}function $t({id:r,readOnly:t,isSuper:a,excludeTitle:o,filters:l,onChange:p,hideMatchOptions:d,nonEmptyFeatureFlagVariants:N,showTrashIconWithOneCondition:We=!1,removedLastConditionCallback:Ve}){let k=he({id:r,readOnly:t,isSuper:a,excludeTitle:o,filters:l,onChange:p}),{taxonomicGroupTypes:Ie,propertySelectErrors:R,computeBlastRadiusPercentage:Re,affectedUsers:E,totalUsers:_,filtersTaxonomicOptions:Ce,aggregationTargetName:u}=(0,b.useValues)(k),{setAggregationGroupTypeIndex:Ue,updateConditionSet:C,duplicateConditionSet:xe,removeConditionSet:Se,addConditionSet:ve}=(0,b.useActions)(k),{showGroupsOptions:Xe,groupTypes:Be,aggregationLabel:Te}=(0,b.useValues)(x),{earlyAccessFeaturesList:w,hasEarlyAccessFeatures:X,featureFlagKey:B,nonEmptyVariants:Je}=(0,b.useValues)(ge),{groupsAccessStatus:Le}=(0,b.useValues)(ce),H=N||Je,m=(a?l?.super_groups:l?.groups)||[],Ye=ye(),Qe=i=>!!i.find(n=>n.type==="cohort"||!j.includes(n.key||"")),Ae=i=>!!(X&&i.properties?.some(n=>n.key==="$feature_enrollment/"+B)),Me=()=>[1,2,3].includes(Le),ke=(i,n)=>(0,e.jsxs)("div",{className:"w-full",children:[n>0&&(0,e.jsx)("div",{className:"condition-set-separator",children:"OR"}),(0,e.jsxs)("div",{className:"mb-4 border rounded p-4 bg-surface-primary",children:[(0,e.jsxs)("div",{className:"flex items-center justify-between",children:[(0,e.jsxs)("div",{className:"flex items-center",children:[(0,e.jsxs)(V,{className:"mr-2",children:["Set ",n+1]}),(0,e.jsx)("div",{children:i.properties?.length?(0,e.jsx)(e.Fragment,{children:t?(0,e.jsxs)(e.Fragment,{children:["Match ",(0,e.jsx)("b",{children:u})," against ",(0,e.jsx)("b",{children:"all"})," criteria"]}):(0,e.jsxs)(e.Fragment,{children:["Matching ",(0,e.jsx)("b",{children:u})," against the criteria"]})}):(0,e.jsxs)(e.Fragment,{children:["Condition set will match ",(0,e.jsxs)("b",{children:["all ",u]})]})})]}),!t&&(0,e.jsxs)("div",{className:"flex",children:[(0,e.jsx)(f,{icon:(0,e.jsx)(te,{}),noPadding:!0,onClick:()=>xe(n)}),!Ae(i)&&(m.length>1||We)&&(0,e.jsx)(f,{icon:(0,e.jsx)(oe,{}),noPadding:!0,onClick:()=>{Se(n),m.length===1&&Ve?.()}})]})]}),(0,e.jsx)(Z,{className:"my-3"}),!t&&Qe(i.properties||[])&&(0,e.jsxs)(Y,{type:"info",className:"mt-3 mb-3",children:["These properties aren't immediately available on first page load for unidentified persons. This feature flag requires that at least one event is sent prior to becoming available to your product or website."," ",(0,e.jsxs)(W,{to:"https://posthog.com/docs/libraries/js#bootstrapping-flags",target:"_blank",children:[" ","Learn more about how to make feature flags available instantly."]})]}),t?(0,e.jsx)(e.Fragment,{children:i.properties?.map((s,F)=>(0,e.jsxs)("div",{className:"feature-flag-property-display",children:[F===0?(0,e.jsx)(f,{icon:(0,e.jsx)(L,{className:"arrow-right"}),size:"small"}):(0,e.jsx)(f,{icon:(0,e.jsx)("span",{className:"text-sm",children:"&"}),size:"small"}),s?.type!=="cohort"&&ee(s.key,s.type==="person"?"person_properties":"event_properties"),(0,e.jsxs)(V,{children:[s.type==="cohort"?"Cohort":s.key," "]}),M(s)?(0,e.jsxs)("span",{children:[de(s.operator)," "]}):null,(0,e.jsx)(je,{property:s})]},F))}):(0,e.jsx)("div",{children:(0,e.jsx)(ue,{orFiltering:!0,pageKey:`feature-flag-${r}-${n}-${m.length}-${l.aggregation_group_type_index??""}`,propertyFilters:i?.properties,logicalRowDivider:!0,addText:"Add condition",onChange:s=>C(n,void 0,s),taxonomicGroupTypes:Ie,taxonomicFilterOptionsFromProp:Ce,hasRowOperator:!1,sendAllKeyUpdates:!0,allowRelativeDateOptions:!0,errorMessages:R?.[n]?.properties?.some(s=>!!s.value)?R[n].properties?.map((s,F)=>s.value?(0,e.jsxs)("div",{className:"text-danger flex items-center gap-1 text-sm Field--error",children:[(0,e.jsx)(K,{className:"text-xl"})," ",s.value]},F):(0,e.jsx)(e.Fragment,{})):null,exactMatchFeatureFlagCohortOperators:!0,hideBehavioralCohorts:!0})}),(!t||t&&(i.properties?.length||0)>0)&&(0,e.jsx)(Z,{className:"my-3"}),t?(0,e.jsx)(ne,{type:m.length==1?i.rollout_percentage==null||i.rollout_percentage==100?"highlight":i.rollout_percentage==0?"caution":"none":"none",children:(0,e.jsxs)("div",{className:"text-sm ",children:["Rolled out to"," ",i.rollout_percentage!=null?(0,e.jsx)("b",{children:i.rollout_percentage}):(0,e.jsx)("b",{children:"100"}),(0,e.jsx)("b",{children:"%"}),(0,e.jsx)("span",{children:" of "}),(0,e.jsx)("b",{children:u})," ",(0,e.jsx)("span",{children:"in this set."})]})}):(0,e.jsx)("div",{className:"feature-flag-form-row gap-2",children:(0,e.jsxs)("div",{className:"flex flex-wrap items-center gap-1",children:["Roll out to"," ",(0,e.jsx)(me,{value:i.rollout_percentage!==null?i.rollout_percentage:100,onChange:s=>{C(n,s)},min:0,max:100,step:1,className:"ml-1.5 w-20"}),(0,e.jsx)(le.Pure,{error:R?.[n]?.rollout_percentage,inline:!0,children:(0,e.jsx)(se,{"data-attr":"rollout-percentage",type:"number",className:"ml-2 mr-1.5 max-w-30",onChange:s=>{C(n,s===void 0?0:s)},value:i.rollout_percentage!==null?i.rollout_percentage:100,min:0,max:100,step:"any",suffix:(0,e.jsx)("span",{children:"%"})})})," ",(0,e.jsx)("div",{className:(0,Ze.default)(R?.[n]?.rollout_percentage?"basis-full h-0":"")}),"of ",(0,e.jsx)("b",{children:u})," in this set. Will match approximately"," ",E[n]!==void 0?(0,e.jsx)("b",{children:`${Re(i.rollout_percentage,n).toPrecision(2)*1}% `}):(0,e.jsx)(ie,{className:"mr-1"})," ",(()=>{let s=E[n];return s!==void 0&&s>=0&&_!==null?`(${J(Math.floor(s*(i.rollout_percentage??100)/100))} / ${J(_)})`:""})()," ",(0,e.jsxs)("span",{children:["of total ",u,"."]})]})}),H.length>0&&(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)(Z,{className:"my-3"}),t?(0,e.jsxs)("div",{children:["All ",(0,e.jsx)("b",{children:u})," in this set"," ",i.variant?(0,e.jsxs)(e.Fragment,{children:[" ","will be in variant ",(0,e.jsx)("b",{children:i.variant})]}):(0,e.jsx)(e.Fragment,{children:"have no variant override"})]}):(0,e.jsx)("div",{className:"feature-flag-form-row",children:(0,e.jsxs)("div",{className:"centered",children:[(0,e.jsx)("b",{children:"Optional override:"})," Set variant for all ",(0,e.jsx)("b",{children:u})," in this set to"," ",(0,e.jsx)(Q,{placeholder:"Select variant",allowClear:!0,value:i.variant,onChange:s=>C(n,void 0,void 0,s),options:H.map(s=>({label:s.key,value:s.key})),"data-attr":"feature-flags-variant-override-select"})]})})]})]})]},`${n}-${m.length}`),Ee=(i,n)=>{if(!t)return(0,e.jsx)(e.Fragment,{});let s=w?.find(F=>F.flagKey===B);return(0,e.jsxs)("div",{className:"w-full",children:[n>0&&(0,e.jsx)("div",{className:"condition-set-separator",children:"OR"}),(0,e.jsxs)("div",{className:"mb-4 rounded p-4 bg-surface-primary",children:[(0,e.jsx)("div",{className:"flex items-center justify-between",children:(0,e.jsx)("div",{className:"flex items-center",children:(0,e.jsx)("div",{children:i.properties?.length?(0,e.jsxs)(e.Fragment,{children:["Match ",(0,e.jsx)("b",{children:u})," against value set on"," ",(0,e.jsx)(V,{children:"$feature_enrollment/"+B})]}):(0,e.jsxs)(e.Fragment,{children:["Condition set will match ",(0,e.jsxs)("b",{children:["all ",u]})]})})})}),(0,e.jsx)(Z,{className:"my-3"}),(i.properties?.length||0)>0&&(0,e.jsxs)(e.Fragment,{children:[(0,e.jsxs)("div",{className:"feature-flag-property-display",children:[(0,e.jsx)(f,{icon:(0,e.jsx)(L,{className:"arrow-right"}),size:"small"}),(0,e.jsxs)("span",{children:["If null, default to ",(0,e.jsx)("b",{children:"Release conditions"})]})]}),(0,e.jsx)(Z,{className:"my-3"})]}),(0,e.jsxs)("div",{className:"flex items-center justify-between",children:[(0,e.jsx)("div",{}),(0,e.jsx)(f,{disabledReason:!s&&"The matching Early Access Feature was not found. You can create it in the Early Access Management tab.","aria-label":"more","data-attr":"feature-flag-feature-list-button",size:"small",onClick:()=>X&&Ne.router.actions.push(A.earlyAccessFeature(w[0].id)),children:s?"View Early Access Feature":"No Early Access Feature"})]})]})]},`${n}-${m.length}`)};return(0,e.jsxs)(e.Fragment,{children:[(0,e.jsxs)("div",{className:`feature-flag-form-row ${o&&"mb-2"}`,children:[(0,e.jsxs)("div",{"data-attr":"feature-flag-release-conditions",className:"w-full",children:[t?o?null:(0,e.jsx)("h3",{className:"l3",children:a?"Super Release Conditions":"Release conditions"}):(0,e.jsx)(e.Fragment,{children:!o&&(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)("h3",{className:"l3",children:"Release conditions"}),(0,e.jsxs)("div",{className:"text-secondary mb-4",children:["Specify ",u," for flag release. Condition sets roll out independently.",u==="users"&&(0,e.jsxs)(e.Fragment,{children:[" ","Cohort-based targeting"," ",(0,e.jsx)(W,{to:"https://posthog.com/docs/data/cohorts#can-you-use-a-dynamic-behavioral-cohort-as-a-feature-flag-target",children:"doesn't support dynamic behavioral cohorts."})," "]})]})]})}),!t&&!m.every(i=>m.filter(n=>n.variant===i.variant&&n.variant!==null).length<2)&&(0,e.jsx)(Y,{type:"info",className:"mt-3 mb-3",children:"Multiple variant overrides detected. We use the variant override for the first condition set that matches."})]}),!t&&Xe&&!d&&(0,e.jsxs)("div",{className:"centered",children:["Match by",(0,e.jsx)(Q,{dropdownMatchSelectWidth:!1,className:"ml-2","data-attr":"feature-flag-aggregation-filter",onChange:i=>{if(i==-2)return;Ue(i!==-1?i:null)},value:l.aggregation_group_type_index!=null?l.aggregation_group_type_index:-1,options:[{value:-1,label:"Users"},...Array.from(Be.values()).map(i=>({value:i.group_type_index,label:D(Te(i.group_type_index).plural),disabledReason:X?"This feature flag cannot be group-based, because it is linked to an early access feature.":null})),...Me()?[{value:-2,label:"MatchByGroupsIntroductionOption",labelInMenu:Ye}]:[]]})]})]}),(0,e.jsx)("div",{className:"FeatureConditionCard",children:m.map((i,n)=>a?Ee(i,n):ke(i,n))}),!t&&(0,e.jsx)(f,{type:"secondary",className:"mt-0 w-max",onClick:ve,icon:(0,e.jsx)(ae,{}),children:"Add condition set"})]})}export{$t as a};
//# sourceMappingURL=/static/chunk-7Q4UL5YB.js.map
