import{a as me}from"/static/chunk-WIMSPR44.js";import{a as ce,b as q,c as le,d as E,e as N,f as pe,g as I,h as de,i as ke,j as H}from"/static/chunk-GOBPXP3Z.js";import{Do as _,Fa as B,Ga as G,Gm as ne,Mi as w,Pl as V,Rd as ee,Sa as A,Ta as j,Uc as Z,Wh as ae,a as X,cb as W,dj as oe,ee as re,f as Ee,fe as f,fj as ie,h as Me,io as U,r as v,sc as Y,wk as se,ze as te}from"/static/chunk-TW5IU73S.js";import"/static/chunk-XPJ4MQJV.js";import{Ob as D,Tb as Q,Wa as z,a as xe,na as F}from"/static/chunk-3UDJFOQH.js";import"/static/chunk-HHT4SG7V.js";import"/static/chunk-K7LQKAJG.js";import"/static/chunk-QQTK3LZH.js";import"/static/chunk-IJQNM355.js";import"/static/chunk-4CN6THWS.js";import"/static/chunk-272RTCFX.js";import"/static/chunk-2ROB4QWU.js";import"/static/chunk-ALT2ZZSO.js";import"/static/chunk-UE6SLBBN.js";import"/static/chunk-GINZUAUY.js";import"/static/chunk-SQELCOUW.js";import"/static/chunk-IGYUTZ65.js";import"/static/chunk-YM6UBNGD.js";import"/static/chunk-C6TQ5FFZ.js";import"/static/chunk-GXGA523B.js";import"/static/chunk-N4MMWRNK.js";import"/static/chunk-NRLAI7OY.js";import"/static/chunk-LVVHNICT.js";import"/static/chunk-2AXSSSSX.js";import"/static/chunk-DGXQI7RB.js";import"/static/chunk-HUCRWDLX.js";import"/static/chunk-RFEQG3YN.js";import"/static/chunk-PUISI233.js";import{d as n,e as l,g as p,j as d}from"/static/chunk-SJXEOBQC.js";l();d();p();var ye=n(ke()),R=n(Me()),h=n(X());var L=n(xe());l();d();p();var K=n(v());function ue({properties:e}){let{$ai_feedback_text:t}=e,a=typeof t=="string"?t.slice(0,5):"";return(0,K.jsx)(f,{className:"bg-surface-primary cursor-default",children:(0,K.jsx)(w,{iconSize:"xsmall",description:"user feedback",tooltipMessage:t||"No feedback provided",explicitValue:String(t),children:`User feedback${a?`: ${a}...`:""}`})})}l();d();p();var m=n(v());function fe({properties:e}){let{$ai_metric_name:t,$ai_metric_value:a}=e,o=String(a),s=o.length>10,c=t?D(t):"Metric",u=s?`${o.slice(0,10)}...`:o,i=`${c}: ${u}`;return(0,m.jsx)(f,{className:"bg-surface-primary cursor-default",children:(0,m.jsx)(w,{iconSize:"xsmall",description:"metric",explicitValue:o,tooltipMessage:s?(0,m.jsxs)(m.Fragment,{children:[t&&(0,m.jsxs)("span",{children:["Metric: ",t,(0,m.jsx)("br",{}),(0,m.jsx)("br",{})]}),a,(0,m.jsx)("br",{}),(0,m.jsx)("span",{children:"Click to copy the value"})]}):"Click to copy the value",children:i})})}l();d();p();var P=n(v());function ge({eventProperties:e}){return(0,P.jsx)("div",{className:"flex flex-row flex-wrap gap-2",children:e.$ai_model_parameters&&Object.entries(e.$ai_model_parameters).map(([t,a])=>a!==null&&(0,P.jsxs)(f,{type:"muted",children:[t,": ",`${a}`]},t))})}l();d();p();var T=n(X());l();d();p();var g=n(X()),Te=n(Ee());var x=(0,g.kea)([(0,g.path)(["scenes","llm-observability","llmObservabilityTraceLogic"]),(0,g.actions)({setTraceId:e=>({traceId:e}),setEventId:e=>({eventId:e}),setDateFrom:e=>({dateFrom:e})}),(0,g.reducers)({traceId:["",{setTraceId:(e,{traceId:t})=>t}],eventId:[null,{setEventId:(e,{eventId:t})=>t}],dateFrom:[null,{setDateFrom:(e,{dateFrom:t})=>t}]}),(0,g.selectors)({query:[e=>[e.traceId,e.dateFrom],(e,t)=>{let a={kind:"TracesQuery",traceId:e,dateRange:t?{date_from:t,date_to:(0,F.default)(t).add(10,"minutes").toISOString()}:{date_from:F.default.utc(new Date(2025,0,10)).toISOString()}};return{kind:"DataTableNode",source:a}}],breadcrumbs:[e=>[e.traceId],e=>[{key:"LLMObservability",name:"LLM observability",path:_.llmObservabilityDashboard()},{key:"LLMObservability",name:"Traces",path:_.llmObservabilityTraces()},{key:["LLMObservability",e||""],name:e}]]}),(0,Te.urlToAction)(({actions:e})=>({[_.llmObservabilityTrace(":id")]:({id:t},{event:a,timestamp:o})=>{e.setTraceId(t??""),e.setEventId(a||null),e.setDateFrom(o||null)}}))]);function $e({traceId:e,query:t,cachedResults:a}){let o={dashboardItemId:`new-Trace.${e}`,dataNodeCollectionId:e},s=V(o);return{query:t.source,key:s,dataNodeCollectionId:e,alwaysRefresh:!1,cachedResults:a||void 0}}var Le=new Set(["$ai_feedback","$ai_metric"]),O=(0,T.kea)([(0,T.path)(["scenes","llm-observability","llmObservabilityTraceLogic"]),(0,T.props)({}),(0,T.connect)(e=>({values:[x,["eventId"],ae($e(e)),["response","responseLoading","responseError"]]})),(0,T.selectors)({trace:[e=>[e.response],e=>e?.results?.[0]],showableEvents:[e=>[e.trace],e=>e?e.events.filter(t=>!Le.has(t.event)):[]],metricEvents:[e=>[e.trace],e=>e?.events.filter(t=>t.event==="$ai_metric"&&t.properties.$ai_metric_value)],feedbackEvents:[e=>[e.trace],e=>e?.events.filter(t=>t.event==="$ai_feedback"&&t.properties.$ai_feedback_text)],metricsAndFeedbackEvents:[e=>[e.metricEvents,e.feedbackEvents],(e,t)=>[...e??[],...t??[]].map(a=>({metric:a.event==="$ai_metric"?a.properties.$ai_metric_name??"Metric":"User feedback",value:a.properties.$ai_metric_value??a.properties.$ai_feedback_text}))],event:[(e,t)=>[t.traceId,e.eventId,e.trace,e.showableEvents],(e,t,a,o)=>!t||t===e?a||null:o?.length&&o.find(s=>s.id===t)||null],tree:[(e,t)=>[t.traceId,e.trace],(e,t)=>Ce(t?.events||[],e)]})]);function Ce(e,t){let a=new Map,o=new Map,s=new Set;for(let i of e){if(Le.has(i.event))continue;let b=i.properties.$ai_generation_id??i.properties.$ai_span_id??i.id;o.set(b,i);let y=i.properties.$ai_parent_id??i.properties.$ai_trace_id;if(y!=null){let S=a.get(y);S?S.push(b):a.set(y,[b])}}function c(i){if(s.has(i))return console.warn("Circular reference detected in trace tree:",i),null;let b=o.get(i);if(!b)return null;s.add(i);let y=a.get(i),S={event:b,children:y?.map(J=>c(J)).filter(J=>J!==null)};return s.delete(i),S}return(a.get(t)||[]).map(i=>c(i)).filter(i=>i!==null)}var r=n(v()),Vr={component:Se,logic:x};function Se(){let{traceId:e,query:t}=(0,h.useValues)(x);return(0,r.jsx)(h.BindLogic,{logic:O,props:{traceId:e,query:t},children:(0,r.jsx)(De,{})})}function De(){let{eventId:e}=(0,h.useValues)(x),{tree:t,trace:a,event:o,responseLoading:s,responseError:c,feedbackEvents:u,metricEvents:i}=(0,h.useValues)(O);return(0,r.jsx)(r.Fragment,{children:s?(0,r.jsx)(ee,{}):c?(0,r.jsx)(ie,{}):a?(0,r.jsxs)("div",{className:"relative space-y-4 flex flex-col md:h-[calc(100vh_-_var(--breadcrumbs-height-full)_-_var(--scene-padding)_-_var(--scene-padding-bottom))] ",children:[(0,r.jsx)(Ie,{trace:a,metricEvents:i,feedbackEvents:u}),(0,r.jsxs)("div",{className:"flex flex-1 min-h-0 gap-4 flex-col md:flex-row",children:[(0,r.jsx)(Pe,{trace:a,eventId:e,tree:t}),(0,r.jsx)(Ne,{event:o})]})]}):(0,r.jsx)(ne,{object:"trace"})})}function C({title:e,children:t,icon:a}){return(0,r.jsx)(A,{title:e,children:(0,r.jsxs)(f,{size:"medium",className:"bg-surface-primary",icon:a,children:[(0,r.jsx)("span",{className:"sr-only",children:e}),t]})})}function we({event:e}){let t=q(e);return t?(0,r.jsx)(C,{title:"Usage",icon:(0,r.jsx)(W,{}),children:t}):null}function Ie({trace:e,metricEvents:t,feedbackEvents:a}){return(0,r.jsxs)("header",{className:"flex gap-2 flex-wrap",children:["person"in e&&(0,r.jsx)(C,{title:"Person",children:(0,r.jsx)(se,{withIcon:"sm",person:e.person})}),(0,r.jsx)(we,{event:e}),typeof e.inputCost=="number"&&(0,r.jsx)(C,{title:"Input cost",icon:(0,r.jsx)(B,{}),children:E(e.inputCost)}),typeof e.outputCost=="number"&&(0,r.jsx)(C,{title:"Output cost",icon:(0,r.jsx)(G,{}),children:E(e.outputCost)}),typeof e.totalCost=="number"&&(0,r.jsx)(C,{title:"Total cost",icon:(0,r.jsx)(Z,{}),children:E(e.totalCost)}),t.map(o=>(0,r.jsx)(fe,{properties:o.properties},o.id)),a.map(o=>(0,r.jsx)(ue,{properties:o.properties},o.id))]})}function Pe({trace:e,eventId:t,tree:a}){let o=(0,L.useRef)(null);return(0,L.useEffect)(()=>{if(t&&o.current){let s=o.current.querySelector("[aria-current=true]");s&&s.scrollIntoView({block:"center"})}},[t]),(0,r.jsxs)("aside",{className:"border-border max-h-fit bg-surface-primary border rounded overflow-hidden flex flex-col md:w-80",ref:o,children:[(0,r.jsx)("h3",{className:"font-medium text-sm px-2 my-2",children:"Tree"}),(0,r.jsx)(re,{className:"m-0"}),(0,r.jsxs)("ul",{className:"overflow-y-auto p-1 first:*:mt-0 overflow-x-hidden",children:[(0,r.jsx)(ve,{topLevelTrace:e,item:e,isSelected:!t||t===e.id}),(0,r.jsx)(he,{tree:a,trace:e,selectedEventId:t})]})]})}function Oe({onToggle:e,isCollapsed:t,children:a}){return(0,r.jsxs)("li",{className:(0,R.default)("flex items-stretch min-w-0",t&&"text-border hover:text-muted"),children:[(0,r.jsx)("div",{className:(0,R.default)("mb-1 ml-1 cursor-pointer",!t&&"text-border hover:text-muted"),onClick:e,children:(0,r.jsx)("div",{className:(0,R.default)("w-0 h-full my-0 ml-1 mr-2 border-l border-current",t&&"border-dashed")})}),(0,r.jsx)("ul",{className:"flex-1 min-w-0",children:a})]})}var ve=L.default.memo(function({topLevelTrace:t,item:a,isSelected:o}){let s="properties"in a?a.properties.$ai_total_cost_usd:a.totalCost,c="properties"in a?a.properties.$ai_latency:a.totalLatency,u=q(a),i=[N(a)&&a.properties.$ai_is_error&&(0,r.jsx)(f,{type:"danger",children:"Error"},"error-tag"),c>=.01&&(0,r.jsx)(f,{type:"muted",children:le(c)},"latency-tag"),(u!=null||s!=null)&&(0,r.jsxs)("span",{children:[u,u!=null&&s!=null&&(0,r.jsx)("span",{children:" / "}),s!=null&&E(s)]},"usage-tag")],b=i.some(y=>!!y);return(0,r.jsx)("li",{className:"mt-0.5","aria-current":o,children:(0,r.jsxs)(j,{to:_.llmObservabilityTrace(t.id,{event:a.id,timestamp:pe(t.createdAt)}),className:(0,ye.default)("flex flex-col gap-1 p-1 text-xs rounded min-h-8 justify-center hover:!bg-accent-primary-highlight",o&&"!bg-accent-primary-highlight"),children:[(0,r.jsxs)("div",{className:"flex flex-row items-center gap-1.5",children:[(0,r.jsx)(_e,{event:a,size:"small"}),(0,r.jsx)(A,{title:I(a),children:(0,r.jsx)("span",{className:"flex-1 truncate",children:I(a)})})]}),b&&(0,r.jsx)("div",{className:"flex flex-row flex-wrap text-secondary items-center gap-1.5",children:i})]})},a.id)});function he({tree:e,trace:t,selectedEventId:a}){let[o,s]=(0,L.useState)(!1);return(0,r.jsx)(Oe,{isCollapsed:o,onToggle:()=>s(!o),children:o?(0,r.jsxs)("div",{className:"text-secondary hover:text-default text-xxs cursor-pointer p-1",onClick:()=>s(!1),children:["Show ",Q(e.length,"collapsed child","collapsed children")]}):e.map(({event:c,children:u})=>(0,r.jsxs)(L.default.Fragment,{children:[(0,r.jsx)(ve,{topLevelTrace:t,item:c,isSelected:!!a&&a===c.id}),u&&(0,r.jsx)(he,{tree:u,trace:t,selectedEventId:a})]},c.id))})}function be({input:e,output:t,raisedError:a}){return!e&&!t?(0,r.jsx)(r.Fragment,{}):(0,r.jsx)(ce,{inputDisplay:(0,r.jsx)("div",{className:"p-2 text-xs border rounded bg-[var(--bg-fill-secondary)]",children:z(e)?(0,r.jsx)(U,{src:e,collapsed:4}):(0,r.jsx)("span",{className:"font-mono",children:JSON.stringify(e??null)})}),outputDisplay:(0,r.jsx)("div",{className:me("p-2 text-xs border rounded",a?"bg-[var(--bg-fill-error-tertiary)]":"bg-[var(--bg-fill-success-tertiary)]"),children:z(t)?(0,r.jsx)(U,{src:t,collapsed:4}):(0,r.jsx)("span",{className:"font-mono",children:JSON.stringify(t??null)})})})}var Ne=L.default.memo(({event:e})=>(0,r.jsx)("div",{className:"flex-1 bg-surface-primary max-h-fit border rounded flex flex-col border-border p-4 overflow-y-auto",children:e?(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)("header",{className:"space-y-2",children:[(0,r.jsxs)("div",{className:"flex-row flex items-center gap-2",children:[(0,r.jsx)(_e,{event:e}),(0,r.jsx)("h3",{className:"text-lg font-semibold p-0 m-0 truncate flex-1",children:I(e)})]}),N(e)?(0,r.jsx)(H,{isError:e.properties.$ai_is_error,inputTokens:e.properties.$ai_input_tokens,outputTokens:e.properties.$ai_output_tokens,totalCostUsd:e.properties.$ai_total_cost_usd,model:e.properties.$ai_model,latency:e.properties.$ai_latency}):(0,r.jsx)(H,{inputTokens:e.inputTokens,outputTokens:e.outputTokens,totalCostUsd:e.totalCost,latency:e.totalLatency}),N(e)&&(0,r.jsx)(ge,{eventProperties:e.properties})]}),N(e)?e.event==="$ai_generation"?(0,r.jsx)(de,{input:e.properties.$ai_input,output:e.properties.$ai_is_error?e.properties.$ai_error:e.properties.$ai_output_choices??e.properties.$ai_output,httpStatus:e.properties.$ai_http_status,raisedError:e.properties.$ai_is_error}):(0,r.jsx)(be,{input:e.properties.$ai_input_state,output:e.properties.$ai_output_state??e.properties.$ai_error,raisedError:e.properties.$ai_is_error}):(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(Re,{}),(0,r.jsx)(be,{input:e.inputState,output:e.outputState})]})]}):(0,r.jsx)(oe,{heading:"Event not found",detail:"Check if the event ID is correct."})}));Ne.displayName="EventContent";function _e({event:e,size:t}){let a="trace";return N(e)&&(a=e.event==="$ai_generation"?"generation":"span"),(0,r.jsx)(f,{className:"uppercase",type:a==="trace"?"completion":a==="span"?"default":"success",size:t,children:a})}function Re(){let{metricsAndFeedbackEvents:e}=(0,h.useValues)(O);return e?.length?(0,r.jsxs)("div",{className:"mb-3",children:[(0,r.jsxs)("h4",{className:"flex items-center gap-x-1.5 text-xs font-semibold mb-2",children:[(0,r.jsx)(Y,{className:"text-base"}),"Metrics and user feedback"]}),(0,r.jsx)(te,{columns:[{title:"Metric",key:"metric",render:(t,{metric:a})=>(0,r.jsx)("span",{children:D(a)}),width:"40%"},{title:"Value",key:"value",render:(t,{value:a})=>(0,r.jsx)("span",{children:a??"\u2013"}),width:"60%"}],dataSource:e})]}):null}export{Se as LLMObservabilityTraceScene,Vr as scene};
//# sourceMappingURL=/static/LLMObservabilityTraceScene-HO4XEFC2.js.map
