import{a as bt,b as Aa,c as Oa,d as _t}from"/static/chunk-4QFQ4UPP.js";import{a as Wt}from"/static/chunk-5SPEHGYT.js";import{a as Ia,c as Fa,d as Ma,e as Da}from"/static/chunk-P6WLOCWZ.js";import{b as Ce,c as Ra}from"/static/chunk-YBY7DSFA.js";import{a as Pa}from"/static/chunk-DXU2OWVA.js";import{a as Jt}from"/static/chunk-LYVLXNIU.js";import{a as Ze}from"/static/chunk-4HIBDE5Y.js";import{h as At,i as ka,j as Ot,k as Ba,l as wa,m as Ca,n as Ta,s as qt}from"/static/chunk-44P5EQSU.js";import{h as Ea}from"/static/chunk-CBJ7RAUW.js";import{$a as ve,$c as ia,$d as Se,Ac as ra,Ae as pa,Bo as xa,Cb as aa,Ce as dt,Do as ce,Eo as Na,Gm as Q,Hg as ga,Ig as fa,Io as S,Ko as de,Lh as ha,Nb as na,Nd as sa,Oe as ut,Pe as mt,Q as ea,Qd as la,R as ta,Rd as qe,Sa as V,Sc as Mt,Sd as x,Sm as gt,Ta as Ae,Tf as f,Tm as ba,Vd as N,Wd as ca,Wm as he,Xd as Le,Xk as pt,Za as _e,Zd as ze,a as F,ae as da,b as Pt,cc as fe,ce as Je,ch as q,cl as ya,de as we,f as It,fe as lt,ge as ct,gn as _a,h as Qt,hn as va,ie as E,in as ft,je as $e,kc as oa,m as De,ma as st,mn as Dt,na as Ve,pe as Z,pg as We,pn as La,qb as Oe,r as C,rn as Ke,se as oe,te as ua,ve as ma,vo as pe,xo as ht,yo as yt,ze as ee,zo as Sa}from"/static/chunk-RFJTZKD6.js";import{F as Be,Ha as Zt,Tb as rt,U as ie,a as Fe,dc as Ft,ea as Me,fb as Ye,na as O,o as Kt,yc as it}from"/static/chunk-3UDJFOQH.js";import{d as c,e as b,g as _,j as v}from"/static/chunk-SJXEOBQC.js";b();v();_();var $t=c(F());b();v();_();var ge=c(F());var Ha=c(Fe());b();v();_();var te=c(F()),qa=c(_e());var vt=(0,te.kea)([(0,te.path)(["scenes","data-warehouse","settings","DataWarehouseSourcesTableSyncMethodModalLogic"]),(0,te.props)({schema:{}}),(0,te.key)(e=>e.schema.id),(0,te.connect)(()=>({actions:[ht,["updateSchema","updateSchemaSuccess","updateSchemaFailure","loadSources"]]})),(0,te.actions)({openSyncMethodModal:e=>({schema:e}),closeSyncMethodModal:!0}),(0,qa.loaders)({schemaIncrementalFields:[null,{loadSchemaIncrementalFields:async e=>await S.externalDataSchemas.incremental_fields(e),resetSchemaIncrementalFields:()=>null}]}),(0,te.reducers)({syncMethodModalIsOpen:[!1,{openSyncMethodModal:()=>!0,closeSyncMethodModal:()=>!1}],currentSyncMethodModalSchema:[null,{openSyncMethodModal:(e,{schema:t})=>t,closeSyncMethodModal:()=>null}],saveButtonIsLoading:[!1,{updateSchema:()=>!0,updateSchemaFailure:()=>!1,updateSchemaSuccess:()=>!1}]}),(0,te.listeners)(({actions:e})=>({updateSchemaSuccess:()=>{e.loadSources(null),e.resetSchemaIncrementalFields(),e.closeSyncMethodModal()}}))]);b();v();_();var z=c(F()),Ja=c(ve()),Wa=c(_e());var Lt=5e3,se=(0,z.kea)([(0,z.path)(["scenes","data-warehouse","settings","source","dataWarehouseSourceSettingsLogic"]),(0,z.props)({}),(0,z.key)(({id:e})=>e),(0,z.actions)({setSourceId:e=>({id:e}),reloadSchema:e=>({schema:e}),resyncSchema:e=>({schema:e}),setCanLoadMoreJobs:e=>({canLoadMoreJobs:e})}),(0,Wa.loaders)(({actions:e,values:t})=>({source:[null,{loadSource:async()=>await S.externalDataSources.get(t.sourceId),updateSchema:async a=>{let n=JSON.parse(JSON.stringify(t.source)),o=n.schemas.findIndex(p=>p.id===a.id);n.schemas[o]=a,e.loadSourceSuccess(n);let l=await S.externalDataSchemas.update(a.id,a),i=t.source;return o!==void 0&&(i.schemas[o]=l),i},updateSource:async a=>{let n=await S.externalDataSources.update(t.sourceId,a);return e.loadSourceSuccess(n),n}}],jobs:[[],{loadJobs:async()=>t.jobs.length===0?await S.externalDataSources.jobs(t.sourceId,null,null):[...await S.externalDataSources.jobs(t.sourceId,null,t.jobs[0].created_at),...t.jobs],loadMoreJobs:async()=>{if(t.jobs.length>=0){let n=t.jobs[t.jobs.length-1].created_at,o=await S.externalDataSources.jobs(t.sourceId,n,null);return o.length===0?(e.setCanLoadMoreJobs(!1),t.jobs):[...t.jobs,...o]}return t.jobs}}]})),(0,z.reducers)(({props:e})=>({sourceId:[e.id,{setSourceId:(t,{id:a})=>a}],canLoadMoreJobs:[!0,{setCanLoadMoreJobs:(t,{canLoadMoreJobs:a})=>a,setSourceId:()=>!0}]})),(0,z.selectors)({sourceFieldConfig:[e=>[e.source],e=>e?Sa[e.source_type]:null]}),(0,Ja.forms)(({values:e,actions:t})=>({sourceConfig:{defaults:{},errors:a=>xa(e.sourceFieldConfig?.fields??[],a),submit:async({payload:a={}})=>{let n={...e.source?.job_inputs,...a};try{let o=await S.externalDataSources.update(e.sourceId,{job_inputs:n});t.loadSourceSuccess(o),N.success("Source updated")}catch(o){o.message?N.error(o.message):N.error("Cant update source at this time")}}}})),(0,z.listeners)(({values:e,actions:t,cache:a})=>({loadSourceSuccess:()=>{clearTimeout(a.sourceRefreshTimeout),a.sourceRefreshTimeout=setTimeout(()=>{t.loadSource()},Lt)},loadSourceFailure:()=>{clearTimeout(a.sourceRefreshTimeout),a.sourceRefreshTimeout=setTimeout(()=>{t.loadSource()},Lt)},loadJobsSuccess:()=>{clearTimeout(a.jobsRefreshTimeout),a.jobsRefreshTimeout=setTimeout(()=>{t.loadJobs()},Lt)},loadJobsFailure:()=>{clearTimeout(a.jobsRefreshTimeout),a.jobsRefreshTimeout=setTimeout(()=>{t.loadJobs()},Lt)},reloadSchema:async({schema:n})=>{let o=JSON.parse(JSON.stringify(e.source)),l=o.schemas.findIndex(i=>i.id===n.id);o.status="Running",o.schemas[l].status="Running",t.loadSourceSuccess(o);try{await S.externalDataSchemas.reload(n.id),Pt.capture("schema reloaded",{sourceType:o.source_type})}catch(i){i.message?N.error(i.message):N.error("Cant reload schema at this time")}},resyncSchema:async({schema:n})=>{let o=JSON.parse(JSON.stringify(e.source)),l=o.schemas.findIndex(i=>i.id===n.id);o.status="Running",o.schemas[l].status="Running",t.loadSourceSuccess(o);try{await S.externalDataSchemas.resync(n.id),Pt.capture("schema resynced",{sourceType:o.source_type})}catch(i){i.message?N.error(i.message):N.error("Cant refresh schema at this time")}}})),(0,z.afterMount)(({actions:e})=>{e.loadSource(),e.loadJobs()})]);var L=c(C()),Ua=({id:e})=>{let{source:t,sourceLoading:a}=(0,ge.useValues)(se({id:e}));return(0,L.jsx)(ge.BindLogic,{logic:se,props:{id:e},children:(0,L.jsx)(qn,{schemas:t?.schemas??[],isLoading:a})})},On={Running:"primary",Completed:"success",Error:"danger",Failed:"danger",Suspended:"warning","Billing limits":"danger"},qn=({schemas:e,isLoading:t})=>{let{updateSchema:a,reloadSchema:n,resyncSchema:o}=(0,ge.useActions)(se),{schemaReloadingById:l}=(0,ge.useValues)(ht);return(0,L.jsx)(L.Fragment,{children:(0,L.jsx)(ee,{dataSource:e,loading:t,disableTableWhileLoading:!1,columns:[{title:"Schema Name",key:"name",render:function(p,s){return(0,L.jsx)("span",{children:s.name})}},{title:"Sync Frequency",key:"frequency",render:function(p,s){return(0,L.jsx)(Z,{className:"my-1",disabled:!s.should_sync,value:s.sync_frequency||"6hour",onChange:k=>a({...s,sync_frequency:k}),options:[{value:"5min",label:"5 mins"},{value:"30min",label:"30 mins"},{value:"1hour",label:"1 hour"},{value:"6hour",label:"6 hours"},{value:"12hour",label:"12 hours"},{value:"24hour",label:"Daily"},{value:"7day",label:"Weekly"},{value:"30day",label:"Monthly"}]})}},{title:"Sync method",key:"incremental",render:function(p,s){let{openSyncMethodModal:k}=(0,ge.useActions)(vt({schema:s}));return s.sync_type?(0,L.jsxs)(L.Fragment,{children:[(0,L.jsx)(x,{className:"my-1",size:"small",type:"secondary",onClick:()=>k(s),children:s.sync_type=="incremental"?"Incremental":"Full refresh"}),(0,L.jsx)(ja,{schema:s})]}):(0,L.jsxs)(L.Fragment,{children:[(0,L.jsx)(x,{className:"my-1",type:"primary",onClick:()=>k(s),children:"Set up"}),(0,L.jsx)(ja,{schema:s})]})}},{title:"Enabled",key:"should_sync",render:function(p,s){return(0,L.jsx)(Le,{disabledReason:s.sync_type===null?"You must set up the sync method first":void 0,checked:s.should_sync,onChange:k=>{a({...s,should_sync:k})}})}},{title:"Synced Table",key:"table",render:function(p,s){if(s.table){let k=Ma(s.table.name,s.table.columns);return(0,L.jsx)(Ae,{to:ce.dataWarehouse(JSON.stringify(k)),children:(0,L.jsx)("code",{children:s.table.name})})}return s.status==="Completed"?(0,L.jsx)("div",{children:"No rows to query"}):(0,L.jsx)("div",{children:"Not yet synced"})}},{title:"Last Synced At",key:"last_synced_at",render:function(p,s){return s.last_synced_at?(0,L.jsx)(L.Fragment,{children:(0,L.jsx)(q,{time:s.last_synced_at,formatDate:"MMM\xA0DD,\xA0YYYY",formatTime:"HH:mm"})}):null}},{title:"Rows Synced",key:"rows_synced",render:function(p,s){return s.table?s.table.row_count.toLocaleString():s.status==="Completed"?0:""}},{title:"Status",key:"status",render:(i,p)=>{if(!p.status)return null;let s=p.status==="Error"&&!p.should_sync,k=(0,L.jsx)(lt,{type:On[s?"Suspended":p.status]||"default",children:s?"Suspended":p.status});return p.latest_error&&p.status==="Error"?(0,L.jsx)(V,{title:p.latest_error,children:k}):k}},{key:"actions",width:0,render:function(p,s){return l[s.id]?(0,L.jsx)("div",{children:(0,L.jsx)(la,{})}):(0,L.jsx)("div",{className:"flex flex-row justify-end",children:(0,L.jsx)("div",{children:(0,L.jsx)(ma,{overlay:(0,L.jsxs)(L.Fragment,{children:[(0,L.jsx)(x,{type:"tertiary",onClick:()=>{n(s)},children:"Reload"},`reload-data-warehouse-schema-${s.id}`),s.incremental&&(0,L.jsx)(V,{title:"Completely resync incrementally loaded data. Only recommended if there is an issue with data quality in previously imported data",children:(0,L.jsx)(x,{type:"tertiary",onClick:()=>{o(s)},status:"danger",children:"Resync"},`resync-data-warehouse-schema-${s.id}`)})]})})})})}}]})})},ja=({schema:e})=>{let{syncMethodModalIsOpen:t,currentSyncMethodModalSchema:a,schemaIncrementalFields:n,schemaIncrementalFieldsLoading:o,saveButtonIsLoading:l}=(0,ge.useValues)(vt({schema:e})),{closeSyncMethodModal:i,loadSchemaIncrementalFields:p,resetSchemaIncrementalFields:s,updateSchema:k}=(0,ge.useActions)(vt({schema:e}));(0,Ha.useEffect)(()=>{a?.id&&(s(),p(a.id))},[a?.id]);let w=o||!n,d=!w&&n;return a?(0,L.jsxs)(Je,{title:`Sync method for ${a.name}`,isOpen:t,onClose:i,footer:w&&(0,L.jsxs)(L.Fragment,{children:[(0,L.jsx)(oe.Button,{}),(0,L.jsx)(oe.Button,{})]}),children:[w&&(0,L.jsxs)("div",{className:"space-y-2",children:[(0,L.jsx)(oe,{className:"w-1/2 h-4"}),(0,L.jsx)(oe.Row,{repeat:3})]}),d&&(0,L.jsx)(Ia,{showRefreshMessageOnChange:a.sync_type!==null,saveButtonIsLoading:l,schema:{table:a.name,should_sync:a.should_sync,sync_type:a.sync_type,incremental_field:a.incremental_field??null,incremental_field_type:a.incremental_field_type??null,incremental_available:!!n.length,incremental_fields:n},onClose:()=>{s(),i()},onSave:(y,P,T)=>{k(y==="full_refresh"?{...a,should_sync:!0,sync_type:y,incremental_field:null,incremental_field_type:null}:{...a,should_sync:!0,sync_type:y,incremental_field:P,incremental_field_type:T})}})]}):(0,L.jsx)(L.Fragment,{})};b();v();_();var Te=c(F()),Xa=c(ve());var le=c(C()),Ga=({id:e})=>{let{sourceFieldConfig:t}=(0,Te.useValues)(se({id:e}));return(0,le.jsx)(Te.BindLogic,{logic:se,props:{id:e},children:t?(0,le.jsx)(Jn,{id:e,sourceConfig:t,showPrefix:!1}):(0,le.jsx)(oe,{})})};function Jn(e){let{source:t,sourceLoading:a}=(0,Te.useValues)(se({id:e.id})),{setSourceConfigValue:n}=(0,Te.useActions)(se);return(0,le.jsxs)(le.Fragment,{children:[(0,le.jsx)("span",{className:"block mb-2",children:"Overwrite your existing configuration here"}),(0,le.jsxs)(Xa.Form,{logic:se,formKey:"sourceConfig",enableFormOnSubmit:!0,children:[(0,le.jsx)(Fa,{...e,jobInputs:t?.job_inputs,setSourceConfigValue:n}),(0,le.jsx)("div",{className:"mt-4 flex flex-row justify-end gap-2",children:(0,le.jsx)(x,{loading:a&&!t,type:"primary",center:!0,htmlType:"submit","data-attr":"source-update",children:"Save"})})]})]})}b();v();_();var xt=c(F());b();v();_();var St=c(F());b();v();_();var j=c(F()),Ya=c(_e());var Wn=["LOG","INFO","WARNING","ERROR"],jn=["DEBUG","LOG","INFO","WARNING","ERROR"],Va=(0,j.kea)([(0,j.path)(["scenes","data-warehouse","settings","source","schemaLogLogic"]),(0,j.props)({}),(0,j.key)(({job:e})=>e.id),(0,j.connect)({values:[Na,["user"]]}),(0,j.actions)({clearBackgroundLogs:!0,setSearchTerm:e=>({searchTerm:e}),setSchema:e=>({schemaId:e}),markLogsEnd:!0}),(0,Ya.loaders)(({values:e,actions:t,cache:a,props:n})=>({logs:{__default:[],loadSchemaLogs:async()=>{let o=await S.externalDataSchemas.logs(n.job.schema.id,{level:e.levelFilters.join(","),search:e.searchTerm,instance_id:n.job.workflow_run_id});return a.pollingInterval||(a.pollingInterval=setInterval(t.loadSchemaLogsBackgroundPoll,2e3)),o.results},loadSchemaLogsMore:async()=>{if(!e.selectedSchemaId)return[];let o=await S.externalDataSchemas.logs(e.selectedSchemaId,{level:e.levelFilters.join(","),search:e.searchTerm,instance_id:n.job.workflow_run_id,before:e.leadingEntry?.timestamp});return o.results.length<ie&&t.markLogsEnd(),[...e.logs,...o.results]},revealBackground:()=>{let o=[...e.logsBackground,...e.logs];return t.clearBackgroundLogs(),o}},logsBackground:{__default:[],loadSchemaLogsBackgroundPoll:async()=>[...(await S.externalDataSchemas.logs(n.job.schema.id,{level:e.levelFilters.join(","),search:e.searchTerm,instance_id:n.job.workflow_run_id,after:e.leadingEntry?.timestamp})).results,...e.logsBackground]}})),(0,j.reducers)({searchTerm:["",{setSearchTerm:(e,{searchTerm:t})=>t}],selectedSchemaId:[null,{setSchema:(e,{schemaId:t})=>t}],isThereMoreToLoad:[!0,{loadSchemaLogsSuccess:(e,{logs:t})=>t.length>=ie,markLogsEnd:()=>!1}]}),(0,j.selectors)({leadingEntry:[e=>[e.logs,e.logsBackground],(e,t)=>t.length?t[0]:e.length?e[0]:null],levelFilters:[e=>[e.user],e=>e&&e.is_staff?jn:Wn]}),(0,j.listeners)(({actions:e})=>({setSearchTerm:async({searchTerm:t},a)=>{t&&await a(1e3),e.loadSchemaLogs()},setSchema:()=>{e.loadSchemaLogs()}})),(0,j.events)(({actions:e,cache:t})=>({afterMount:()=>{e.loadSchemaLogs()},beforeUnmount:()=>{clearInterval(t.pollingInterval)}}))]);var je=c(C()),Hn=[{title:"Timestamp",key:"timestamp",dataIndex:"timestamp",width:1,render:(e,t)=>(0,O.default)(t.timestamp).format("YYYY-MM-DD HH:mm:ss.SSS UTC")},{title:"Level",key:"level",dataIndex:"level",width:1,render:(e,t)=>ft(t.level)},{title:"Run ID",key:"run_id",dataIndex:"instance_id",width:1,render:(e,t)=>t.instance_id},{title:"Message",key:"message",dataIndex:"message",width:6}],za=({job:e})=>{let t=Va({job:e}),{logs:a,logsLoading:n,logsBackground:o,isThereMoreToLoad:l}=(0,St.useValues)(t),{revealBackground:i,loadSchemaLogsMore:p}=(0,St.useActions)(t);return(0,je.jsxs)("div",{className:"ph-no-capture space-y-2 flex-1",children:[(0,je.jsx)(x,{onClick:i,loading:n,type:"secondary",fullWidth:!0,center:!0,disabledReason:o.length?void 0:"There's nothing to load",children:o.length?`Load ${rt(o.length,"newer entry","newer entries")}`:"No new entries"}),(0,je.jsx)(ee,{dataSource:a,columns:Hn,loading:n,className:"ph-no-capture",pagination:{pageSize:200,hideOnSinglePage:!0}}),!!a.length&&(0,je.jsx)(x,{onClick:p,loading:n,type:"secondary",fullWidth:!0,center:!0,disabledReason:l?void 0:"There's nothing more to load",children:l?`Load up to ${ie} older entries`:"No older entries"})]})};var Re=c(C()),Un={Running:"primary",Completed:"success",Failed:"danger","Billing limits":"danger"},$a=({id:e})=>{let{jobs:t,jobsLoading:a,canLoadMoreJobs:n}=(0,xt.useValues)(se({id:e})),{loadMoreJobs:o}=(0,xt.useActions)(se({id:e}));return(0,Re.jsx)(ee,{hideScrollbar:!0,dataSource:t,loading:a,disableTableWhileLoading:!1,columns:[{title:"Schema",render:(l,i)=>i.schema.name},{title:"Status",render:(l,i)=>(0,Re.jsx)(lt,{type:Un[i.status],children:i.status})},{title:"Rows synced",render:(l,i)=>i.rows_synced.toLocaleString()},{title:"Synced at",render:(l,i)=>(0,Re.jsx)(q,{time:i.created_at,formatDate:"MMM\xA0DD,\xA0YYYY",formatTime:"HH:mm"})}],expandable:t.length>0?{expandedRowRender:l=>(0,Re.jsx)("div",{className:"p-4",children:(0,Re.jsx)(za,{job:l})}),rowExpandable:()=>!0,noIndent:!0}:void 0,footer:(0,Re.jsx)(x,{onClick:o,type:"secondary",fullWidth:!0,center:!0,disabledReason:n?void 0:"There's nothing more to load",children:n?"Load older jobs":"No older jobs"})})};b();v();_();var Et=c(F());b();v();_();var H=c(F()),Za=c(_e());var Qe=c(C()),Qa=["DEBUG","LOG","INFO","WARNING","ERROR"],Xn=["LOG","INFO","WARNING","ERROR"],en=(0,H.kea)([(0,H.props)({}),(0,H.key)(({id:e})=>e),(0,H.path)(e=>["scenes","pipeline","pipelineNodeLogsLogic",e]),(0,H.connect)(e=>({values:[de(),["currentTeamId"],Ce(e),["node"]]})),(0,H.actions)({setSelectedLogLevels:e=>({levels:e}),setSearchTerm:e=>({searchTerm:e}),setInstanceId:e=>({instanceId:e}),clearBackgroundLogs:!0,markLogsEnd:!0}),(0,Za.loaders)(({values:e,actions:t,cache:a})=>({logs:[[],{loadLogs:async()=>{let n=[],o={search:e.searchTerm,level:e.selectedLogLevelsForAPI.join(","),limit:ie,instance_id:e.instanceId??void 0};if(e.node.backend==="batch_export")n=(await S.batchExports.logs(e.node.id,o)).results;else if(e.node.backend==="hog_function")n=(await S.hogFunctions.logs(e.node.id,o)).results;else{if(e.node.backend==="managed_source")return[];n=await S.pluginConfigs.logs(Number(e.node.id),o)}return a.pollingInterval||(a.pollingInterval=setInterval(t.pollBackgroundLogs,5e3)),t.clearBackgroundLogs(),n},loadMoreLogs:async()=>{let n,o={search:e.searchTerm,level:e.selectedLogLevels.join(","),limit:ie,before:e.trailingEntry?.timestamp,instance_id:e.instanceId??void 0};if(e.node.backend==="batch_export")n=(await S.batchExports.logs(e.node.id,o)).results;else if(e.node.backend==="hog_function")n=(await S.hogFunctions.logs(e.node.id,o)).results;else{if(e.node.backend==="managed_source")return[];n=await S.pluginConfigs.logs(Number(e.node.id),o)}return n.length<ie&&t.markLogsEnd(),[...e.logs,...n]},revealBackground:()=>{let n=[...e.backgroundLogs,...e.logs];return t.clearBackgroundLogs(),n}}],backgroundLogs:[[],{pollBackgroundLogs:async()=>{if(e.logsLoading)return e.backgroundLogs;let n,o={search:e.searchTerm,level:e.selectedLogLevels.join(","),limit:ie,after:e.leadingEntry?.timestamp,instance_id:e.instanceId??void 0};if(e.node.backend==="batch_export")n=(await S.batchExports.logs(e.node.id,o)).results;else if(e.node.backend==="hog_function")n=(await S.hogFunctions.logs(e.node.id,o)).results;else{if(e.node.backend==="managed_source")return[];n=await S.pluginConfigs.logs(Number(e.node.id),o)}return[...n,...e.backgroundLogs]}}]})),(0,H.reducers)({selectedLogLevels:[Xn,{setSelectedLogLevels:(e,{levels:t})=>t}],backgroundLogs:[[],{clearBackgroundLogs:()=>[]}],searchTerm:["",{setSearchTerm:(e,{searchTerm:t})=>t}],instanceId:[null,{setInstanceId:(e,{instanceId:t})=>t}],isThereMoreToLoad:[!0,{loadLogsSuccess:(e,{logs:t})=>t.length>=ie,markLogsEnd:()=>!1}]}),(0,H.selectors)(({actions:e,values:t})=>({leadingEntry:[a=>[a.logs,a.backgroundLogs],(a,n)=>n.length?n[0]:a.length?a[0]:null],trailingEntry:[a=>[a.logs,a.backgroundLogs],(a,n)=>a.length?a[a.length-1]:n.length?n[n.length-1]:null],columns:[a=>[a.node],a=>[{title:"Timestamp",key:"timestamp",dataIndex:"timestamp",sorter:(n,o)=>(0,O.default)(n.timestamp).unix()-(0,O.default)(o.timestamp).unix(),render:n=>(0,Qe.jsx)(q,{time:n}),width:0},{width:0,title:a.backend=="hog_function"?"Invocation":a.backend=="batch_export"?"Run Id":"Source",dataIndex:"instance_id",key:"instance_id",render:n=>(0,Qe.jsx)("code",{className:"whitespace-nowrap",children:a.backend!=="plugin"?(0,Qe.jsx)(Ae,{subtle:!0,onClick:()=>{t.instanceId===n?e.setInstanceId(null):e.setInstanceId(n)},children:n}):n})},{width:100,title:"Level",key:"level",dataIndex:"level",render:ft},{title:"Message",key:"message",dataIndex:"message",render:n=>(0,Qe.jsx)("code",{className:"whitespace-pre-wrap",children:n})}]],selectedLogLevelsForAPI:[a=>[a.selectedLogLevels],a=>{let n=new Set(a);return n.has("WARN")&&n.add("WARNING"),n.has("WARNING")&&n.add("WARN"),Array.from(n)}]})),(0,H.listeners)(({actions:e})=>({setSelectedLogLevels:()=>{e.loadLogs()},setSearchTerm:async({searchTerm:t},a)=>{t&&await a(1e3),e.loadLogs()},setInstanceId:async()=>{e.loadLogs()}})),(0,H.events)(({actions:e,cache:t})=>({afterMount:()=>{e.loadLogs()},beforeUnmount:()=>{clearInterval(t.pollingInterval)}}))]);var ae=c(C());function tn({id:e,stage:t}){let a=en({id:e,stage:t}),{logs:n,logsLoading:o,backgroundLogs:l,columns:i,isThereMoreToLoad:p,selectedLogLevels:s,instanceId:k}=(0,Et.useValues)(a),{revealBackground:w,loadMoreLogs:d,setSelectedLogLevels:y,setSearchTerm:P,setInstanceId:T}=(0,Et.useActions)(a);return(0,ae.jsxs)("div",{className:"ph-no-capture space-y-2 flex-1",children:[(0,ae.jsx)(E,{type:"search",placeholder:"Search for messages containing\u2026",fullWidth:!0,onChange:P,allowClear:!0,prefix:(0,ae.jsxs)(ae.Fragment,{children:[(0,ae.jsx)(ia,{}),k&&(0,ae.jsx)(ua,{onClose:()=>T(null),children:k})]})}),(0,ae.jsxs)("div",{className:"flex items-center gap-4",children:[(0,ae.jsx)("span",{className:"mr-1",children:"Show logs of level:"}),Qa.map(W=>(0,ae.jsx)(Se,{label:W,checked:s.includes(W),onChange:ne=>{let Xe=ne?[...s,W]:s.filter(Ie=>Ie!=W);y(Xe)}},W))]}),(0,ae.jsx)(x,{onClick:w,loading:o,type:"secondary",fullWidth:!0,center:!0,disabledReason:l.length?void 0:"There's nothing to load",children:l.length?`Load ${rt(l.length,"newer entry","newer entries")}`:"No new entries"}),(0,ae.jsx)(ee,{dataSource:n,columns:i,loading:o,className:"ph-no-capture",rowKey:W=>`${W.log_source_id}:${W.instance_id}:${W.timestamp}`,pagination:{pageSize:200,hideOnSinglePage:!0}}),!!n.length&&(0,ae.jsx)(x,{onClick:d,loading:o,type:"secondary",fullWidth:!0,center:!0,disabledReason:p?void 0:"There's nothing more to load",children:p?`Load up to ${ie} older entries`:"No older entries"})]})}b();v();_();var He=c(F()),an=c(It());var ue=c(C()),nn=({id:e})=>{let{table:t}=(0,He.useValues)(yt({id:e})),{updateTable:a,editingTable:n}=(0,He.useActions)(yt({id:e}));return(0,ue.jsx)(He.BindLogic,{logic:yt,props:{id:e},children:(0,ue.jsx)(Gn,{table:t,updateTable:a,editingTable:n})})};function Gn({table:e,updateTable:t,editingTable:a}){return(0,ue.jsxs)(ue.Fragment,{children:[(0,ue.jsx)(pe,{buttons:(0,ue.jsx)(x,{type:"secondary",onClick:()=>{a(!1),an.router.actions.push(ce.pipeline())},children:"Cancel"})}),(0,ue.jsx)("div",{className:"space-y-4",children:(0,ue.jsx)(Da,{onUpdate:()=>t({name:e.name,url_pattern:e.url_pattern,format:e.format,...e.credential?.access_key||e.credential?.access_secret?{credential:{...e.credential.access_key?{access_key:e.credential.access_key}:{},...e.credential.access_secret?{access_secret:e.credential.access_secret}:{}}}:{}})})})]})}b();v();_();var pn=c(Qt()),be=c(F());b();v();_();var et=c(F()),dn=c(ve());b();v();_();var re=c(F()),cn=c(ve());b();v();_();var U=c(F()),sn=c(ve()),ln=c(_e()),Bt=c(It());function Ne(e){return{name:e.name,destination:e.destination.type,paused:e.paused,interval:e.interval,model:e.model,filters:e.filters,...e.destination.config}}function kt(e){return{name:bt(e),destination:e,model:"events",paused:!0,...e==="Snowflake"&&{authentication_type:"password"}}}function jt(e){return{type:"batch_export",id:"Events",name:"events",fields:{uuid:{name:"uuid",hogql_value:"toString(uuid)",type:"string",schema_valid:!0},timestamp:{name:"timestamp",hogql_value:"timestamp",type:"datetime",schema_valid:!0},event:{name:"event",hogql_value:"event",type:"string",schema_valid:!0},distinct_id:{name:"distinct_id",hogql_value:"toString(distinct_id)",type:"string",schema_valid:!0},properties:{name:"properties",hogql_value:"properties",type:"json",schema_valid:!0},...e=="S3"&&{person_id:{name:"person_id",hogql_value:"toString(person_id)",type:"string",schema_valid:!0},person_properties:{name:"person_properties",hogql_value:"nullIf(person_properties, '')",type:"string",schema_valid:!0},created_at:{name:"created_at",hogql_value:"created_at",type:"datetime",schema_valid:!0}},...e!="S3"&&{team_id:{name:"team_id",hogql_value:e=="Postgres"||e=="Redshift"?"toInt32(team_id)":"team_id",type:"integer",schema_valid:!0},set:{name:e=="Snowflake"?"people_set":"set",hogql_value:"nullIf(JSONExtractString(properties, '$set'), '')",type:"string",schema_valid:!0},set_once:{name:e=="Snowflake"?"people_set_once":"set_once",hogql_value:"nullIf(JSONExtractString(properties, '$set_once'), '')",type:"string",schema_valid:!0},site_url:{name:"site_url",hogql_value:"''",type:"string",schema_valid:!0},ip:{name:"ip",hogql_value:"nullIf(JSONExtractString(properties, '$ip'), '')",type:"string",schema_valid:!0},elements_chain:{name:"elements",hogql_value:"toJSONString(elements_chain)",type:"string",schema_valid:!0}},...e=="BigQuery"&&{bq_ingested_timestamp:{name:"bq_ingested_timestamp",hogql_value:"NOW64()",type:"datetime",schema_valid:!0}}}}}var Ht={type:"batch_export",id:"Persons",name:"persons",fields:{team_id:{name:"team_id",hogql_value:"team_id",type:"integer",schema_valid:!0},distinct_id:{name:"distinct_id",hogql_value:"distinct_id",type:"string",schema_valid:!0},person_id:{name:"person_id",hogql_value:"person_id",type:"string",schema_valid:!0},properties:{name:"properties",hogql_value:"properties",type:"json",schema_valid:!0},person_version:{name:"person_version",hogql_value:"person_version",type:"integer",schema_valid:!0},person_distinct_id_version:{name:"person_distinct_id_version",hogql_value:"person_distinct_id_version",type:"integer",schema_valid:!0},created_at:{name:"created_at",hogql_value:"created_at",type:"datetime",schema_valid:!0},is_deleted:{name:"is_deleted",hogql_value:"is_deleted",type:"boolean",schema_valid:!0}}},Ut={type:"batch_export",id:"Sessions",name:"sessions",fields:{team_id:{name:"team_id",hogql_value:"team_id",type:"integer",schema_valid:!0},session_id:{name:"session_id",type:"string",hogql_value:"session_id",schema_valid:!0},session_id_v7:{name:"session_id_v7",type:"integer",hogql_value:"session_id_v7",schema_valid:!0},distinct_id:{name:"distinct_id",type:"string",hogql_value:"distinct_id",schema_valid:!0},start_timestamp:{name:"start_timestamp",type:"datetime",hogql_value:"start_timestamp",schema_valid:!0},end_timestamp:{name:"end_timestamp",type:"datetime",hogql_value:"end_timestamp",schema_valid:!0},urls:{name:"urls",type:"array",hogql_value:"urls",schema_valid:!0},num_uniq_urls:{name:"num_uniq_urls",type:"integer",hogql_value:"num_uniq_urls",schema_valid:!0},entry_current_url:{name:"entry_current_url",type:"string",hogql_value:"entry_current_url",schema_valid:!0},entry_pathname:{name:"entry_pathname",type:"string",hogql_value:"entry_pathname",schema_valid:!0},entry_hostname:{name:"entry_hostname",type:"string",hogql_value:"entry_hostname",schema_valid:!0},end_current_url:{name:"end_current_url",type:"string",hogql_value:"end_current_url",schema_valid:!0},end_pathname:{name:"end_pathname",type:"string",hogql_value:"end_pathname",schema_valid:!0},end_hostname:{name:"end_hostname",type:"string",hogql_value:"end_hostname",schema_valid:!0},entry_utm_source:{name:"entry_utm_source",type:"string",hogql_value:"entry_utm_source",schema_valid:!0},entry_utm_campaign:{name:"entry_utm_campaign",type:"string",hogql_value:"entry_utm_campaign",schema_valid:!0},entry_utm_medium:{name:"entry_utm_medium",type:"string",hogql_value:"entry_utm_medium",schema_valid:!0},entry_utm_term:{name:"entry_utm_term",type:"string",hogql_value:"entry_utm_term",schema_valid:!0},entry_utm_content:{name:"entry_utm_content",type:"string",hogql_value:"entry_utm_content",schema_valid:!0},entry_referring_domain:{name:"entry_referring_domain",type:"string",hogql_value:"entry_referring_domain",schema_valid:!0},entry_gclid:{name:"entry_gclid",type:"string",hogql_value:"entry_gclid",schema_valid:!0},entry_fbclid:{name:"entry_fbclid",type:"string",hogql_value:"entry_fbclid",schema_valid:!0},entry_gad_source:{name:"entry_gad_source",type:"string",hogql_value:"entry_gad_source",schema_valid:!0},pageview_count:{name:"pageview_count",type:"integer",hogql_value:"pageview_count",schema_valid:!0},autocapture_count:{name:"autocapture_count",type:"integer",hogql_value:"autocapture_count",schema_valid:!0},screen_count:{name:"screen_count",type:"integer",hogql_value:"screen_count",schema_valid:!0},channel_type:{name:"channel_type",type:"string",hogql_value:"channel_type",schema_valid:!0},session_duration:{name:"session_duration",type:"integer",hogql_value:"session_duration",schema_valid:!0},duration:{name:"duration",type:"integer",hogql_value:"duration",schema_valid:!0},is_bounce:{name:"is_bounce",type:"boolean",hogql_value:"is_bounce",schema_valid:!0},last_external_click_url:{name:"last_external_click_url",type:"string",hogql_value:"last_external_click_url",schema_valid:!0},page_screen_autocapture_count_up_to:{name:"page_screen_autocapture_count_up_to",type:"string",hogql_value:"page_screen_autocapture_count_up_to",schema_valid:!0},exit_current_url:{name:"exit_current_url",type:"string",hogql_value:"exit_current_url",schema_valid:!0},exit_pathname:{name:"exit_pathname",type:"string",hogql_value:"exit_pathname",schema_valid:!0},vital_lcp:{name:"vital_lcp",type:"float",hogql_value:"vital_lcp",schema_valid:!0}}},ye=(0,U.kea)([(0,U.props)({}),(0,U.key)(({service:e,id:t})=>t?`ID:${t}`:`NEW:${e}`),(0,U.path)(e=>["scenes","pipeline","pipelineBatchExportConfigurationLogic",e]),(0,U.connect)(()=>({values:[he,["canEnableNewDestinations"]]})),(0,U.actions)({setSavedConfiguration:e=>({configuration:e}),setSelectedModel:e=>({model:e})}),(0,ln.loaders)(({props:e,actions:t})=>({batchExportConfig:[null,{loadBatchExportConfig:async()=>e.id?await S.batchExports.get(e.id):null,updateBatchExportConfig:async a=>{let{name:n,destination:o,interval:l,paused:i,created_at:p,start_at:s,end_at:k,model:w,filters:d,...y}=a,T={paused:i,name:n,interval:l,model:w,filters:d,destination:{type:o,config:y}};if(e.id){let ne=await S.batchExports.update(e.id,T);return N.success("Batch export configuration updated successfully"),ne}let W=await S.batchExports.create(T);return t.resetConfiguration(Ne(W)),Bt.router.actions.replace(ce.pipelineNode("destination",W.id,"configuration")),N.success("Batch export created successfully"),W}}]})),(0,U.reducers)(({props:e})=>({tables:[e.service?[jt(e.service),Ht,Ut]:[],{loadBatchExportConfigSuccess:(t,{batchExportConfig:a})=>a?[jt(a.destination.type),Ht,Ut]:t,updateBatchExportConfigSuccess:(t,{batchExportConfig:a})=>a?[jt(a.destination.type),Ht,Ut]:t}],selectedModel:["events",{setSelectedModel:(t,{model:a})=>a,loadBatchExportConfigSuccess:(t,{batchExportConfig:a})=>a?a.model:t,updateBatchExportConfigSuccess:(t,{batchExportConfig:a})=>a?a.model:t}],configuration:[e.service?kt(e.service):{},{loadBatchExportConfigSuccess:(t,{batchExportConfig:a})=>a?Ne(a):t,updateBatchExportConfigSuccess:(t,{batchExportConfig:a})=>a?Ne(a):t}],savedConfiguration:[{},{loadBatchExportConfigSuccess:(t,{batchExportConfig:a})=>a?Ne(a):t,updateBatchExportConfigSuccess:(t,{batchExportConfig:a})=>a?Ne(a):t}]})),(0,U.selectors)(()=>({service:[(e,t)=>[e.batchExportConfig,t.service],(e,t)=>e?.destination.type||t],isNew:[(e,t)=>[t.id],e=>!e],requiredFields:[e=>[e.service,e.isNew,e.configuration],(e,t,a)=>{let n=["interval","name","model"];return e==="Postgres"?[...n,...t?["user"]:[],...t?["password"]:[],"host","port","database","schema","table_name"]:e==="Redshift"?[...n,...t?["user"]:[],...t?["password"]:[],"host","port","database","schema","table_name"]:e==="S3"?[...n,"bucket_name","region","prefix",...t?["aws_access_key_id"]:[],...t?["aws_secret_access_key"]:[],...t?["file_format"]:[]]:e==="BigQuery"?[...n,...t?["json_config_file"]:[],"dataset_id","table_id"]:e==="HTTP"?[...n,"url","token"]:e==="Snowflake"?[...n,"account","database","warehouse",...t?["user"]:[],...t&&a.authentication_type=="password"?["password"]:[],...t&&a.authentication_type=="keypair"?["private_key"]:[],"schema","table_name"]:n}]})),(0,U.listeners)(({values:e,actions:t})=>({updateBatchExportConfigSuccess:({batchExportConfig:a})=>{a&&(t.resetConfiguration(Ne(a)),Ke.findMounted({types:gt})?.actions.updateBatchExportConfig(a))},setConfigurationValue:async({name:a,value:n})=>{if(a[0]==="json_config_file"&&n)try{let o=await new Promise((i,p)=>{let s=new FileReader;s.onload=k=>i(k.target?.result),s.onerror=k=>p(k),s.readAsText(n[0])}),l=JSON.parse(o);t.setConfigurationValues({...e.configuration,project_id:l.project_id,private_key:l.private_key,private_key_id:l.private_key_id,client_email:l.client_email,token_uri:l.token_uri})}catch{t.setConfigurationManualErrors({json_config_file:"The config file is not valid"})}}})),(0,sn.forms)(({asyncActions:e,values:t})=>({configuration:{errors:a=>Object.fromEntries(t.requiredFields.map(n=>[n,a[n]?void 0:"This field is required"])),submit:async a=>{await e.updateBatchExportConfig(a)}}})),(0,Bt.beforeUnload)(({actions:e,values:t})=>({enabled:()=>t.configurationChanged,message:`Leave action?
Changes you made will be discarded.`,onConfirm:()=>{t.batchExportConfig?e.resetConfiguration(Ne(t.batchExportConfig)):t.service?e.resetConfiguration(kt(t.service)):e.resetConfiguration()}})),(0,U.afterMount)(({actions:e})=>{e.loadBatchExportConfig()})]);var Pe=(0,re.kea)([(0,re.props)({}),(0,re.key)(({id:e})=>e),(0,re.path)(e=>["scenes","pipeline","batchExportBackfillModalLogic",e]),(0,re.connect)(e=>({values:[ye({id:e.id,service:null}),["batchExportConfig"]]})),(0,re.actions)({openBackfillModal:!0,closeBackfillModal:!0,setEarliestBackfill:!0,unsetEarliestBackfill:!0}),(0,re.reducers)({isBackfillModalOpen:[!1,{openBackfillModal:()=>!0,closeBackfillModal:()=>!1}],isEarliestBackfill:[!1,{setEarliestBackfill:()=>!0,unsetEarliestBackfill:()=>!1}]}),(0,cn.forms)(({props:e,actions:t,values:a})=>({backfillForm:{defaults:{start_at:void 0,end_at:(0,O.default)().tz(de.values.timezone).hour(0).minute(0).second(0).millisecond(0),earliest_backfill:!1},errors:({start_at:n,end_at:o,earliest_backfill:l})=>({start_at:n||l?void 0:"Start date is required",end_at:o?void 0:"End date is required",earliest_backfill:void 0}),submit:async({start_at:n,end_at:o,earliest_backfill:l})=>{if(a.batchExportConfig&&a.batchExportConfig.interval.endsWith("minutes")&&(n?.minute()!==void 0&&n?.minute()%5!==0||o?.minute()!==void 0&&o?.minute()%5!==0)){N.error("Backfilling a 5 minute batch export requires bounds be multiple of five minutes");return}let i=(0,O.default)().tz(de.values.timezone),p="1 hour";if(a.batchExportConfig&&o&&(a.batchExportConfig.interval=="hour"?i=i.add(1,"hour"):a.batchExportConfig.interval=="day"?(i=i.hour(0).minute(0).second(0),i=i.add(1,"day"),p="1 day"):a.batchExportConfig.interval.endsWith("minutes")?(i=i.add(5,"minute"),p="5 minutes"):i=i.add(1,"hour"),o>i)){N.error(`Requested backfill end date lies too far into the future. Use an end date that is no more than ${p} from now (in your project's timezone)`);return}await new Promise(s=>setTimeout(s,1e3)),await S.batchExports.createBackfill(e.id,{start_at:l?null:n?.toISOString()??null,end_at:o?.toISOString()??null}).catch(s=>{throw s.detail?t.setBackfillFormManualErrors({[s.attr??"start_at"]:s.detail}):N.error("Unknown error occurred"),s}),t.closeBackfillModal()}}}))]);var J=c(C());function wt({id:e}){let{timezone:t}=(0,et.useValues)(de),a=Pe({id:e}),{batchExportConfig:n,isBackfillModalOpen:o,isBackfillFormSubmitting:l,isEarliestBackfill:i}=(0,et.useValues)(a),{closeBackfillModal:p,setEarliestBackfill:s,unsetEarliestBackfill:k,setBackfillFormManualErrors:w}=(0,et.useActions)(a);return n?(0,J.jsxs)(Je,{title:"Start backfill",onClose:p,isOpen:o,width:"30rem",footer:(0,J.jsxs)(J.Fragment,{children:[(0,J.jsx)(x,{type:"secondary","data-attr":"batch-export-backfill-cancel",disabledReason:l?"Please wait...":void 0,onClick:p,children:"Cancel"}),(0,J.jsx)(x,{form:"batch-export-backfill-form",htmlType:"submit",type:"primary","data-attr":"batch-export-backfill-submit",loading:l,onClick:()=>w({}),children:"Schedule runs"})]}),children:[(0,J.jsxs)("p",{children:["Backfilling a batch export will sequentially run all batch periods that fall within the range specified below. The runs will export data in ",(0,J.jsx)("b",{children:n?.interval})," intervals, from the start date until the end date is reached."]}),(0,J.jsxs)(dn.Form,{logic:Pe,props:{id:e},formKey:"backfillForm",id:"batch-export-backfill-form",enableFormOnSubmit:!0,className:"space-y-2",children:[(0,J.jsx)(f,{name:"start_at",label:`Start Date (${t})`,className:"flex-1",children:({value:d,onChange:y})=>i?(0,J.jsx)(E,{value:"Beginning of time",disabled:!0}):(0,J.jsx)(ze,{value:d&&(n?n.interval==="day"?d.hour(0).minute(0).second(0):d.tz(t):d),onChange:P=>{if(P){let T=P.tz(t,!0);n&&n.interval==="day"&&(T=T.hour(0).minute(0).second(0)),y(T)}else y(P)},placeholder:"Select start date",granularity:n?n.interval==="hour"?"hour":n.interval.endsWith("minutes")?"minute":"day":"day"})}),n?.model=="persons"||n?.model=="sessions"?(0,J.jsx)(f,{name:"earliest_backfill",children:({onChange:d})=>(0,J.jsx)(Se,{bordered:!0,label:(0,J.jsxs)("span",{className:"flex items-center gap-2",children:["Backfill since beginning of time",(0,J.jsx)(V,{title:"If selected, we will backfill all data since the beginning of time until the end date set below. There is no need to set a start date for the backfill.",children:(0,J.jsx)(fe,{className:" text-lg text-secondary"})})]}),onChange:y=>{d(y),y?s():k()}})}):null,(0,J.jsx)(f,{name:"end_at",label:`End Date (${t})`,className:"flex-1",children:({value:d,onChange:y})=>(0,J.jsx)(ze,{value:d&&(n?n.interval==="day"?d.hour(0).minute(0).second(0):d.tz(t):d),onChange:P=>{if(P){let T=P.tz(t,!0);n&&n.interval==="day"&&(T=T.hour(0).minute(0).second(0)),y(T)}else y(P)},placeholder:"Select end date",granularity:n?n.interval==="hour"?"hour":n.interval.endsWith("minutes")?"minute":"day":"day"})})]})]}):(0,J.jsx)(Q,{object:"batch export"})}b();v();_();var $=c(F()),un=c(_e());var Ct=(0,$.kea)([(0,$.props)({}),(0,$.key)(({id:e})=>e),(0,$.path)(e=>["scenes","pipeline","batchExportBackfillsLogic",e]),(0,$.connect)(e=>({values:[de(),["currentTeamId"],ye({id:e.id,service:null}),["batchExportConfig"]],actions:[Pe(e),["submitBackfillFormSuccess","openBackfillModal"]]})),(0,$.actions)({loadBackfills:!0,cancelBackfill:e=>({backfill:e})}),(0,un.loaders)(({props:e,values:t})=>({backfillsPaginatedResponse:[null,{loadBackfills:async()=>{try{return await S.batchExports.listBackfills(e.id,{ordering:"-created_at"})}catch(a){throw N.error("Unknown error occurred when fetching backfills"),a}},loadOlderBackfills:async()=>{let a=t.backfillsPaginatedResponse?.next;if(!a)return t.backfillsPaginatedResponse;try{let n=await S.get(a);return n.results=[...t.backfillsPaginatedResponse?.results??[],...n.results],n}catch(n){throw N.error("Unknown error occurred when fetching backfills"),n}}}]})),(0,$.selectors)({hasMoreBackfillsToLoad:[e=>[e.backfillsPaginatedResponse],e=>!!e?.next],loading:[e=>[e.backfillsPaginatedResponseLoading],e=>e],latestBackfills:[e=>[e.backfillsPaginatedResponse],e=>(e?.results??[]).map(a=>{let n=o=>{if(!o)return;let l=(0,O.default)(o);return l.isValid()?l:void 0};return{...a,created_at:n(a.created_at),finished_at:n(a.finished_at),start_at:n(a.start_at),end_at:n(a.end_at),last_updated_at:n(a.last_updated_at)}})]}),(0,$.listeners)(({actions:e,props:t})=>({cancelBackfill:async({backfill:a})=>{try{await S.batchExports.cancelBackfill(t.id,a.id),N.success("Backfill has been cancelled."),e.loadBackfills()}catch{N.error("Failed to cancel backfill. Please try again.")}}})),(0,$.afterMount)(({actions:e})=>{e.loadBackfills()})]);var B=c(C());function gn({id:e}){let t=Ct({id:e}),{openBackfillModal:a}=(0,be.useActions)(t),{batchExportConfig:n}=(0,be.useValues)(t);return n?(0,B.jsxs)(B.Fragment,{children:[(0,B.jsx)(pe,{buttons:(0,B.jsx)(x,{type:"primary",onClick:()=>a(),children:"Start backfill"})}),(0,B.jsxs)("div",{className:"space-y-2",children:[(0,B.jsx)(Yn,{id:e}),(0,B.jsx)(Vn,{id:e})]}),(0,B.jsx)(wt,{id:e})]}):(0,B.jsx)(Q,{object:"batch export"})}function Yn({id:e}){let t=Ct({id:e}),{loading:a}=(0,be.useValues)(t),{loadBackfills:n}=(0,be.useActions)(t);return(0,B.jsx)("div",{className:"flex items-center gap-2",children:(0,B.jsx)(x,{onClick:n,loading:a,type:"secondary",icon:(0,B.jsx)(Ve,{}),size:"small",children:"Refresh"})})}function Vn({id:e}){let t=Ct({id:e}),{latestBackfills:a,loading:n,hasMoreBackfillsToLoad:o,batchExportConfig:l}=(0,be.useValues)(t),{cancelBackfill:i,loadOlderBackfills:p,openBackfillModal:s}=(0,be.useActions)(t),{canEnableNewDestinations:k}=(0,be.useValues)(he);return l?(0,B.jsx)(B.Fragment,{children:(0,B.jsx)(ee,{dataSource:a,loading:n,loadingSkeletonRows:5,footer:o&&(0,B.jsx)("div",{className:"flex items-center m-2",children:(0,B.jsx)(x,{center:!0,fullWidth:!0,onClick:p,loading:n,children:"Load more rows"})}),columns:[{title:"Status",key:"status",width:0,render:(w,d)=>{let y=d.status,P=mn(y);return(0,B.jsx)("span",{className:(0,pn.default)("h-6 p-2 border-2 flex items-center justify-center rounded-full font-semibold text-xs select-none",{success:"border-success text-success-dark","accent-primary":"border-accent-primary text-primary-dark",warning:"border-warning text-warning-dark",danger:"border-danger text-danger-dark",default:"border-default text-default-dark"}[P]),children:(0,B.jsx)("span",{className:"text-center",children:y})})}},{title:"Progress",key:"progress",render:(w,d)=>{let y=d.status,P=mn(y),T=d.progress;if(T&&T.progress!==null&&T.progress!==void 0){let W="";if(T.finished_runs!==null&&T.finished_runs!==void 0&&T.total_runs){let ne=T.total_runs===1?"run":"runs";W=`(${T.finished_runs}/${T.total_runs} ${ne})`}return(0,B.jsxs)("span",{className:"flex items-center gap-2",children:[(0,B.jsx)(Pa,{percent:T.progress*100,strokeColor:`var(--${P})`,className:"min-w-[80px]"}),(0,B.jsx)("span",{className:"whitespace-nowrap flex-shrink-0",children:W})]})}return""}},{title:"ID",key:"runId",render:(w,d)=>d.id},{title:"Interval start",key:"intervalStart",tooltip:"Start of the time range to backfill",render:(w,d)=>d.start_at?(0,B.jsx)(q,{time:d.start_at,formatDate:"MMMM\xA0DD,\xA0YYYY",formatTime:"HH:mm:ss"}):"Beginning of time"},{title:"Interval end",key:"intervalEnd",tooltip:"End of the time range to backfill",render:(w,d)=>d.end_at?(0,B.jsx)(q,{time:d.end_at,formatDate:"MMMM\xA0DD,\xA0YYYY",formatTime:"HH:mm:ss"}):"Until present"},{title:"Started",key:"started",tooltip:"Date and time when this BatchExport backfill started",render:(w,d)=>d.created_at?(0,B.jsx)(q,{time:d.created_at}):""},{title:"Finished",key:"finished",tooltip:"Date and time when this BatchExport backfill finished",render:(w,d)=>d.finished_at?(0,B.jsx)(q,{time:d.finished_at}):""},{key:"actions",width:0,render:function(d,y){if(k&&$n(y.status))return(0,B.jsx)("div",{className:"flex gap-1",children:(0,B.jsx)(zn,{backfill:y,cancelBackfill:i})})}}],emptyState:(0,B.jsxs)("div",{className:"space-y-2",children:[(0,B.jsx)("div",{children:"No backfills in this time range."}),k&&(0,B.jsx)(x,{type:"primary",onClick:()=>s(),children:"Start backfill"})]})})}):(0,B.jsx)(Q,{object:"batch export"})}function zn({backfill:e,cancelBackfill:t}){return(0,B.jsx)("span",{className:"flex items-center gap-1",children:(0,B.jsx)(x,{size:"small",type:"secondary",icon:(0,B.jsx)(st,{}),tooltip:"Cancel backfill",onClick:()=>we.open({title:"Cancel backfill?",description:(0,B.jsx)(B.Fragment,{children:(0,B.jsx)("p",{children:"This will cancel the selected backfill."})}),width:"20rem",primaryButton:{children:"Cancel backfill",onClick:()=>t(e)},secondaryButton:{children:"Go back"}})})})}var mn=e=>{switch(e){case"Completed":return"success";case"ContinuedAsNew":case"Running":case"Starting":return"accent-primary";case"Cancelled":case"Terminated":case"TimedOut":return"warning";case"Failed":case"FailedRetryable":return"danger";default:return"default"}},$n=e=>e==="Running"||e==="Starting";b();v();_();var yn=c(Qt()),me=c(F());b();v();_();var X=c(F()),hn=c(_e());var fn="-2d",tt=(0,X.kea)([(0,X.props)({}),(0,X.key)(({id:e})=>e),(0,X.path)(e=>["scenes","pipeline","batchExportRunsLogic",e]),(0,X.connect)(e=>({values:[ye({id:e.id,service:null}),["batchExportConfig"]],actions:[Pe(e),["submitBackfillFormSuccess","openBackfillModal"]]})),(0,X.actions)({setDateRange:(e,t)=>({from:e,to:t}),switchLatestRuns:e=>({enabled:e}),loadRuns:!0,retryRun:e=>({run:e}),cancelRun:e=>({run:e})}),(0,hn.loaders)(({props:e,values:t})=>({runsPaginatedResponse:[null,{loadRuns:async()=>t.usingLatestRuns?await S.batchExports.listRuns(e.id,{}):await S.batchExports.listRuns(e.id,{start:t.dateRange.from,end:t.dateRange.to,ordering:"-data_interval_start"}),loadOlderRuns:async()=>{let a=t.runsPaginatedResponse?.next;if(!a)return t.runsPaginatedResponse;let n=await S.get(a);return n.results=[...t.runsPaginatedResponse?.results??[],...n.results],n}}]})),(0,X.reducers)({dateRange:[{from:fn,to:null},{setDateRange:(e,{from:t,to:a})=>({from:t??fn,to:a})}],usingLatestRuns:[!0,{switchLatestRuns:(e,{enabled:t})=>t}]}),(0,X.selectors)({hasMoreRunsToLoad:[e=>[e.runsPaginatedResponse],e=>!!e?.next],loading:[e=>[e.runsPaginatedResponseLoading],e=>e],latestRuns:[e=>[e.runsPaginatedResponse],e=>(e?.results??[]).map(a=>({...a,created_at:(0,O.default)(a.created_at),data_interval_start:a.data_interval_start?(0,O.default)(a.data_interval_start):void 0,data_interval_end:(0,O.default)(a.data_interval_end),last_updated_at:a.last_updated_at?(0,O.default)(a.last_updated_at):void 0}))],groupedRuns:[e=>[e.runsPaginatedResponse,e.usingLatestRuns],(e,t)=>{if(t)return[];let a=e?.results??[],n={};return a.forEach(o=>{if(!o.data_interval_start)return;let l=`${o.data_interval_start}-${o.data_interval_end}`;n[l]||(n[l]={data_interval_start:(0,O.default)(o.data_interval_start),data_interval_end:(0,O.default)(o.data_interval_end),runs:[],last_run_at:(0,O.default)(o.created_at)}),n[l].runs.push({...o,created_at:(0,O.default)(o.created_at),data_interval_start:o.data_interval_start?(0,O.default)(o.data_interval_start):void 0,data_interval_end:(0,O.default)(o.data_interval_end),last_updated_at:o.last_updated_at?(0,O.default)(o.last_updated_at):void 0}),n[l].runs.sort((i,p)=>p.created_at.diff(i.created_at)),n[l].last_run_at=n[l].runs[0].created_at}),Object.values(n)}]}),(0,X.listeners)(({actions:e,props:t})=>({setDateRange:()=>{e.loadRuns()},switchLatestRuns:()=>{e.loadRuns()},retryRun:async({run:a})=>{await S.batchExports.retryRun(t.id,a.id),N.success("Retry has been scheduled.")},cancelRun:async({run:a})=>{await S.batchExports.cancelRun(t.id,a.id),N.success("Run has been cancelled.")},submitBackfillFormSuccess:()=>{e.loadRuns()}})),(0,X.afterMount)(({actions:e})=>{e.loadRuns()})]);var u=c(C());function bn({id:e}){let t=tt({id:e}),{batchExportConfig:a,groupedRuns:n,loading:o,hasMoreRunsToLoad:l,usingLatestRuns:i}=(0,me.useValues)(t),{loadOlderRuns:p,retryRun:s}=(0,me.useActions)(t);return a?(0,u.jsxs)(u.Fragment,{children:[(0,u.jsxs)("div",{className:"space-y-2",children:[(0,u.jsx)(Kn,{id:e}),i?(0,u.jsx)(Zn,{id:e}):(0,u.jsx)(Qn,{id:e,groupedRuns:n,loading:o,retryRun:s,hasMoreRunsToLoad:l,loadOlderRuns:p,interval:a.interval})]}),(0,u.jsx)(wt,{id:e})]}):(0,u.jsx)(Q,{object:"batch export"})}function Kn({id:e}){let t=tt({id:e}),{dateRange:a,usingLatestRuns:n,loading:o}=(0,me.useValues)(t),{setDateRange:l,switchLatestRuns:i,loadRuns:p}=(0,me.useActions)(t);return(0,u.jsxs)("div",{className:"flex items-center gap-2",children:[(0,u.jsx)(x,{onClick:p,loading:o,type:"secondary",icon:(0,u.jsx)(Ve,{}),size:"small",children:"Refresh"}),(0,u.jsx)(Le,{bordered:!0,label:"Show latest runs",checked:n,onChange:i,size:"small"}),(0,u.jsx)(We,{dateTo:a.to,dateFrom:a.from,disabledReason:n?'Turn off "Show latest runs" to filter by data interval':void 0,onChange:(s,k)=>l(s,k),allowedRollingDateOptions:["hours","days","weeks","months","years"],makeLabel:s=>(0,u.jsxs)(u.Fragment,{children:[(0,u.jsx)(Oe,{})," ",s]})})]})}function Zn({id:e}){let t=tt({id:e}),{batchExportConfig:a,latestRuns:n,loading:o,hasMoreRunsToLoad:l}=(0,me.useValues)(t),{openBackfillModal:i,loadOlderRuns:p,retryRun:s,cancelRun:k}=(0,me.useActions)(t),{canEnableNewDestinations:w}=(0,me.useValues)(he);return a?(0,u.jsx)(u.Fragment,{children:(0,u.jsx)(ee,{dataSource:n,loading:o,loadingSkeletonRows:5,footer:l&&(0,u.jsx)("div",{className:"flex items-center m-2",children:(0,u.jsx)(x,{center:!0,fullWidth:!0,onClick:p,loading:o,children:"Load more rows"})}),columns:[{title:"Status",key:"status",width:0,render:(d,y)=>(0,u.jsx)(Xt,{runs:[y],showLabel:!0})},{title:"ID",key:"runId",render:(d,y)=>y.id},{title:"Data interval start",key:"dataIntervalStart",tooltip:"Start of the time range to export",render:(d,y)=>y.data_interval_start?(0,u.jsx)(q,{time:y.data_interval_start,formatDate:"MMMM\xA0DD,\xA0YYYY",formatTime:"HH:mm:ss"}):"Beginning of time"},{title:"Data interval end",key:"dataIntervalEnd",tooltip:"End of the time range to export",render:(d,y)=>(0,u.jsx)(q,{time:y.data_interval_end,formatDate:"MMMM\xA0DD,\xA0YYYY",formatTime:"HH:mm:ss"})},{title:"Run start",key:"runStart",tooltip:"Date and time when this BatchExport run started",render:(d,y)=>(0,u.jsx)(q,{time:y.created_at})},{key:"actions",width:0,render:function(y,P){if(w)return(0,u.jsxs)("div",{className:"flex gap-1",children:[(0,u.jsx)(_n,{run:P,retryRun:s}),(0,u.jsx)(eo,{run:P,cancelRun:k})]})}}],emptyState:(0,u.jsxs)("div",{className:"space-y-2",children:[(0,u.jsxs)("div",{children:["No runs in this time range. Your exporter runs every ",(0,u.jsx)("b",{children:a.interval}),"."]}),w&&(0,u.jsx)(x,{type:"primary",onClick:()=>i(),children:"Start backfill"})]})})}):(0,u.jsx)(Q,{object:"batch export"})}function Qn({id:e,groupedRuns:t,loading:a,retryRun:n,hasMoreRunsToLoad:o,loadOlderRuns:l,interval:i}){let p=tt({id:e}),{canEnableNewDestinations:s}=(0,me.useValues)(he),{openBackfillModal:k}=(0,me.useActions)(p);return(0,u.jsx)(u.Fragment,{children:(0,u.jsx)(ee,{dataSource:t,loading:a,loadingSkeletonRows:5,footer:o&&(0,u.jsx)("div",{className:"flex items-center m-2",children:(0,u.jsx)(x,{center:!0,fullWidth:!0,onClick:l,loading:a,children:"Load more rows"})}),expandable:{noIndent:!0,expandedRowRender:w=>(0,u.jsx)(ee,{dataSource:w.runs,embedded:!0,columns:[{title:"Status",key:"status",width:0,render:(d,y)=>(0,u.jsx)(Xt,{runs:[y],showLabel:!0})},{title:"ID",key:"runId",render:(d,y)=>y.id},{title:"Run start",key:"runStart",tooltip:"Date and time when this BatchExport run started",render:(d,y)=>(0,u.jsx)(q,{time:y.created_at})}]})},columns:[{key:"icon",width:0,render:(w,d)=>(0,u.jsx)(Xt,{runs:d.runs})},{title:"Data interval start",key:"dataIntervalStart",tooltip:"Start of the time range to export",render:(w,d)=>d.data_interval_start?(0,u.jsx)(q,{time:d.data_interval_start,formatDate:"MMMM\xA0DD,\xA0YYYY",formatTime:"HH:mm:ss"}):"Beginning of time"},{title:"Data interval end",key:"dataIntervalEnd",tooltip:"End of the time range to export",render:(w,d)=>(0,u.jsx)(q,{time:d.data_interval_end,formatDate:"MMMM\xA0DD,\xA0YYYY",formatTime:"HH:mm:ss"})},{title:"Latest run start",key:"runStart",tooltip:"Date and time when this BatchExport run started",render:(w,d)=>(0,u.jsx)(q,{time:d.last_run_at})},{key:"actions",width:0,render:function(d,y){if(!La(y.runs[0])&&s)return(0,u.jsx)(_n,{run:y.runs[0],retryRun:n})}}],emptyState:(0,u.jsxs)("div",{className:"space-y-2",children:[(0,u.jsxs)("div",{children:["No runs in this time range. Your exporter runs every ",(0,u.jsx)("b",{children:i}),"."]}),s&&(0,u.jsx)(x,{type:"primary",onClick:()=>k(),children:"Start backfill"})]})})})}function _n({run:e,retryRun:t}){return(0,u.jsx)("span",{className:"flex items-center gap-1",children:(0,u.jsx)(x,{size:"small",type:"secondary",icon:(0,u.jsx)(Ve,{}),onClick:()=>we.open({title:"Retry export?",description:(0,u.jsxs)(u.Fragment,{children:[(0,u.jsx)("p",{children:"This will schedule a new run for the same interval. Any changes to the configuration will be applied to the new run."}),(0,u.jsxs)("p",{children:[(0,u.jsx)("b",{children:"Please note -"})," there may be a slight delay before the new run appears."]})]}),width:"20rem",primaryButton:{children:"Retry",onClick:()=>t(e)},secondaryButton:{children:"Cancel"}})})})}function eo({run:e,cancelRun:t}){return(0,u.jsx)("span",{className:"flex items-center gap-1",children:(0,u.jsx)(x,{size:"small",type:"secondary",icon:(0,u.jsx)(st,{}),disabledReason:e.status==="Running"||e.status==="Starting"?null:`Cannot cancel as run is '${e.status}'`,onClick:()=>we.open({title:"Cancel run?",description:(0,u.jsx)(u.Fragment,{children:(0,u.jsx)("p",{children:"This will cancel the selected backfill run."})}),width:"20rem",primaryButton:{children:"Cancel run",onClick:()=>t(e)},secondaryButton:{children:"Go back"}})})})}function Xt({runs:e,showLabel:t=!1}){let a=e[0],n=to(a.status),o=ao(n);return(0,u.jsx)(V,{title:(0,u.jsxs)(u.Fragment,{children:["Run status: ",n,e.length>1&&(0,u.jsxs)(u.Fragment,{children:[(0,u.jsx)("br",{}),"Attempts: ",e.length]})]}),children:(0,u.jsx)("span",{className:(0,yn.default)(`BatchExportRunIcon h-6 p-2 border-2 flex items-center justify-center rounded-full font-semibold text-xs border-${o} text-${o}-dark select-none`,o==="primary"&&"BatchExportRunIcon--pulse",t?"":"w-6"),children:t?(0,u.jsx)("span",{className:"text-center",children:n}):e.length})})}var to=e=>e==="FailedRetryable"?"Failed":e,ao=e=>{switch(e){case"Completed":return"success";case"ContinuedAsNew":case"Running":case"Starting":return"primary";case"Cancelled":case"Terminated":case"TimedOut":return"warning";case"Failed":case"FailedRetryable":return"danger";default:return"default"}};b();v();_();var Ee=c(F());var xe=c(Fe());var R=c(C()),no={succeeded:"Total number of events processed successfully",failed:"Total number of events that had errors during processing",filtered:"Total number of events that were filtered out",disabled_temporarily:"Total number of events that were skipped due to the destination being temporarily disabled (due to issues such as the destination being down or rate-limited)",disabled_permanently:"Total number of events that were skipped due to the destination being permanently disabled (due to prolonged issues with the destination)"};function vn({id:e}){let t=Ze({id:e}),{filters:a}=(0,Ee.useValues)(t),{setFilters:n,loadMetrics:o,loadMetricsTotals:l}=(0,Ee.useActions)(t);return(0,xe.useEffect)(()=>{o(),l()},[]),(0,R.jsx)(Ee.BindLogic,{logic:Ze,props:{id:e},children:(0,R.jsxs)("div",{className:"space-y-4",children:[(0,R.jsx)(ro,{}),(0,R.jsxs)("div",{className:"flex items-center gap-2",children:[(0,R.jsx)("h2",{className:"mb-0",children:"Delivery trends"}),(0,R.jsx)("div",{className:"flex-1"}),(0,R.jsx)(Z,{options:[{label:"Hourly",value:"hour"},{label:"Daily",value:"day"},{label:"Weekly",value:"week"}],size:"small",value:a.interval,onChange:i=>n({interval:i})}),(0,R.jsx)(We,{dateTo:a.before,dateFrom:a.after,onChange:(i,p)=>n({after:i||void 0,before:p||void 0}),allowedRollingDateOptions:["days","weeks","months","years"],makeLabel:i=>(0,R.jsxs)(R.Fragment,{children:[(0,R.jsx)(Oe,{})," ",i]})})]}),(0,R.jsx)(io,{})]})})}function oo({label:e,value:t,tooltip:a}){return(0,R.jsx)(V,{title:a,children:(0,R.jsxs)("div",{className:"border p-2 rounded bg-surface-primary flex-1 flex flex-col gap-2 items-center",children:[(0,R.jsx)("div",{className:"uppercase font-bold text-xs",children:e.replace(/_/g," ")}),(0,R.jsx)("div",{className:"text-2xl flex-1 mb-2 flex items-center",children:Ye(t??0)})]})})}function ro(){let{appMetricsTotals:e,appMetricsTotalsLoading:t}=(0,Ee.useValues)(Ze);return(0,R.jsx)("div",{className:"space-y-4",children:(0,R.jsx)("div",{className:"flex items-center gap-2 flex-wrap",children:Object.entries(no).map(([a,n])=>(0,R.jsx)("div",{className:"flex flex-col h-30 min-w-30 flex-1 max-w-100",children:t?(0,R.jsx)(oe,{className:"h-full w-full"}):(0,R.jsx)(oo,{label:a,value:e?.totals?.[a],tooltip:n})},a))})})}function io(){let{appMetrics:e,appMetricsLoading:t}=(0,Ee.useValues)(Ze),a=(0,xe.useRef)(null),[n,o]=(0,xe.useState)(null),[l,i]=(0,xe.useState)({x:0,y:0,visible:!1});return(0,xe.useEffect)(()=>{let p;if(a.current&&e&&!it())return p=new pt(a.current?.getContext("2d"),{type:"line",data:{labels:e.labels,datasets:[...e.series.map(s=>({label:s.name,data:s.values,borderColor:"",...so(s.name)}))]},options:{scales:{x:{ticks:{maxRotation:0},grid:{display:!1}},y:{beginAtZero:!0}},plugins:{crosshair:!1,legend:{display:!1},tooltip:{enabled:!1,external({tooltip:s,chart:k}){o((0,R.jsx)(ya,{embedded:!0,hideInspectActorsSection:!0,altTitle:s.dataPoints[0].label,seriesData:s.dataPoints.map((d,y)=>({id:y,dataIndex:0,datasetIndex:0,label:d.dataset.label,color:d.dataset.borderColor,count:d.dataset.data?.[d.dataIndex]||0})),renderSeries:d=>d,renderCount:d=>Ye(d)}));let w=k.canvas.getBoundingClientRect();i({x:w.left+s.caretX,y:w.top+s.caretY,visible:s.opacity>0})}}},maintainAspectRatio:!1,interaction:{mode:"index",axis:"x",intersect:!1}}}),()=>{p?.destroy()}},[e]),(0,R.jsxs)("div",{className:"relative border rounded p-6 bg-surface-primary h-[50vh]",children:[t&&(0,R.jsx)(qe,{}),!!e&&(0,R.jsx)("canvas",{ref:a}),(0,R.jsx)(sa,{visible:l.visible,overlay:n,placement:"top",padded:!1,className:"pointer-events-none",children:(0,R.jsx)("div",{className:"fixed",style:{left:l.x,top:l.y}})})]})}function so(e){let t="";switch(e){case"succeeded":t=Me("success");break;case"failed":t=Me("danger");break;default:t=Me("data-color-1");break}return{borderColor:t,hoverBorderColor:t,hoverBackgroundColor:t,backgroundColor:t,fill:!1,borderWidth:2,pointRadius:0}}b();v();_();var Pn=c(F());b();v();_();var at=c(F()),xn=c(ve());b();v();_();var r=c(C());function Ln({isNew:e,isPipeline:t=!1,batchExportConfigForm:a}){return(0,r.jsx)(r.Fragment,{children:(0,r.jsxs)("div",{className:"space-y-4",children:[!t&&(0,r.jsx)(f,{name:"name",label:"Name",children:(0,r.jsx)(E,{placeholder:"Name your workflow for future reference"})}),(0,r.jsx)("div",{className:"flex gap-2 items-start flex-wrap",children:(!t||a.end_at)&&(0,r.jsx)(f,{name:"end_at",label:"End date",className:"flex-1",info:(0,r.jsx)(r.Fragment,{children:"The date up to which data is to be exported. Leaving it unset implies that data exports will continue forever until this export is paused or deleted."}),children:({value:n,onChange:o})=>(0,r.jsx)(ze,{value:n,onChange:o,placeholder:"Select end date (optional)",clearable:!0})})}),e&&!t?(0,r.jsx)(f,{name:"paused",children:(0,r.jsx)(Se,{bordered:!0,label:(0,r.jsxs)("span",{className:"flex items-center gap-2",children:["Create in paused state",(0,r.jsx)(V,{title:"If selected, the Batch Exporter will be created but will be 'paused' allowing you to resumed it at a later date.",children:(0,r.jsx)(fe,{className:" text-lg text-secondary"})})]})})}):null]})})}function Sn({isNew:e,batchExportConfigForm:t}){return(0,r.jsx)(r.Fragment,{children:(0,r.jsx)("div",{className:"space-y-4 max-w-200 mt-4",children:t.destination==="S3"?(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)("div",{className:"flex gap-4",children:[(0,r.jsx)(f,{name:"bucket_name",label:"Bucket",className:"flex-1",children:(0,r.jsx)(E,{placeholder:"e.g. my-bucket"})}),(0,r.jsx)(f,{name:"region",label:"Region",className:"flex-1",children:(0,r.jsx)(Z,{options:[{value:"us-east-1",label:"US East (N. Virginia)"},{value:"us-east-2",label:"US East (Ohio)"},{value:"us-west-1",label:"US West (N. California)"},{value:"us-west-2",label:"US West (Oregon)"},{value:"af-south-1",label:"Africa (Cape Town)"},{value:"ap-east-1",label:"Asia Pacific (Hong Kong)"},{value:"ap-south-1",label:"Asia Pacific (Mumbai)"},{value:"ap-northeast-3",label:"Asia Pacific (Osaka-Local)"},{value:"ap-northeast-2",label:"Asia Pacific (Seoul)"},{value:"ap-southeast-1",label:"Asia Pacific (Singapore)"},{value:"ap-southeast-2",label:"Asia Pacific (Sydney)"},{value:"ap-northeast-1",label:"Asia Pacific (Tokyo)"},{value:"ca-central-1",label:"Canada (Central)"},{value:"cn-north-1",label:"China (Beijing)"},{value:"cn-northwest-1",label:"China (Ningxia)"},{value:"eu-central-1",label:"Europe (Frankfurt)"},{value:"eu-west-1",label:"Europe (Ireland)"},{value:"eu-west-2",label:"Europe (London)"},{value:"eu-south-1",label:"Europe (Milan)"},{value:"eu-west-3",label:"Europe (Paris)"},{value:"eu-north-1",label:"Europe (Stockholm)"},{value:"me-south-1",label:"Middle East (Bahrain)"},{value:"sa-east-1",label:"South America (S\xE3o Paulo)"},{value:"auto",label:"Automatic (AUTO)"},{value:"apac",label:"Asia Pacific (APAC)"},{value:"eeur",label:"Eastern Europe (EEUR)"},{value:"enam",label:"Eastern North America (ENAM)"},{value:"weur",label:"Western Europe (WEUR)"},{value:"wnam",label:"Western North America (WNAM)"}]})})]}),(0,r.jsx)(f,{name:"prefix",label:"Key prefix",children:(0,r.jsx)(E,{placeholder:"e.g. posthog-events/"})}),(0,r.jsxs)("div",{className:"flex gap-4",children:[(0,r.jsx)(f,{name:"file_format",label:"Format",className:"flex-1",children:(0,r.jsx)(Z,{options:[{value:"JSONLines",label:"JSON lines"},{value:"Parquet",label:"Apache Parquet"}]})}),(0,r.jsx)(f,{name:"max_file_size_mb",label:"Max file size (MiB)",showOptional:!0,className:"flex-1",info:(0,r.jsx)(r.Fragment,{children:"Files over this max file size will be split into multiple files. Leave empty or set to 0 for no splitting regardless of file size"}),children:(0,r.jsx)(E,{type:"number",min:0})})]}),(0,r.jsxs)("div",{className:"flex gap-4",children:[(0,r.jsx)(f,{name:"compression",label:"Compression",className:"flex-1",children:(0,r.jsx)(Z,{options:[{value:"gzip",label:"gzip"},{value:"brotli",label:"brotli"},{value:null,label:"No compression"}]})}),(0,r.jsx)(f,{name:"encryption",label:"Encryption",className:"flex-1",children:(0,r.jsx)(Z,{options:[{value:"AES256",label:"AES256"},{value:"aws:kms",label:"aws:kms"},{value:null,label:"No encryption"}]})})]}),(0,r.jsxs)("div",{className:"flex gap-4",children:[(0,r.jsx)(f,{name:"aws_access_key_id",label:"AWS Access Key ID",className:"flex-1",children:(0,r.jsx)(E,{placeholder:e?"e.g. AKIAIOSFODNN7EXAMPLE":"Leave unchanged"})}),(0,r.jsx)(f,{name:"aws_secret_access_key",label:"AWS Secret Access Key",className:"flex-1",children:(0,r.jsx)(E,{placeholder:e?"e.g. secret-key":"Leave unchanged",type:"password"})}),t.encryption=="aws:kms"&&(0,r.jsx)(f,{name:"kms_key_id",label:"AWS KMS Key ID",className:"flex-1",children:(0,r.jsx)(E,{placeholder:e?"e.g. 1234abcd-12ab-34cd-56ef-1234567890ab":"leave unchanged"})})]}),(0,r.jsx)(f,{name:"endpoint_url",label:"Endpoint URL",showOptional:!0,info:(0,r.jsx)(r.Fragment,{children:"Only required if exporting to an S3-compatible blob storage (like MinIO)"}),children:(0,r.jsx)(E,{placeholder:e?"e.g. https://your-minio-host:9000":"Leave unchanged"})})]}):t.destination==="Snowflake"?(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(f,{name:"account",label:"Account",children:(0,r.jsx)(E,{placeholder:"my-account"})}),(0,r.jsx)(f,{name:"user",label:"User",children:(0,r.jsx)(E,{placeholder:e?"my-user":"Leave unchanged"})}),(0,r.jsx)(f,{name:"authentication_type",label:"Authentication type",className:"flex-1",children:(0,r.jsx)(Z,{options:[{value:"password",label:"Password"},{value:"keypair",label:"Key pair"}]})}),t.authentication_type!="keypair"&&(0,r.jsx)(f,{name:"password",label:"Password",children:(0,r.jsx)(E,{placeholder:e?"my-password":"Leave unchanged",type:"password"})}),t.authentication_type=="keypair"&&(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(f,{name:"private_key",label:"Private key",children:(0,r.jsx)(dt,{className:"ph-ignore-input",placeholder:e?"my-private-key":"Leave unchanged",minRows:4})}),(0,r.jsx)(f,{name:"private_key_passphrase",label:"Private key passphrase",children:(0,r.jsx)(E,{placeholder:e?"my-passphrase":"Leave unchanged"})})]}),(0,r.jsx)(f,{name:"database",label:"Database",children:(0,r.jsx)(E,{placeholder:"my-database"})}),(0,r.jsx)(f,{name:"warehouse",label:"Warehouse",children:(0,r.jsx)(E,{placeholder:"my-warehouse"})}),(0,r.jsx)(f,{name:"schema",label:"Schema",children:(0,r.jsx)(E,{placeholder:"my-schema"})}),(0,r.jsx)(f,{name:"table_name",label:"Table name",children:(0,r.jsx)(E,{placeholder:"events"})}),(0,r.jsx)(f,{name:"role",label:"Role",showOptional:!0,children:(0,r.jsx)(E,{placeholder:"my-role"})})]}):t.destination==="Postgres"?(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(f,{name:"user",label:"User",children:(0,r.jsx)(E,{placeholder:e?"my-user":"Leave unchanged"})}),(0,r.jsx)(f,{name:"password",label:"Password",children:(0,r.jsx)(E,{placeholder:e?"my-password":"Leave unchanged",type:"password"})}),(0,r.jsx)(f,{name:"host",label:"Host",children:(0,r.jsx)(E,{placeholder:"my-host"})}),(0,r.jsx)(f,{name:"port",label:"Port",children:(0,r.jsx)(E,{placeholder:"5432",type:"number",min:"0",max:"65535"})}),(0,r.jsx)(f,{name:"database",label:"Database",children:(0,r.jsx)(E,{placeholder:"my-database"})}),(0,r.jsx)(f,{name:"schema",label:"Schema",children:(0,r.jsx)(E,{placeholder:"public"})}),(0,r.jsx)(f,{name:"table_name",label:"Table name",children:(0,r.jsx)(E,{placeholder:"events"})}),(0,r.jsx)(f,{name:"has_self_signed_cert",children:({value:a,onChange:n})=>(0,r.jsx)(Se,{bordered:!0,label:(0,r.jsxs)("span",{className:"flex items-center gap-2",children:["Does your Postgres instance have a self-signed SSL certificate?",(0,r.jsx)(V,{title:"In most cases, Heroku and RDS users should check this.",children:(0,r.jsx)(fe,{className:" text-lg text-secondary"})})]}),checked:!!a,onChange:n})})]}):t.destination==="Redshift"?(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(f,{name:"user",label:"User",children:(0,r.jsx)(E,{placeholder:e?"my-user":"Leave unchanged"})}),(0,r.jsx)(f,{name:"password",label:"Password",children:(0,r.jsx)(E,{placeholder:e?"my-password":"Leave unchanged",type:"password"})}),(0,r.jsx)(f,{name:"host",label:"Host",children:(0,r.jsx)(E,{placeholder:"my-host"})}),(0,r.jsx)(f,{name:"port",label:"Port",children:(0,r.jsx)(E,{placeholder:"5439",type:"number",min:"0",max:"65535"})}),(0,r.jsx)(f,{name:"database",label:"Database",children:(0,r.jsx)(E,{placeholder:"my-database"})}),(0,r.jsx)(f,{name:"schema",label:"Schema",children:(0,r.jsx)(E,{placeholder:"public"})}),(0,r.jsx)(f,{name:"table_name",label:"Table name",children:(0,r.jsx)(E,{placeholder:"events"})}),(0,r.jsx)(f,{name:"properties_data_type",label:"Properties data type",children:(0,r.jsx)(Z,{options:[{value:"varchar",label:"VARCHAR(65535)"},{value:"super",label:"SUPER"}]})})]}):t.destination==="BigQuery"?(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(f,{name:"json_config_file",label:"Google Cloud JSON key file",children:(0,r.jsx)(ct,{accept:".json",multiple:!1})}),(0,r.jsx)(f,{name:"table_id",label:"Table ID",children:(0,r.jsx)(E,{placeholder:"events"})}),(0,r.jsx)(f,{name:"dataset_id",label:"Dataset ID",children:(0,r.jsx)(E,{placeholder:"dataset"})}),e?(0,r.jsx)(f,{name:"use_json_type",label:"Structured fields data type",children:(0,r.jsx)(Se,{bordered:!0,label:(0,r.jsxs)("span",{className:"flex items-center gap-2",children:["Export 'properties', 'set', and 'set_once' fields as BigQuery JSON type",(0,r.jsx)(V,{title:"If left unchecked, these fields will be sent as STRING type. This setting cannot be changed after batch export is created.",children:(0,r.jsx)(fe,{className:" text-lg text-secondary"})})]})})}):null]}):t.destination==="HTTP"?(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(f,{name:"url",label:"PostHog region",children:(0,r.jsx)(Z,{options:[{value:"https://us.i.posthog.com/batch/",label:"US"},{value:"https://eu.i.posthog.com/batch/",label:"EU"}]})}),(0,r.jsx)(f,{name:"token",label:"Destination project API Key",children:(0,r.jsx)(E,{placeholder:"e.g. phc_12345..."})})]}):null})})}var g=c(C());function En({service:e,id:t}){let a={service:e||null,id:t||null},n=ye(a),{isNew:o,configuration:l,tables:i,savedConfiguration:p,isConfigurationSubmitting:s,batchExportConfigLoading:k,configurationChanged:w,batchExportConfig:d,selectedModel:y}=(0,at.useValues)(n),{resetConfiguration:P,submitConfiguration:T,setSelectedModel:W,setConfigurationValue:ne}=(0,at.useActions)(n),{featureFlags:Xe}=(0,at.useValues)(De),Ie=Xe[Be.HIGH_FREQUENCY_BATCH_EXPORTS],ot=Xe[Be.SESSIONS_BATCH_EXPORTS];if(e&&!Kt.includes(e))return(0,g.jsx)(Q,{object:`batch export service ${e}`});if(!d&&k)return(0,g.jsx)(qe,{});let I=(0,g.jsxs)(g.Fragment,{children:[(0,g.jsx)(x,{type:"secondary",htmlType:"reset",onClick:()=>P(o&&e?kt(e):p),disabledReason:w?s?"Saving in progress\u2026":void 0:"No changes",children:o?"Reset":"Cancel"}),(0,g.jsx)(x,{type:"primary",htmlType:"submit",onClick:T,loading:s,disabledReason:w?s?"Saving in progress\u2026":void 0:"No changes to save",children:o?"Create":"Save"})]});return(0,g.jsx)("div",{className:"space-y-3",children:(0,g.jsxs)(g.Fragment,{children:[(0,g.jsx)(pe,{buttons:I}),(0,g.jsxs)(xn.Form,{logic:ye,props:a,formKey:"configuration",className:"space-y-3",children:[(0,g.jsxs)("div",{className:"flex items-start gap-4 flex-wrap",children:[(0,g.jsxs)("div",{className:"flex flex-col flex-1 min-w-100 space-y-3",children:[(0,g.jsxs)("div",{className:"border bg-surface-primary p-3 rounded space-y-2",children:[(0,g.jsxs)("div",{className:"flex flex-row gap-2 min-h-16 items-center",children:[l.destination?(0,g.jsxs)(g.Fragment,{children:[(0,g.jsx)(va,{size:"medium",type:l.destination}),(0,g.jsx)("div",{className:"flex-1 font-semibold text-sm",children:bt(l.destination)})]}):(0,g.jsx)("div",{className:"flex-1"}),(0,g.jsx)(f,{name:"paused",info:"Start in a paused state or continuously exporting from now",children:({value:Y,onChange:Ge})=>(0,g.jsx)(Le,{label:"Enabled",onChange:()=>Ge(!Y),checked:!Y,bordered:!0})})]}),(0,g.jsx)(f,{name:"name",label:"Name",info:"Customizing the name can be useful if multiple instances of the same type are used.",children:(0,g.jsx)(E,{type:"text"})}),(0,g.jsx)("div",{className:"flex gap-2 min-h-16",children:(0,g.jsx)(f,{name:"interval",label:"Interval",className:"flex-1",info:(0,g.jsx)(g.Fragment,{children:"Dictates the frequency of batch export runs. For example, if you select hourly, a new batch export run will start every hour."}),children:(0,g.jsx)(Z,{options:[{value:"hour",label:"Hourly"},{value:"day",label:"Daily"},{value:"every 5 minutes",label:"Every 5 minutes",hidden:!Ie}]})})})]}),(0,g.jsxs)("div",{className:"border bg-surface-primary p-3 rounded space-y-2",children:[(0,g.jsx)("div",{className:"flex gap-2 min-h-16",children:(0,g.jsx)(f,{name:"model",label:"Model",info:"A model defines the data that will be exported.",className:"flex flex-1",children:(0,g.jsx)(Z,{options:i.map(Y=>({value:Y.name,label:Y.id,hidden:!ot&&Y.name==="sessions"})),value:y,onSelect:Y=>{W(Y)},fullWidth:!0})})}),(0,g.jsx)("div",{className:"flex gap-2",children:(0,g.jsx)(da,{className:"flex flex-1",panels:[{key:"schema",header:"View model schema",content:(0,g.jsx)("div",{className:"flex-1",children:(0,g.jsx)(Ea,{table:y||"events",tables:i,inEditSchemaMode:!1})})}]})}),y==="events"?(0,g.jsxs)(g.Fragment,{children:[(0,g.jsxs)("div",{className:"flex flex-col gap-2 min-h-16",children:[(0,g.jsx)("div",{className:"flex justify-between w-full gap-2",children:(0,g.jsx)($e,{children:"Include events"})}),(0,g.jsxs)("p",{className:"mb-0 text-xs text-secondary",children:["If set, the batch export will ",(0,g.jsx)("b",{children:"only"})," export events matching any of the below. If left unset, all events will be exported."]}),(0,g.jsx)(Jt,{onChange:Y=>{let Ge=Y.filter(Nt=>Nt!=null);ne("include_events",Ge)},selectedEvents:l.include_events?l.include_events:[],addElement:(0,g.jsx)(x,{size:"small",type:"secondary",icon:(0,g.jsx)(Mt,{}),sideIcon:null,children:"Include event"})})]}),(0,g.jsxs)("div",{className:"flex flex-col gap-2 min-h-16",children:[(0,g.jsx)("div",{className:"flex justify-between w-full gap-2",children:(0,g.jsx)($e,{children:"Exclude events"})}),(0,g.jsxs)("p",{className:"mb-0 text-xs text-secondary",children:["If set, the batch export will ",(0,g.jsx)("b",{children:"exclude"})," events matching any of the below. If left unset, no events will be excluded from the export."]}),(0,g.jsx)(Jt,{onChange:Y=>{let Ge=Y.filter(Nt=>Nt!=null);ne("exclude_events",Ge)},selectedEvents:l.exclude_events?l.exclude_events:[],addElement:(0,g.jsx)(x,{size:"small",type:"secondary",icon:(0,g.jsx)(Mt,{}),sideIcon:null,children:"Exclude event"})})]}),(0,g.jsx)("div",{className:"flex gap-2 min-h-16",children:(0,g.jsx)(f,{name:"filters",label:"Filters",className:"flex flex-1",children:(0,g.jsx)(ha,{propertyFilters:l.filters?l.filters:[],taxonomicGroupTypes:y==="events"?["event_properties"]:["person_properties"],onChange:Y=>{ne("filters",Y)},pageKey:`BatchExportsPropertyFilters.${d?d.id:"New"}`,metadataSource:{kind:"ActorsQuery"}})})})]}):null]})]}),(0,g.jsx)("div",{className:"flex-2 gap-4 space-y-4 min-w-100",children:(0,g.jsx)("div",{className:"border bg-surface-primary p-3 rounded",children:(0,g.jsx)(lo,{isNew:o,formValues:l})})})]}),(0,g.jsx)("div",{className:"flex gap-2 justify-end",children:I})]})]})})}function lo({isNew:e,formValues:t}){return(0,g.jsxs)(g.Fragment,{children:[(0,g.jsx)(Ln,{isNew:e,isPipeline:!0,batchExportConfigForm:t}),(0,g.jsx)(Sn,{isNew:e,batchExportConfigForm:t})]})}b();v();_();var Tt=c(F()),Cn=c(ve());var Tn=c(Fe()),Rn=c(Fe());b();v();_();var K=c(F()),Bn=c(ve()),wn=c(_e()),nt=c(It());function Gt(e){return{...e.config,enabled:e.enabled,order:e.order,name:e.name?e.name:e.plugin_info.name,description:e.description?e.description:e.plugin_info.description||""}}function kn(e){return{...Ot(e),enabled:!1,name:e.name,description:e.description}}var Yt=(0,K.kea)([(0,K.props)({}),(0,K.key)(({pluginId:e,pluginConfigId:t})=>t?`ID:${t}`:`NEW:${e}`),(0,K.path)(e=>["scenes","pipeline","pipelinePluginConfigurationLogic",e]),(0,K.connect)(()=>({values:[de,["currentTeamId"],Wt,["plugins as transformationPlugins","nextAvailableOrder"],De,["featureFlags"],he,["canEnableNewDestinations"]]})),(0,wn.loaders)(({props:e,values:t})=>({pluginFromPluginId:[null,{loadPlugin:async()=>{if(!e.pluginId)return null;let a={};return e.stage==="transformation"?a=await Dt("api/organizations/@current/pipeline_transformations"):e.stage==="destination"&&(a=await Dt("api/organizations/@current/pipeline_destinations")),a[e.pluginId]||S.get(`api/organizations/@current/plugins/${e.pluginId}`)}}],pluginConfig:[null,{loadPluginConfig:async()=>e.pluginConfigId?await S.pluginConfigs.get(e.pluginConfigId):null,updatePluginConfig:async a=>{if(!t.plugin||!e.stage)return null;if((!t.pluginConfig||!t.pluginConfig.enabled&&a.enabled)&&e.stage==="destination"&&!t.canEnableNewDestinations)return N.error("Data pipelines add-on is required for enabling new destinations."),t.pluginConfig;let{enabled:n,order:o,name:l,description:i,...p}=a,s=Ba(t.plugin.config_schema,Ot(t.plugin),p);s.append("enabled",n),s.append("name",l),s.append("description",i);let k=n&&t.pluginConfig&&!t.pluginConfig.enabled?t.nextAvailableOrder:o||0;if(s.append("order",k),e.pluginConfigId)return await S.pluginConfigs.update(e.pluginConfigId,s);s.append("plugin",t.plugin.id.toString());let w=await S.pluginConfigs.create(s);return nt.router.actions.replace(ce.pipelineNode(e.stage,w.id,"configuration")),w},migrateToHogFunction:async()=>{if(!e.pluginConfigId)return null;let a=await S.pluginConfigs.migrate(e.pluginConfigId);return nt.router.actions.replace(ce.pipelineNode("destination",`hog-${a.id}`)),t.pluginConfig}}]})),(0,K.listeners)(({props:e,actions:t,values:a})=>({updatePluginConfigSuccess:({pluginConfig:n})=>{n&&(t.resetConfiguration(a.configuration),e.stage==="transformation"?Wt.findMounted()?.actions.updatePluginConfig(n):e.stage==="destination"?Ke.findMounted({types:gt})?.actions.updatePluginConfig(n):e.stage==="site-app"?!!a.featureFlags[Be.SITE_APP_FUNCTIONS]?Ke.findMounted({types:ba})?.actions.updatePluginConfig(n):Aa.findMounted()?.actions.updatePluginConfig(n):e.stage==="legacy-source"&&Oa.findMounted()?.actions.updatePluginConfig(n))}})),(0,K.reducers)(()=>({configuration:[{},{loadPluginSuccess:(e,{pluginFromPluginId:t})=>Object.keys(e).length>0||!t?e:kn(t),loadPluginConfigSuccess:(e,{pluginConfig:t})=>t?Gt(t):e,updatePluginConfigSuccess:(e,{pluginConfig:t})=>t?Gt(t):e}]})),(0,K.selectors)(()=>({plugin:[e=>[e.pluginFromPluginId,e.pluginConfig],(e,t)=>t?.plugin_info||e],loading:[e=>[e.pluginFromPluginIdLoading,e.pluginConfigLoading],(e,t)=>e||t],savedConfiguration:[e=>[e.pluginConfig,e.plugin],(e,t)=>{if(!e||!t)return{};if(e)return Gt(e);if(t)return kn(t)}],requiredFields:[e=>[e.plugin,e.configuration],(e,t)=>!e||!t?[]:Ca(a=>t[a],e)],hiddenFields:[e=>[e.plugin,e.configuration],(e,t)=>!e||!t?[]:wa(a=>t[a],e)],isNew:[(e,t)=>[t.pluginConfigId],e=>!e],stage:[(e,t)=>[t.stage],e=>e]})),(0,Bn.forms)(({asyncActions:e,values:t})=>({configuration:{errors:a=>Object.fromEntries(t.requiredFields.map(n=>[n,a[n]?void 0:"This field is required"])),submit:async a=>{await e.updatePluginConfig(a)}}})),(0,nt.beforeUnload)(({actions:e,values:t})=>({enabled:()=>t.configurationChanged,message:`Leave action?
Changes you made will be discarded.`,onConfirm:()=>{e.resetConfiguration()}})),(0,K.afterMount)(({props:e,actions:t})=>{e.pluginConfigId?t.loadPluginConfig():e.pluginId&&t.loadPlugin()})]);var h=c(C());function Nn({stage:e,pluginId:t,pluginConfigId:a}){let n={stage:e,pluginId:t||null,pluginConfigId:a||null},o=Yt(n),{plugin:l,isNew:i,isConfigurationSubmitting:p,savedConfiguration:s,hiddenFields:k,requiredFields:w,loading:d,configurationChanged:y}=(0,Tt.useValues)(o),{submitConfiguration:P,resetConfiguration:T,migrateToHogFunction:W}=(0,Tt.useActions)(o);if(!e)return(0,h.jsx)(Q,{object:"pipeline stage"});if(d&&!l)return(0,h.jsx)(qe,{});if(!l)return(0,h.jsx)(Q,{object:`pipeline ${e}`});let ne=d||p,Ie=ka(l.config_schema).map((I,Y)=>(0,h.jsx)(Tn.default.Fragment,{children:I.key&&I.type&&Ta(I)&&!k.includes(I.key)?(0,h.jsx)(f,{name:I.key,label:(0,h.jsxs)(h.Fragment,{children:[I.secret&&(0,h.jsx)(V,{placement:"top-start",title:"This field is write-only. Its value won't be visible after saving.",children:(0,h.jsx)(oa,{})}),I.markdown&&(0,h.jsx)(mt,{children:I.markdown}),I.name||I.key]}),help:I.hint&&(0,h.jsx)(mt,{className:"mt-0.5",children:I.hint}),showOptional:!w.includes(I.key),children:(0,h.jsx)(co,{fieldConfig:I,disabled:ne})}):(0,h.jsx)(h.Fragment,{children:I.type?(0,h.jsxs)("p",{className:"text-danger",children:["Invalid config field ",(0,h.jsx)("i",{children:I.name||I.key}),"."]}):null})},I.key||`__key__${Y}`)),ot=(0,h.jsxs)(h.Fragment,{children:[(0,h.jsx)(x,{type:"secondary",htmlType:"reset",onClick:()=>T(s||{}),disabledReason:y?p?"Saving in progress\u2026":void 0:"No changes",children:"Clear changes"}),(0,h.jsx)(x,{type:"primary",htmlType:"submit",onClick:P,loading:p,children:i?"Create":"Save"})]});return(0,h.jsxs)("div",{className:"space-y-3",children:[(0,h.jsx)(pe,{buttons:ot}),l?.hog_function_migration_available&&(0,h.jsxs)(ca,{type:"error",action:{children:"Upgrade to new version",onClick:()=>we.open({title:"Upgrade destination",width:"30rem",description:"This will create a new Destination in the upgraded system. The old destination will be disabled and can later be deleted. In addition there may be slight differences in the configuration options that you can choose to modify.",secondaryButton:{type:"secondary",children:"Cancel"},primaryButton:{type:"primary",onClick:()=>W(),children:"Upgrade"}}),disabled:d},children:[(0,h.jsx)("b",{children:"New version available!"})," This destination is part of our legacy system. Click to upgrade."]}),(0,h.jsx)(Cn.Form,{logic:Yt,props:n,formKey:"configuration",className:"space-y-3",children:(0,h.jsxs)("div",{className:"flex flex-wrap gap-4 items-start",children:[(0,h.jsxs)("div",{className:"flex flex-col gap-4 flex-1 min-w-100",children:[(0,h.jsxs)("div",{className:"border bg-surface-primary rounded p-3 space-y-2",children:[(0,h.jsxs)("div",{className:"flex flex-row gap-2 min-h-16 items-center",children:[(0,h.jsx)(_a,{plugin:l,imageSize:"medium"}),(0,h.jsxs)("div",{className:"flex flex-col py-1 flex-1",children:[(0,h.jsx)("div",{className:"flex flex-row items-center font-semibold text-sm gap-1",children:l.name}),l.description?(0,h.jsx)("div",{className:"text-text-3000 text-xs text-tertiary mt-1",children:(0,h.jsx)(mt,{className:"max-w-[30rem]",lowKeyHeadings:!0,children:l.description})}):null]}),(0,h.jsx)(f,{name:"enabled",children:({value:I,onChange:Y})=>(0,h.jsx)(Le,{label:"Enabled",onChange:()=>Y(!I),checked:I,disabled:ne,bordered:!0})})]}),(0,h.jsx)(f,{name:"name",label:"Name",info:"Customising the name can be useful if multiple instances of the same type are used.",children:(0,h.jsx)(E,{type:"text",disabled:ne})}),(0,h.jsx)(f,{name:"description",label:"Description",info:"Add a description to share context with other team members",children:(0,h.jsx)(dt,{disabled:ne})})]})," "]}),(0,h.jsxs)("div",{className:"flex-2 min-w-100 space-y-4",children:[(0,h.jsx)("div",{className:"border bg-surface-primary rounded p-3  space-y-2",children:(0,h.jsx)(h.Fragment,{children:Ie.length?Ie:(0,h.jsx)("span",{className:"italic text-secondary",children:"This app does not have specific configuration options"})})}),(0,h.jsx)("div",{className:"flex gap-2 justify-end",children:ot})]})]})})]})}function co({value:e,onChange:t,fieldConfig:a,disabled:n}){let[o,l]=(0,Rn.useState)(!1);return a.secret&&!o&&e&&(e===At||e.name===At)?(0,h.jsxs)(x,{type:"secondary",icon:(0,h.jsx)(ra,{}),onClick:()=>{t?.(a.default||""),l(!0)},disabled:n,children:["Reset secret ",a.type==="attachment"?"attachment":"field"]}):a.type==="attachment"?(0,h.jsxs)(h.Fragment,{children:[e?.name?(0,h.jsxs)("span",{children:["Selected file: ",e.name]}):null,(0,h.jsx)(ct,{accept:"*",multiple:!1,onChange:i=>t?.(i[0]),value:e?.size?[e]:[],showUploadedFiles:!1})]}):a.type==="string"?(0,h.jsx)(E,{value:e,onChange:t,autoFocus:o,className:"ph-no-capture",disabled:n}):a.type==="json"?(0,h.jsx)(uo,{value:e,onChange:t,autoFocus:o,className:"ph-no-capture"}):a.type==="choice"?(0,h.jsx)(Z,{fullWidth:!0,value:e,className:"ph-no-capture",onChange:t,options:a.choices.map(i=>({label:i,value:i})),disabled:n}):(0,h.jsxs)("strong",{className:"text-danger",children:['Unknown field type "',(0,h.jsx)("code",{children:a.type}),'".',(0,h.jsx)("br",{}),"You may need to upgrade PostHog!"]})}function uo(e){return(0,h.jsx)(fa,{disableWidth:!0,className:"min-h-60",children:({height:t})=>(0,h.jsx)(ga,{className:"border",language:"json",value:e.value,onChange:a=>e.onChange?.(a??""),height:t,options:{minimap:{enabled:!1}}})})}var Ue=c(C());function In(){let{node:e,stage:t}=(0,Pn.useValues)(Ce);return t?(0,Ue.jsx)("div",{className:"space-y-3",children:e.backend==="hog_function"?(0,Ue.jsx)(Ra,{id:e.id}):e.backend==="plugin"?(0,Ue.jsx)(Nn,{stage:t,pluginConfigId:e.id}):(0,Ue.jsx)(En,{id:e.id.toString()})}):(0,Ue.jsx)(Q,{object:"pipeline app stage"})}b();v();_();var ke=c(F());var zt=c(Fe()),Rt=c(Fe());var m=c(C());function Dn({id:e}){let t=_t({id:e}),{appMetricsResponse:a,appMetricsResponseLoading:n,dateRange:o}=(0,ke.useValues)(t),{setDateRange:l}=(0,ke.useActions)(t);return(0,m.jsxs)("div",{className:"space-y-8",children:[(0,m.jsxs)("div",{className:"flex items-start justify-between gap-2",children:[(0,m.jsx)(mo,{metrics:a?.metrics,metricsLoading:n}),(0,m.jsx)(We,{dateTo:o.to,dateFrom:o.from,onChange:(i,p)=>l(i,p),allowedRollingDateOptions:["days","weeks","months","years"],makeLabel:i=>(0,m.jsxs)(m.Fragment,{children:[(0,m.jsx)(Oe,{})," ",i]})})]}),(0,m.jsxs)("div",{children:[(0,m.jsx)("h2",{children:"Delivery trends"}),(0,m.jsx)(po,{metrics:a?.metrics,metricsLoading:n})]}),(0,m.jsxs)("div",{children:[(0,m.jsx)("h2",{children:"Errors"}),(0,m.jsx)(go,{id:e})]})]})}function mo({metrics:e,metricsLoading:t}){return t?(0,m.jsx)(oe,{className:"w-20 h-4 mb-2",repeat:4}):(0,m.jsx)("div",{className:"space-y-4",children:(0,m.jsxs)("div",{className:"flex items-start gap-8 flex-wrap",children:[(0,m.jsxs)("div",{children:[(0,m.jsxs)("div",{className:"text-secondary font-semibold mb-2",children:["Events Processed successfully",(0,m.jsx)(V,{title:"Total number of events processed successfully",children:(0,m.jsx)(fe,{})})]}),(0,m.jsx)("div",{className:"text-4xl",children:Fn(e?.totals?.successes)})]}),(0,m.jsxs)("div",{children:[(0,m.jsxs)("div",{className:"text-secondary font-semibold mb-2",children:["Events Failed",(0,m.jsx)(V,{title:"Total number of events that threw an error during processing",children:(0,m.jsx)(fe,{})})]}),(0,m.jsx)("div",{className:"text-4xl",children:Fn(e?.totals?.failures)})]})]})})}function Fn(e){return(0,m.jsx)(m.Fragment,{children:e&&Ye(e)})}function po({metrics:e,metricsLoading:t}){let a=(0,Rt.useRef)(null);return(0,Rt.useEffect)(()=>{let n;if(a.current&&e&&!it())return n=new pt(a.current?.getContext("2d"),{type:"line",data:{labels:e.dates,datasets:[{label:"events processed successfully",data:e.successes,borderColor:"",...Mn("data-color-1")},{label:"events failed",data:e.failures,...Mn("data-color-5")}]},options:{scales:{x:{ticks:{maxRotation:0},grid:{display:!1}},y:{beginAtZero:!0}},plugins:{crosshair:!1,legend:{display:!1}},maintainAspectRatio:!1,interaction:{mode:"index",axis:"x",intersect:!1}}}),()=>{n?.destroy()}},[e]),t||!e?(0,m.jsx)(oe,{className:"AppMetricsGraph border rounded p-6"}):(0,m.jsx)("div",{className:"AppMetricsGraph border rounded p-6",children:(0,m.jsx)("canvas",{ref:a})})}function Mn(e){let t=Me(e);return{borderColor:t,hoverBorderColor:Ft(t,-20),hoverBackgroundColor:Ft(t,-20),backgroundColor:t,fill:!1,borderWidth:2,pointRadius:0}}function go({id:e}){let t=_t({id:e}),{appMetricsResponse:a,appMetricsResponseLoading:n}=(0,ke.useValues)(t),{openErrorDetailsModal:o}=(0,ke.useActions)(t);return(0,m.jsxs)(m.Fragment,{children:[(0,m.jsx)(fo,{id:e}),(0,m.jsx)(ee,{dataSource:a?.errors||[],loading:n,columns:[{title:"Error type",dataIndex:"error_type",render:function(i,p){return(0,m.jsx)(Ae,{title:"View details",className:"font-semibold",onClick:s=>{s.preventDefault(),o(p.error_type)},children:p.error_type})},sorter:(l,i)=>l.error_type.localeCompare(i.error_type)},{title:"Count",dataIndex:"count",align:"right",sorter:(l,i)=>l.count-i.count},{title:"Last seen",dataIndex:"last_seen",render:function(i){return(0,m.jsx)("div",{className:"whitespace-nowrap text-right",children:(0,m.jsx)(q,{time:i})})},align:"right",sorter:(l,i)=>new Date(l.last_seen||0)>new Date(i.last_seen||0)?1:-1}],defaultSorting:{columnKey:"last_seen",order:-1},useURLForSorting:!1,noSortingCancellation:!0,emptyState:(0,m.jsxs)("div",{className:"",children:[(0,m.jsx)("b",{children:"No errors! \u{1F973}"}),(0,m.jsx)("p",{className:"m-0",children:"If this app has any errors in the future, this table will contain information to help solve the issue."})]})})]})}function fo({id:e}){let t=_t({id:e}),{errorDetails:a,errorDetailsModalError:n,errorDetailsLoading:o}=(0,ke.useValues)(t),{closeErrorDetailsModal:l}=(0,ke.useActions)(t),[i,p]=(0,zt.useState)(0),s=a[i];return(0,m.jsx)(Je,{isOpen:!!n,onClose:l,title:n,width:"min(50vw, 80rem)",description:(0,m.jsx)("span",{children:s?.error_details?.error.message?.substring(0,200)}),footer:(0,m.jsx)("div",{className:"flex items-center justify-end gap-1 h-",children:o?(0,m.jsx)(oe,{className:"h-10"}):(0,m.jsxs)(m.Fragment,{children:[(0,m.jsxs)("span",{children:[i+1," of ",a.length," sample",a.length>1?"s":""]}),(0,m.jsx)(x,{icon:(0,m.jsx)(ea,{}),onClick:()=>p(i-1),disabledReason:i==0?"First page":void 0}),(0,m.jsx)(x,{icon:(0,m.jsx)(ta,{}),onClick:()=>p(i+1),disabledReason:i==a.length-1?"Last page":void 0})]})}),children:!n||o?(0,m.jsx)(oe,{className:"h-10"}):(0,m.jsxs)("div",{className:"flex flex-col space-y-2 h-[80vh]",children:[(0,m.jsxs)("div",{children:[(0,m.jsx)("span",{className:"font-semibold",children:"When:"})," ",(0,m.jsx)(q,{time:s.timestamp,showSeconds:!0})]}),s.error_details.eventCount&&(0,m.jsxs)("div",{children:[(0,m.jsx)($e,{children:"Event Count"}),(0,m.jsx)("div",{children:s.error_details.eventCount})]}),s.error_details.error.message&&(0,m.jsx)(Vt,{title:"Error message",defaultIsExpanded:!0,children:(0,m.jsx)(ut,{wrap:!0,language:"javascript",children:s.error_details.error.message})}),s.error_details.event&&(0,m.jsx)(Vt,{title:"Event payload",defaultIsExpanded:!1,children:(0,m.jsx)(ut,{wrap:!0,language:"json",children:JSON.stringify(s.error_details.event,null,2)})}),s.error_details.error.stack&&(0,m.jsx)(Vt,{title:"Stack trace",defaultIsExpanded:!1,children:(0,m.jsx)(ut,{wrap:!0,language:"javascript",children:s.error_details.error.stack})})]})})}function Vt(e){let[t,a]=(0,zt.useState)(e.defaultIsExpanded);return(0,m.jsxs)("div",{className:"bg-primary border rounded",children:[(0,m.jsx)(x,{fullWidth:!0,onClick:()=>a(!t),sideIcon:t?(0,m.jsx)(aa,{}):(0,m.jsx)(na,{}),title:t?"Show less":"Show more",className:"bg-primary",children:e.title}),t&&(0,m.jsx)("div",{className:"bg-surface-primary p-2",children:e.children})]})}var G=c(C()),ho={transformations:"transformation",destinations:"destination","site-apps":"site-app","legacy-sources":"legacy-source",sources:"source"},An=({params:{stage:e,id:t}})=>{let a=t&&/^\d+$/.test(t)?parseInt(t):void 0;if(!e||!t)throw new Error("Loaded PipelineNode without either `stage` or `id` passed in");return{stage:ho[e]||null,id:a&&!isNaN(a)?a:t}},Nd={component:yo,logic:Ce,paramsToProps:An};function yo(e={}){let{stage:t,id:a}=An({params:e}),{currentTab:n,node:o}=(0,$t.useValues)(Ce),{featureFlags:l}=(0,$t.useValues)(De);if(!t)return(0,G.jsx)(Q,{object:"pipeline stage"});let i=o.backend==="managed_source"?{schemas:(0,G.jsx)(Ua,{id:o.id}),syncs:(0,G.jsx)($a,{id:o.id}),...l[Be.EDIT_DWH_SOURCE_CONFIG]?{"source configuration":(0,G.jsx)(Ga,{id:o.id})}:{}}:o.backend!=="self_managed"?{configuration:(0,G.jsx)(In,{}),metrics:o.backend==="hog_function"?(0,G.jsx)(vn,{id:o.id}):(0,G.jsx)(Dn,{id:a}),logs:(0,G.jsx)(tn,{id:a,stage:t})}:{};return o.backend==="batch_export"&&(i.runs=(0,G.jsx)(bn,{id:o.id}),i.backfills=(0,G.jsx)(gn,{id:o.id})),o.backend==="self_managed"&&(i["source configuration"]=(0,G.jsx)(nn,{id:o.id.toString()})),o.backend==="plugin"&&(i.history=(0,G.jsx)(qt,{id:a,scope:"Plugin"})),o.backend==="hog_function"&&(i.history=(0,G.jsx)(qt,{id:String(a).startsWith("hog-")?String(a).substring(4):a,scope:"HogFunction"})),t==="site-app"&&(delete i.logs,delete i.metrics),(0,G.jsxs)(G.Fragment,{children:[(0,G.jsx)(pe,{}),(0,G.jsx)(pa,{activeKey:n,tabs:Object.entries(i).map(([p,s])=>({label:Zt(p),key:p,content:s,link:e.stage?ce.pipelineNode(t,a,p):void 0}))})]})}export{En as a,Nn as b,ho as c,Nd as d,yo as e};
//# sourceMappingURL=/static/chunk-33A7AV64.js.map
