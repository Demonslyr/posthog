import{c as Ne}from"/static/chunk-UNRPRUE4.js";import"/static/chunk-FB53JKJK.js";import{a as Ce}from"/static/chunk-ZDFMFKTJ.js";import"/static/chunk-X3DMY2SE.js";import{a as we}from"/static/chunk-XW2JOKCQ.js";import{a as be}from"/static/chunk-OYAHDROG.js";import"/static/chunk-MEAB657I.js";import"/static/chunk-4HIBDE5Y.js";import"/static/chunk-TNG4S7TR.js";import"/static/chunk-LYMEBJGW.js";import"/static/chunk-QIBQKJHN.js";import"/static/chunk-44P5EQSU.js";import"/static/chunk-GH3IWF3M.js";import{j as Te}from"/static/chunk-CBJ7RAUW.js";import"/static/chunk-XSEDUXPL.js";import"/static/chunk-HRNZBUVG.js";import"/static/chunk-OKGJSIGC.js";import{g as Se}from"/static/chunk-NKVVAJQ7.js";import"/static/chunk-2HTNY362.js";import"/static/chunk-S27Q4QO6.js";import"/static/chunk-JUFFFVO5.js";import"/static/chunk-JZCOVRBI.js";import"/static/chunk-EIJECEWK.js";import{$a as re,Cd as le,Cg as he,Ch as Y,Do as y,Gm as ye,Io as x,Ja as ie,Lh as ve,N as ne,Np as Ee,Qd as me,Sc as se,Sd as T,Ta as A,Tf as q,Uf as ue,Vd as R,Wd as z,Za as ae,a as $,cc as ce,de as pe,ef as W,f as oe,ie as de,je as K,ng as fe,oe as V,r as v,se as F,up as Le,vo as Ae,yg as ge}from"/static/chunk-RFJTZKD6.js";import"/static/chunk-XPJ4MQJV.js";import"/static/chunk-KQJ3FYBQ.js";import{a as Ue}from"/static/chunk-3UDJFOQH.js";import"/static/chunk-HHT4SG7V.js";import"/static/chunk-K7LQKAJG.js";import"/static/chunk-QQTK3LZH.js";import"/static/chunk-IJQNM355.js";import"/static/chunk-4CN6THWS.js";import"/static/chunk-272RTCFX.js";import"/static/chunk-2ROB4QWU.js";import"/static/chunk-ALT2ZZSO.js";import"/static/chunk-UE6SLBBN.js";import"/static/chunk-GINZUAUY.js";import"/static/chunk-SQELCOUW.js";import"/static/chunk-IGYUTZ65.js";import"/static/chunk-YM6UBNGD.js";import"/static/chunk-C6TQ5FFZ.js";import"/static/chunk-GXGA523B.js";import"/static/chunk-N4MMWRNK.js";import"/static/chunk-NRLAI7OY.js";import"/static/chunk-LVVHNICT.js";import"/static/chunk-2AXSSSSX.js";import"/static/chunk-DGXQI7RB.js";import"/static/chunk-HUCRWDLX.js";import"/static/chunk-RFEQG3YN.js";import"/static/chunk-PUISI233.js";import{d as c,e as f,g,j as h}from"/static/chunk-SJXEOBQC.js";f();h();g();var He=c($());f();h();g();var d=c($()),ke=c(ae());f();h();g();var l=c($()),xe=c(re()),_e=c(ae()),w=c(oe());var D=c(v()),G={event:"$pageview",href_matching:"contains"},C=(0,l.kea)([(0,l.path)(e=>["scenes","actions","actionEditLogic",e]),(0,l.props)({}),(0,l.key)(e=>e.id||"new"),(0,l.connect)({actions:[ge,["loadActions"],Ne,["loadEventDefinitions"],W,["loadTags"]],values:[Ee,["activeScene"]]}),(0,l.actions)({setAction:(e,t={merge:!0})=>({action:e,options:t}),setCreateNew:e=>({createNew:e}),actionAlreadyExists:e=>({actionId:e}),deleteAction:!0,migrateToHogFunction:!0}),(0,l.reducers)({createNew:[!1,{setCreateNew:(e,{createNew:t})=>t}]}),(0,xe.forms)(({actions:e,props:t})=>({action:{defaults:t.action??{name:"",steps:[G]},submit:async(n,a)=>{let s,u=n.steps;u!==void 0&&(u=u.map(m=>({...m,...m.event==="$autocapture"||m.event==="$pageview"?{}:{url:null,url_matching:null}})));try{n.id?s=await x.actions.update(n.id,{...n,steps:u}):s=await x.actions.create({...n,steps:u}),a()}catch(m){if(m.code==="unique"){let p=m.detail.split(" ").pop();return R.error((0,D.jsxs)(D.Fragment,{children:["Action with this name already exists."," ",(0,D.jsx)(A,{to:y.action(p),target:"_blank",children:"Edit it here"})]})),{...n}}throw m}if(R.success("Action saved"),e.resetAction(n),!t.id)w.router.actions.push(y.action(s.id));else{let m=parseInt(t.id.toString());_.findMounted(m)?.actions.loadActionSuccess(s)}return e.loadEventDefinitions(),e.loadActions(),e.loadTags(),s}}})),(0,l.selectors)({hasCohortFilters:[e=>[e.action],e=>e?.steps?.some(t=>t.properties?.find(n=>n.type==="cohort"))??!1],originalActionHasCohortFilters:[()=>[(e,t)=>t.action],e=>e?.steps?.some(t=>t.properties?.find(n=>n.type==="cohort"))??!1],showCohortDisablesFunctionsWarning:[e=>[e.hasCohortFilters,e.originalActionHasCohortFilters],(e,t)=>e&&!t]}),(0,_e.loaders)(({props:e,values:t})=>({action:[{...e.action},{setAction:({action:n,options:{merge:a}})=>a?{...t.action,...n}:n}]})),(0,l.listeners)(({values:e,actions:t})=>({deleteAction:async()=>{let n=e.action.id;if(n)try{await fe({endpoint:x.actions.determineDeleteEndpoint(),object:e.action,callback:a=>{a?w.router.actions.push(y.action(n)):(t.resetAction(),w.router.actions.push(y.actions()),t.loadActions())}})}catch(a){R.error(`Error deleting action: ${a.detail}`)}}})),(0,l.afterMount)(({actions:e,props:t})=>{t.id||e.setActionValue("steps",[{...G}])}),(0,w.urlToAction)(({actions:e})=>({[y.createAction()]:(t,n)=>{try{if(n.copy){let{id:a,created_at:s,created_by:u,last_calculated_at:m,...p}=n.copy;e.setAction({...p,steps:p.steps,name:`${p.name} (copy)`},{merge:!1})}}catch{throw new Error("Could not parse action to copy from URL")}}})),(0,w.beforeUnload)(e=>({enabled:()=>e.isMounted()?e.values.actionChanged:!1,message:`Leave action?
Changes you made will be discarded.`,onConfirm:()=>{e.actions.resetAction()}}))]);var _=(0,d.kea)([(0,d.props)({}),(0,d.key)(e=>e.id||"new"),(0,d.path)(e=>["scenes","actions","actionLogic",e]),(0,d.actions)(()=>({updateAction:e=>({action:e}),checkIsFinished:e=>({action:e}),setPollTimeout:e=>({pollTimeout:e}),setIsComplete:e=>({isComplete:e})})),(0,ke.loaders)(({props:e})=>({action:[null,{loadAction:async()=>{if(!e.id)throw new Error("Cannot fetch an unsaved action from the API.");return await x.actions.get(e.id)}}],matchingHogFunctions:[null,{loadMatchingHogFunctions:async()=>(await x.hogFunctions.list({filters:{actions:[{id:`${e.id}`}]}})).results}]})),(0,d.reducers)(()=>({action:[null,{updateAction:(e,{action:t})=>e?{...e,...t}:null}],pollTimeout:[null,{setPollTimeout:(e,{pollTimeout:t})=>t}],isComplete:[!1,{setIsComplete:(e,{isComplete:t})=>t}]})),(0,d.selectors)({breadcrumbs:[e=>[e.action,(t,n)=>C.findMounted(String(n?.id||"new"))?.selectors.action(t).name||null],(e,t)=>[{key:"DataManagement",name:"Data management",path:y.eventDefinitions()},{key:"actions",name:"Actions",path:y.actions()},{key:["Action",e?.id||"new"],name:t??(e?.name||""),onRename:async n=>{let a=e?.id,s=C.find(String(a||"new"));s.actions.setActionValue("name",n),a&&await s.asyncActions.submitAction()},forceEditMode:!e?.id}]],hasCohortFilters:[e=>[e.action],e=>e?.steps?.some(t=>t.properties?.find(n=>n.type==="cohort"))??!1],[ue]:[e=>[e.action],e=>e?.id?{activity_scope:"Action",activity_item_id:`${e.id}`}:null]}),(0,d.listeners)(({actions:e,values:t})=>({checkIsFinished:({action:n})=>{n.is_calculating?e.setPollTimeout(setTimeout(()=>e.loadAction(),1e3)):(e.setIsComplete(new Date),t.pollTimeout&&clearTimeout(t.pollTimeout))},loadActionSuccess:({action:n})=>{e.setIsComplete(!1),e.checkIsFinished(n)}})),(0,d.events)(({values:e,actions:t,props:n})=>({afterMount:()=>{n.id&&t.loadAction()},beforeUnmount:()=>{e.pollTimeout&&clearTimeout(e.pollTimeout)}}))]);f();h();g();var O=c($()),De=c(re()),$e=c(oe());f();h();g();var j=c($());var k=c(v());function Fe(){let{action:e}=(0,j.useValues)(_),{hasCohortFilters:t,actionChanged:n,showCohortDisablesFunctionsWarning:a}=(0,j.useValues)(C({id:e?.id,action:e}));if(!e)return null;let s={actions:[{id:`${e?.id}`,name:e?.name,type:"actions"}]};return(0,k.jsxs)("div",{className:"my-4 space-y-2",children:[(0,k.jsx)("h2",{className:"flex-1 subtitle",children:"Connected destinations"}),(0,k.jsx)("p",{children:"Actions can be used a filters for destinations such as Slack or Webhook delivery"}),a?(0,k.jsx)(z,{type:"error",children:"Adding a cohort filter will disable all connected destinations!"}):null,(0,k.jsx)(be,{logicKey:"actions",type:"destination",filters:s,newDisabledReason:t?"Action with cohort filters can't be used in realtime destinations":n?"Please first save the action to create a destination":void 0})]})}f();h();g();var Ie=c(Ue());f();h();g();var N=c(v()),B={exact:void 0,contains:(0,N.jsxs)(N.Fragment,{children:["Use ",(0,N.jsx)("code",{children:"%"})," for wildcard, for example: ",(0,N.jsx)("code",{children:"/user/%/edit"}),"."]}),regex:(0,N.jsx)(A,{to:"https://github.com/google/re2/wiki/Syntax",target:"_blank",children:"RE2 syntax applies."})};var o=c(v()),Pe="https://posthog.com/docs/data/actions?utm_medium=in-product&utm_campaign=action-page";function Me({step:e,actionId:t,isOnlyStep:n,index:a,identifier:s,onDelete:u,onChange:m}){let p=b=>{m(b)};return(0,o.jsxs)("div",{className:"bg-surface-primary rounded border p-3 relative",children:[a>0&&a%2!==0&&(0,o.jsx)("div",{className:"absolute top-1/2 -left-5",children:(0,o.jsx)(Y,{operand:"or"})}),(0,o.jsxs)("div",{className:"space-y-4",children:[(0,o.jsxs)("div",{className:"flex items-center justify-between",children:[(0,o.jsxs)("b",{children:["Match Group #",a+1]}),!n&&(0,o.jsx)(T,{className:"absolute top-2 right-2",icon:(0,o.jsx)(le,{}),size:"small","aria-label":"delete",onClick:u})]}),(0,o.jsx)(Ke,{step:e,sendStep:p}),e.event==="$autocapture"&&(0,o.jsx)(ze,{step:e,sendStep:p,actionId:t}),e.event!==void 0&&e.event!=="$autocapture"&&e.event!=="$pageview"&&(0,o.jsxs)("div",{className:"space-y-1",children:[(0,o.jsx)(K,{children:"Event name"}),(0,o.jsx)(Se,{value:e.event,onChange:b=>p({...e,event:b}),placeholder:"All events",allEventsOption:"explicit"}),(0,o.jsxs)("small",{children:[(0,o.jsx)(A,{to:"https://posthog.com/docs/libraries",target:"_blank",children:"See documentation"})," ","on how to send custom events in lots of languages."]})]}),e.event==="$pageview"&&(0,o.jsxs)("div",{children:[(0,o.jsx)(H,{step:e,sendStep:p,item:"url",labelExtra:(0,o.jsx)(Q,{field:"url",step:e,sendStep:p}),label:"URL"}),e.url_matching&&e.url_matching in B&&(0,o.jsx)("small",{children:B[e.url_matching]})]}),(0,o.jsxs)("div",{className:"mt-4 space-y-2",children:[(0,o.jsx)(K,{children:"Filters"}),(0,o.jsx)(ve,{propertyFilters:e.properties,pageKey:s,eventNames:e.event?[e.event]:[],onChange:b=>{p({...e,properties:b})},showConditionBadge:!0})]})]})]})}var Re=(e,t)=>{e.includes("#")?t((0,o.jsxs)(o.Fragment,{children:["PostHog actions don't support the ",(0,o.jsx)("code",{children:"#example"})," syntax.",(0,o.jsx)("br",{}),"Use the equivalent ",(0,o.jsx)("code",{children:'[id="example"]'})," instead."]})):t(null)};function H({step:e,sendStep:t,item:n,label:a,placeholder:s="Specify a value to match on this",caption:u,labelExtra:m}){let[p,b]=(0,Ie.useState)(null);return(0,o.jsxs)("div",{className:"space-y-1",children:[(0,o.jsxs)("div",{className:"flex flex-wrap gap-1",children:[(0,o.jsx)(K,{children:a}),m]}),u&&(0,o.jsx)("div",{className:"action-step-caption",children:u}),(0,o.jsx)(de,{"data-attr":"edit-action-url-input",allowClear:!0,onChange:X=>{n==="selector"&&Re(X,b),t({...e,[n]:X||null})},value:e[n]||"",placeholder:s}),n==="selector"&&p&&(0,o.jsx)(z,{type:"warning",children:p})]})}var Z=()=>(0,o.jsx)("div",{className:"flex w-full justify-center",children:(0,o.jsx)(Y,{operand:"and"})});function ze({step:e,actionId:t,sendStep:n}){return(0,o.jsxs)("div",{className:"space-y-4",children:[(0,o.jsxs)("div",{className:"flex items-center gap-2",children:[(0,o.jsx)(T,{size:"small",type:"secondary",onClick:()=>{pe.open({title:"Select an element",description:t?"Choose the domain on which to edit this action":"Choose the domain on which to create this action",content:(0,o.jsx)(o.Fragment,{children:(0,o.jsx)(Ce,{actionId:t,type:"TOOLBAR_URLS"})}),primaryButton:{children:"Close",type:"secondary"}})},sideIcon:(0,o.jsx)(ne,{}),children:"Select element on site"}),(0,o.jsx)(A,{to:`${Pe}#1-autocapture`,target:"_blank",children:"See documentation."})]}),(0,o.jsx)(H,{step:e,sendStep:n,item:"text",labelExtra:(0,o.jsx)(Q,{field:"text",step:e,sendStep:n}),label:"Element text"}),(0,o.jsx)(Z,{}),(0,o.jsx)(H,{step:e,sendStep:n,item:"href",labelExtra:(0,o.jsx)(Q,{field:"href",step:e,sendStep:n}),label:"Element link target",caption:(0,o.jsxs)(o.Fragment,{children:["Filtering by the ",(0,o.jsx)("code",{children:"href"})," attribute. Only ",(0,o.jsx)("code",{children:"<a/>"})," elements will be matched."]})}),(0,o.jsx)(Z,{}),(0,o.jsx)(H,{step:e,sendStep:n,item:"selector",label:"Element matches HTML selector",caption:(0,o.jsxs)("span",{children:["The selector can be a tag name, class, HTML attribute, or all of those combined. Example:"," ",(0,o.jsx)("code",{children:'button[data-attr="signup"]'}),"."," ",(0,o.jsx)(A,{to:`${Pe}#matching-selectors`,children:"Learn more in Docs."})]})}),(0,o.jsx)(Z,{}),(0,o.jsx)(H,{step:e,sendStep:n,item:"url",labelExtra:(0,o.jsx)(Q,{field:"url",step:e,sendStep:n}),label:"Page URL",caption:"The page on which the interaction occurred."}),e?.url_matching&&e.url_matching in B&&(0,o.jsx)("small",{children:B[e.url_matching]})]})}function Ke({step:e,sendStep:t}){return(0,o.jsx)("div",{"data-attr":"action-type-switcher",children:(0,o.jsx)(V,{onChange:a=>{a==="$autocapture"?t({...e,event:"$autocapture"}):a==="event"?t({...e,event:null}):a==="$pageview"&&t({...e,event:"$pageview",url:e.url})},value:e.event==="$autocapture"||e.event==="$pageview"||e.event===void 0?e.event:"event",options:[{value:"$pageview",label:"Pageview","data-attr":"action-type-pageview"},{value:"$autocapture",label:"Autocapture","data-attr":"action-type-autocapture"},{value:"event",label:"Other events","data-attr":"action-type-other"}],fullWidth:!0,size:"small"})})}function Q({field:e,step:t,sendStep:n}){let a=`${e}_matching`,s=m=>{n({...t,[a]:m})},u=e==="url"?"contains":"exact";return(0,o.jsx)("div",{className:"flex flex-1 justify-end",children:(0,o.jsx)(V,{onChange:s,value:t[a]||u,options:[{value:"exact",label:"matches exactly"},{value:"regex",label:"matches regex"},{value:"contains",label:"contains"}],size:"xsmall"})})}var i=c(v());function Be({action:e,id:t}){let n={id:t,action:e},a=C(n),{action:s,actionLoading:u,actionChanged:m}=(0,O.useValues)(a),{submitAction:p,deleteAction:b}=(0,O.useActions)(a),{tags:ee}=(0,O.useValues)(W),X=()=>(0,i.jsx)(T,{"data-attr":"delete-action-bottom",status:"danger",type:"secondary",onClick:()=>{b()},children:"Delete"}),Oe=()=>(0,i.jsx)(T,{"data-attr":"cancel-action-bottom",status:"danger",type:"secondary",onClick:()=>{$e.router.actions.push(y.actions())},children:"Cancel"}),Xe=(0,i.jsx)("div",{className:"action-edit-container",children:(0,i.jsxs)(De.Form,{logic:C,props:n,formKey:"action",enableFormOnSubmit:!0,children:[(0,i.jsx)(Ae,{caption:(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(q,{name:"description",children:({value:S,onChange:L})=>(0,i.jsx)(we,{multiline:!0,name:"description",markdown:!0,value:S||"",placeholder:"Description (optional)",onChange:t?void 0:L,onSave:E=>{L(E),p()},mode:t?void 0:"edit","data-attr":"action-description",className:"action-description",compactButtons:!0,maxLength:600})}),(0,i.jsx)(q,{name:"tags",className:"mt-2",children:({value:S,onChange:L})=>(0,i.jsx)(he,{tags:S??[],onChange:E=>L(E),className:"action-tags",saving:u,tagsAvailable:ee.filter(E=>!s.tags?.includes(E))})})]}),buttons:(0,i.jsxs)(i.Fragment,{children:[t?(0,i.jsx)(T,{type:"secondary",to:y.replay("home",{filter_group:{type:"AND",values:[{type:"AND",values:[{id:t,type:"actions",order:0,name:s.name}]}]}}),sideIcon:(0,i.jsx)(ie,{}),"data-attr":"action-view-recordings",children:"View recordings"}):null,t?X():Oe(),m||!t?(0,i.jsx)(T,{"data-attr":"save-action-button",type:"primary",htmlType:"submit",loading:u,onClick:p,disabledReason:!m&&!t?"No changes to save":void 0,children:"Save"}):null]})}),(0,i.jsxs)("div",{className:"@container",children:[(0,i.jsx)("h2",{className:"subtitle",children:"Match groups"}),(0,i.jsxs)("p",{children:["Your action will be triggered whenever ",(0,i.jsx)("b",{children:"any of your match groups"})," are received.",(0,i.jsx)(A,{to:"https://posthog.com/docs/product-analytics/retention",target:"_blank",children:(0,i.jsx)(ce,{className:"ml-1 text-secondary text-xl"})})]}),(0,i.jsx)(q,{name:"steps",children:({value:S,onChange:L})=>(0,i.jsxs)("div",{className:"grid @4xl:grid-cols-2 gap-3",children:[S.map((E,J)=>{let Je=String(JSON.stringify(E));return(0,i.jsx)(Me,{identifier:Je,index:J,step:E,actionId:s.id||0,isOnlyStep:!!S&&S.length===1,onDelete:()=>{let U=[...S];U.splice(J,1),L(U)},onChange:U=>{let te=[...S];te.splice(J,1,U),L(te)}},J)}),(0,i.jsx)("div",{children:(0,i.jsx)(T,{icon:(0,i.jsx)(se,{}),type:"secondary",onClick:()=>{L([...s.steps||[],G])},center:!0,className:"w-full h-full",children:"Add match group"})})]})})]})]})});return(0,i.jsxs)(i.Fragment,{children:[Xe,(0,i.jsx)(Fe,{})]})}var r=c(v()),Mo={logic:_,component:We,paramsToProps:({params:{id:e}})=>({id:e?parseInt(e):void 0})};function We({id:e}={}){let{action:t,actionLoading:n,isComplete:a}=(0,He.useValues)(_);return n?(0,r.jsxs)("div",{className:"space-y-2",children:[(0,r.jsx)(F,{className:"w-1/4 h-6"}),(0,r.jsx)(F,{className:"w-1/3 h-10"}),(0,r.jsx)(F,{className:"w-1/2 h-6"}),(0,r.jsxs)("div",{className:"flex gap-2",children:[(0,r.jsx)(F,{className:"w-1/2 h-120"}),(0,r.jsx)(F,{className:"w-1/2 h-120"})]})]}):e&&!t?(0,r.jsx)(ye,{object:"action"}):(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(Be,{id:e,action:t}),e&&(0,r.jsx)(r.Fragment,{children:a?(0,r.jsxs)("div",{className:"mt-8",children:[(0,r.jsx)("h2",{className:"subtitle",children:"Matching events"}),(0,r.jsxs)("p",{children:["This is the list of ",(0,r.jsx)("strong",{children:"recent"})," events that match this action."]}),(0,r.jsx)("div",{className:"pt-4 border-t"}),(0,r.jsx)(Te,{query:{kind:"DataTableNode",source:{kind:"EventsQuery",select:Le("EventsQuery"),actionId:e,after:"-24h"},full:!0,showEventFilter:!1,showPropertyFilter:!1}})]}):(0,r.jsxs)("div",{children:[(0,r.jsx)("h2",{className:"subtitle",children:"Matching events"}),(0,r.jsxs)("div",{className:"flex items-center",children:[(0,r.jsx)(me,{className:"mr-4"}),"Calculating action, please hold on."]})]})})]})}export{We as Action,Mo as scene};
//# sourceMappingURL=/static/Action-EM4DQZAY.js.map
