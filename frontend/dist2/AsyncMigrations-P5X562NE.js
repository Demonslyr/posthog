import{a as lt}from"/static/chunk-FSKJ7Q2U.js";import{a as mt}from"/static/chunk-NZFSLWJ4.js";import{a as ct}from"/static/chunk-DXU2OWVA.js";import{$a as rt,Ae as ot,Eo as F,Io as _,Ja as nt,Pg as st,Qd as X,Sa as q,Sd as l,Ta as J,Vd as R,Za as Wt,a as v,af as at,ce as k,ee as et,f as Ot,fe as it,ie as N,na as B,oa as tt,r as b,ve as z,vo as G,ze as O}from"/static/chunk-RFJTZKD6.js";import"/static/chunk-XPJ4MQJV.js";import{a as U,kb as C}from"/static/chunk-3UDJFOQH.js";import"/static/chunk-HHT4SG7V.js";import"/static/chunk-K7LQKAJG.js";import"/static/chunk-QQTK3LZH.js";import"/static/chunk-IJQNM355.js";import"/static/chunk-4CN6THWS.js";import"/static/chunk-272RTCFX.js";import"/static/chunk-2ROB4QWU.js";import"/static/chunk-ALT2ZZSO.js";import"/static/chunk-UE6SLBBN.js";import"/static/chunk-GINZUAUY.js";import"/static/chunk-SQELCOUW.js";import"/static/chunk-IGYUTZ65.js";import"/static/chunk-YM6UBNGD.js";import"/static/chunk-C6TQ5FFZ.js";import"/static/chunk-GXGA523B.js";import"/static/chunk-N4MMWRNK.js";import"/static/chunk-NRLAI7OY.js";import"/static/chunk-LVVHNICT.js";import"/static/chunk-2AXSSSSX.js";import"/static/chunk-DGXQI7RB.js";import"/static/chunk-HUCRWDLX.js";import"/static/chunk-RFEQG3YN.js";import"/static/chunk-PUISI233.js";import{d as a,e as d,g as p,j as y}from"/static/chunk-SJXEOBQC.js";d();y();p();var w=a(v());var _t=a(U());d();y();p();var yt=a(v()),$=a(rt());var Mt=a(U());d();y();p();var S=a(v()),dt=a(rt());d();y();p();var m=a(v()),gt=a(Wt()),W=a(Ot());var ut={0:"Not started",1:"Running",2:"Complete",3:"Error",4:"Rolled back",5:"Starting",6:"Failed at startup"},u=(0,m.kea)([(0,m.path)(["scenes","instance","AsyncMigrations","asyncMigrationsLogic"]),(0,m.connect)({values:[at,["preflight"]]}),(0,m.actions)({triggerMigration:t=>({migration:t}),resumeMigration:t=>({migration:t}),rollbackMigration:t=>({migration:t}),forceStopMigration:t=>({migration:t}),forceStopMigrationWithoutRollback:t=>({migration:t}),updateMigrationStatus:(t,n,e)=>({migration:t,endpoint:n,message:e}),setActiveTab:t=>({tab:t}),updateSetting:(t,n)=>({settingKey:t,newValue:n}),loadAsyncMigrationErrors:t=>({migrationId:t}),loadAsyncMigrationErrorsSuccess:(t,n)=>({migrationId:t,errors:n}),loadAsyncMigrationErrorsFailure:(t,n)=>({migrationId:t,error:n}),openAsyncMigrationsModal:(t,n,e)=>({migration:t,endpoint:n,message:e}),closeAsyncMigrationsModal:!0}),(0,m.reducers)({activeTab:["management",{setActiveTab:(t,{tab:n})=>n}],asyncMigrationErrors:[{},{loadAsyncMigrationErrorsSuccess:(t,{migrationId:n,errors:e})=>({...t,[n]:e})}],asyncMigrationErrorsLoading:[{},{loadAsyncMigrationErrors:(t,{migrationId:n})=>({...t,[n]:!0}),loadAsyncMigrationErrorsSuccess:(t,{migrationId:n})=>({...t,[n]:!1}),loadAsyncMigrationErrorsFailure:(t,{migrationId:n})=>({...t,[n]:!1})}],activeAsyncMigrationModal:[null,{openAsyncMigrationsModal:(t,n)=>n,closeAsyncMigrationsModal:()=>null,updateMigrationStatus:()=>null}]}),(0,gt.loaders)(()=>({asyncMigrations:[[],{loadAsyncMigrations:async()=>F.values.user?.is_staff?(await _.get("api/async_migrations")).results:[]}],asyncMigrationSettings:[[],{loadAsyncMigrationSettings:async()=>F.values.user?.is_staff?(await _.get("api/instance_settings")).results.filter(n=>n.key.includes("ASYNC_MIGRATIONS")):[]}]})),(0,m.selectors)({isAnyMigrationRunning:[t=>[t.asyncMigrations],t=>t.some(n=>[1,5].includes(n.status))],actionableMigrations:[t=>[t.asyncMigrations],t=>t.filter(n=>n.is_available)],futureMigrations:[t=>[t.asyncMigrations],t=>t.filter(n=>!n.is_available)]}),(0,m.listeners)(({actions:t})=>({triggerMigration:async({migration:n})=>{Object.keys(n.parameter_definitions).length>0?t.openAsyncMigrationsModal(n,"trigger","Migration triggered successfully"):t.updateMigrationStatus(n,"trigger","Migration triggered successfully")},resumeMigration:async({migration:n})=>{Object.keys(n.parameter_definitions).length>0?t.openAsyncMigrationsModal(n,"resume","Migration resume triggered successfully"):t.updateMigrationStatus(n,"resume","Migration resume triggered successfully")},rollbackMigration:async({migration:n})=>{t.updateMigrationStatus(n,"rollback","Migration rollback triggered successfully")},forceStopMigration:async({migration:n})=>{t.updateMigrationStatus(n,"force_stop","Force stop triggered successfully")},forceStopMigrationWithoutRollback:async({migration:n})=>{t.updateMigrationStatus(n,"force_stop_without_rollback","Force stop without rollback triggered successfully")},updateMigrationStatus:async({migration:n,endpoint:e,message:A})=>{let f=await _.create(`/api/async_migrations/${n.id}/${e}`,{parameters:n.parameters});f.success?(R.success(A),t.loadAsyncMigrations()):R.error(f.error)},updateSetting:async({settingKey:n,newValue:e})=>{try{await _.update(`/api/instance_settings/${n}`,{value:e}),R.success(`Instance setting ${n} updated`),t.loadAsyncMigrationSettings(),t.loadAsyncMigrations(),lt.actions.loadSystemStatus()}catch{R.error("Failed to trigger migration")}},loadAsyncMigrationErrors:async({migrationId:n})=>{try{let e=await _.get(`api/async_migrations/${n}/errors`);t.loadAsyncMigrationErrorsSuccess(n,e)}catch(e){t.loadAsyncMigrationErrorsFailure(n,e)}}})),(0,m.events)(({actions:t})=>({afterMount:()=>{t.loadAsyncMigrations(),t.loadAsyncMigrationSettings()}})),(0,W.actionToUrl)(({values:t})=>({setActiveTab:()=>`/instance/async_migrations${t.activeTab==="management"?"":"/"+t.activeTab}`})),(0,W.urlToAction)(({actions:t,values:n})=>({"/instance/async_migrations(/:tab)":({tab:e})=>{e&&e!==n.activeTab&&e!=="management"&&t.setActiveTab(e)}}))]);var pt=(0,S.kea)([(0,S.path)(["scenes","instance","AsyncMigrations","asyncMigrationParameterFormLogic"]),(0,S.props)({}),(0,S.key)(t=>t.migration.id),(0,dt.forms)(({props:t})=>({parameters:{defaults:$t(t),submit:async n=>{u.actions.updateMigrationStatus({...t.migration,parameters:n},t.endpoint,t.message)}}}))]);function $t(t){let n={};return Object.keys(t.migration.parameter_definitions).forEach(e=>{t.migration.parameters[e]?n[e]=t.migration.parameters[e]:n[e]=t.migration.parameter_definitions[e][0]}),n}var s=a(b());function ft(t){let{closeAsyncMigrationsModal:n}=(0,yt.useActions)(u),[e,A]=(0,Mt.useState)(!0);return(0,s.jsx)(k,{title:"",onClose:n,isOpen:!0,simple:!0,children:(0,s.jsxs)($.Form,{logic:pt,props:t,formKey:"parameters",enableFormOnSubmit:!0,id:"async-migration-parameters-form",className:"LemonModal__layout",children:[(0,s.jsx)(k.Header,{children:(0,s.jsx)("h3",{children:"Advanced migration configuration"})}),(0,s.jsxs)(k.Content,{children:[(0,s.jsxs)("p",{children:["This async migration allows tuning parameters used in the async migration.",e&&(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)("br",{}),(0,s.jsx)(J,{onClick:()=>{A(!e)},children:"Show advanced configuration"})]})]}),(0,s.jsx)(mt,{collapsed:e,children:Object.entries(t.migration.parameter_definitions).map(([f,[T,h]])=>(0,s.jsx)($.Field,{name:f,label:(0,s.jsx)(s.Fragment,{children:h}),children:(0,s.jsx)(N,{type:typeof T=="number"?"number":"text"})},f))})]}),(0,s.jsxs)(k.Footer,{children:[(0,s.jsx)(l,{form:"async-migration-parameters-form",type:"secondary","data-attr":"async-migration-parameters-cancel",className:"mr-2",onClick:n,children:"Cancel"}),(0,s.jsx)(l,{form:"async-migration-parameters-form",htmlType:"submit",type:"primary","data-attr":"async-migration-parameters-submit",children:"Run migration"})]})]})})}d();y();p();var D=a(v());var L=a(b());function At({asyncMigration:t}){let{asyncMigrationErrorsLoading:n,asyncMigrationErrors:e}=(0,D.useValues)(u),{loadAsyncMigrationErrors:A}=(0,D.useActions)(u),f=[{title:"Error",dataIndex:"description"},{title:(0,L.jsx)(l,{icon:n[t.id]?(0,L.jsx)(X,{}):(0,L.jsx)(B,{}),onClick:()=>A(t.id),type:"secondary",size:"small",children:"Refresh errors"}),render:function(h,E){return(0,L.jsx)("div",{children:C(E.created_at)})}}];return(0,L.jsx)(O,{columns:f,dataSource:e[t.id],loading:n[t.id],embedded:!0})}d();y();p();var bt=a(v()),St=a(U());var M=a(b());function vt({setting:t}){let{updateSetting:n}=(0,bt.useActions)(u),[e,A]=(0,St.useState)(String(t.value));return(0,M.jsxs)("div",{children:[(0,M.jsx)("h4",{children:t.key}),(0,M.jsx)("p",{children:t.description}),(0,M.jsxs)("div",{className:"flex space-x-2",children:[(0,M.jsx)("div",{className:"w-1/3",children:(0,M.jsx)(N,{value:e,onChange:A})}),(0,M.jsx)("div",{children:(0,M.jsx)(l,{type:"secondary",disabledReason:String(t.value)===e&&"Edit the value to save it",onClick:()=>n(t.key,e),children:"Update"})})]}),(0,M.jsx)(et,{})]},t.key)}var r=a(b()),ar={component:Vt,logic:u},Dt=3e3;function Vt(){let{user:t}=(0,w.useValues)(F),{asyncMigrationsLoading:n,activeTab:e,asyncMigrationSettings:A,isAnyMigrationRunning:f,activeAsyncMigrationModal:T,actionableMigrations:h,futureMigrations:E}=(0,w.useValues)(u),{triggerMigration:K,resumeMigration:Lt,rollbackMigration:Tt,forceStopMigration:ht,forceStopMigrationWithoutRollback:Et,loadAsyncMigrations:Q,loadAsyncMigrationErrors:Ct,setActiveTab:Rt}=(0,w.useActions)(u);(0,_t.useEffect)(()=>{if(f){let c=setInterval(()=>Q(),Dt);return()=>clearInterval(c)}},[f]);let Y={title:"Migration",render:function(g,i){let o="https://github.com/PostHog/posthog/blob/master/posthog/async_migrations/migrations/"+i.name+".py";return(0,r.jsx)(st,{to:o,title:i.name,description:i.description})}},kt={title:"Progress",render:function(g,i){let o=i.progress;return(0,r.jsx)("div",{children:(0,r.jsx)(ct,{percent:o})})}},j={title:"Status",render:function(g,i){let o=i.status,Nt=o===1?"success":o===3||o===6?"danger":o===5||o===4?"warning":"default";return(0,r.jsx)(it,{type:Nt,className:"uppercase",children:ut[o]})}},Ft={title:"Last operation index",render:function(g,i){return(0,r.jsx)("div",{children:i.current_operation_index})}},xt={title:"Last query ID",render:function(g,i){return(0,r.jsx)("div",{children:(0,r.jsx)("small",{children:i.current_query_id})})}},Pt={title:"Started at",render:function(g,i){let o=i.started_at;return(0,r.jsx)("div",{children:C(o)})}},It={title:"Finished at",render:function(g,i){let o=i.finished_at;return(0,r.jsx)("div",{children:C(o)})}},wt={title:"",render:function(g,i){let o=i.status;return(0,r.jsx)("div",{children:o===0||o===6?(0,r.jsx)(q,{title:"Start",children:(0,r.jsx)(l,{size:"small",icon:(0,r.jsx)(nt,{}),onClick:()=>K(i),children:"Run"})}):o===5||o===1?(0,r.jsx)(z,{overlay:(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(l,{onClick:()=>ht(i),fullWidth:!0,children:"Stop and rollback"}),(0,r.jsx)(l,{onClick:()=>Et(i),fullWidth:!0,children:"Stop"})]})}):o===2?(0,r.jsx)(r.Fragment,{}):o===3?(0,r.jsx)(z,{overlay:(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(l,{onClick:()=>Lt(i),fullWidth:!0,children:"Resume"}),(0,r.jsx)(l,{onClick:()=>Tt(i),fullWidth:!0,children:"Rollback"})]})}):o===4?(0,r.jsx)(q,{title:"Restart",children:(0,r.jsx)(l,{icon:(0,r.jsx)(tt,{}),onClick:()=>K(i),fullWidth:!0})}):null})}},Bt={title:"Minimum PostHog version",render:function(g,i){return(0,r.jsx)("div",{children:i.posthog_min_version})}},Jt={title:"Maximum PostHog version",render:function(g,i){return(0,r.jsx)("div",{children:i.posthog_max_version})}},V={};V.future=[Y,j,Bt,Jt],V.management=[Y,kt,j,Ft,xt,Pt,It,wt];let H={};H.future=E,H.management=h;let Xt={expandedRowRender:function(g){return g&&(0,r.jsx)(At,{asyncMigration:g})},rowExpandable:c=>c.error_count>0,onRowExpand:function(g){Ct(g.id)}},Z=[{key:"management",label:`Management (${h.length})`},{key:"settings",label:"Settings"}];return E.length>0&&Z.splice(1,0,{key:"future",label:`Future Migrations (${E.length})`}),(0,r.jsx)("div",{children:t?.is_staff?(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(G,{caption:(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)("p",{children:"Manage async migrations in your instance."}),(0,r.jsxs)("p",{children:["Read about async migrations on our"," ",(0,r.jsx)(J,{to:"https://posthog.com/docs/self-host/configure/async-migrations/overview",children:"dedicated docs page"}),"."]})]})}),(0,r.jsx)(ot,{activeKey:e,onChange:Rt,tabs:Z}),["management","future"].includes(e)?(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)("div",{className:"mb-4 float-right",children:(0,r.jsx)(l,{icon:n?(0,r.jsx)(X,{}):(0,r.jsx)(B,{}),onClick:Q,type:"secondary",size:"small",children:"Refresh"})}),(0,r.jsx)(O,{pagination:{pageSize:10},loading:n,columns:V[e],dataSource:H[e],expandable:Xt}),T?(0,r.jsx)(ft,{...T}):null]}):e==="settings"?(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)("br",{}),A.map(c=>(0,r.jsx)("div",{children:(0,r.jsx)(vt,{setting:c})},c.key))]}):null]}):(0,r.jsx)(G,{caption:(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)("p",{children:"Only users with staff access can manage async migrations. Please contact your instance admin."}),(0,r.jsxs)("p",{children:["If you're an admin and don't have access, set ",(0,r.jsx)("code",{children:"is_staff=true"})," for your user on the PostgreSQL ",(0,r.jsx)("code",{children:"posthog_user"})," table."]})]})})})}export{Vt as AsyncMigrations,ar as scene};
//# sourceMappingURL=/static/AsyncMigrations-P5X562NE.js.map
