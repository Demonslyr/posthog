import { Meta, StoryFn } from '@storybook/react'
import { router } from 'kea-router'
import { useEffect } from 'react'
import { App } from 'scenes/App'
import { urls } from 'scenes/urls'

import { mswDecorator } from '~/mocks/browser'
import { toPaginatedResponse } from '~/mocks/handlers'
import {
    BreakdownAttributionType,
    ChartDisplayType,
    Experiment,
    FunnelConversionWindowTimeUnit,
    FunnelExperimentResults,
    FunnelsFilterType,
    FunnelVizType,
    InsightType,
    PropertyFilterType,
    PropertyOperator,
    SignificanceCode,
    TrendsExperimentResults,
} from '~/types'

const MOCK_EXPERIMENT: Experiment = {
    id: 1,
    name: 'storybook-experiment',
    description: null,
    start_date: '2024-12-15T21:59:00Z',
    end_date: null,
    feature_flag_key: 'storybook-experiment',
    feature_flag: {
        id: 121,
        team_id: 1,
        name: 'Feature Flag for Experiment storybook-experiment',
        key: 'storybook-experiment',
        filters: {
            groups: [
                {
                    properties: [],
                    rollout_percentage: 100,
                },
            ],
            multivariate: {
                variants: [
                    {
                        key: 'control',
                        rollout_percentage: 50,
                    },
                    {
                        key: 'test',
                        rollout_percentage: 50,
                    },
                ],
            },
            holdout_groups: null,
            aggregation_group_type_index: null,
        },
        deleted: false,
        active: true,
        ensure_experience_continuity: false,
    },
    holdout: null,
    holdout_id: null,
    exposure_cohort: null,
    parameters: {
        feature_flag_variants: [
            {
                key: 'control',
                rollout_percentage: 50,
            },
            {
                key: 'test',
                rollout_percentage: 50,
            },
        ],
        recommended_sample_size: 0,
        recommended_running_time: 0,
        minimum_detectable_effect: 0,
    },
    secondary_metrics: [],
    saved_metrics: [],
    filters: {},
    archived: false,
    created_by: {
        id: 1,
        uuid: '0193314c-c2b1-0000-24a1-a38b35180d80',
        distinct_id: 'Lc1U777y6KO8OhdOLGfd4G3J8o0ZVfs88EhoBuF2sYr',
        first_name: 'Juraj',
        last_name: '',
        email: 'juraj@posthog.com',
        is_email_verified: false,
        hedgehog_config: null,
    },
    created_at: '2024-12-22T21:52:57.218953Z',
    updated_at: '2024-12-22T22:06:35.347951Z',
    type: 'product',
    metrics: [
        {
            kind: 'ExperimentFunnelsQuery',
            funnels_query: {
                kind: 'FunnelsQuery',
                series: [
                    {
                        kind: 'EventsNode',
                        name: 'signup started',
                        event: 'signup started',
                    },
                    {
                        kind: 'EventsNode',
                        name: 'signup completed',
                        event: 'signup completed',
                    },
                ],
                dateRange: {
                    date_to: '2024-12-22T23:59',
                    date_from: '2024-12-08T23:06',
                    explicitDate: true,
                },
                funnelsFilter: {
                    layout: 'horizontal',
                    funnelVizType: 'steps',
                    funnelWindowInterval: 14,
                    funnelWindowIntervalUnit: 'day',
                },
                filterTestAccounts: false,
            },
        },
    ],
    metrics_secondary: [
        {
            kind: 'ExperimentTrendsQuery',
            name: 'Pageview secondary',
            count_query: {
                kind: 'TrendsQuery',
                series: [
                    {
                        kind: 'EventsNode',
                        name: '$pageview',
                        event: '$pageview',
                    },
                ],
                interval: 'day',
                dateRange: {
                    date_to: '2024-12-23T23:59',
                    date_from: '2024-12-09T10:15',
                    explicitDate: true,
                },
                trendsFilter: {
                    display: 'ActionsLineGraph',
                },
                filterTestAccounts: false,
            },
        },
    ],
}

const EXPERIMENT_FUNNELS_QUERY_1_RESULT: any = {
    cache_key: 'cache_a737fc184e59677d8fcf031d4ff7e0b0',
    cache_target_age: '2024-12-22T22:08:39.810830Z',
    calculation_trigger: null,
    count_query: {
        aggregation_group_type_index: null,
        breakdownFilter: {
            breakdown: '$feature/storybook-experiment',
            breakdown_group_type_index: null,
            breakdown_hide_other_aggregation: null,
            breakdown_histogram_bin_count: null,
            breakdown_limit: null,
            breakdown_normalize_url: null,
            breakdown_type: 'event',
            breakdowns: null,
        },
        compareFilter: null,
        conversionGoal: null,
        dateRange: {
            date_from: '2024-12-15T21:59:00+00:00',
            date_to: null,
            explicitDate: true,
        },
        filterTestAccounts: false,
        interval: 'day',
        kind: 'TrendsQuery',
        modifiers: null,
        properties: [
            {
                key: '$feature/storybook-experiment',
                label: null,
                operator: 'exact',
                type: 'event',
                value: ['control', 'test'],
            },
        ],
        response: null,
        samplingFactor: null,
        series: [
            {
                custom_name: null,
                event: '$pageview',
                fixedProperties: null,
                kind: 'EventsNode',
                limit: null,
                math: null,
                math_group_type_index: null,
                math_hogql: null,
                math_property: null,
                math_property_type: null,
                name: '$pageview',
                orderBy: null,
                properties: null,
                response: null,
            },
        ],
        trendsFilter: {
            aggregationAxisFormat: 'numeric',
            aggregationAxisPostfix: null,
            aggregationAxisPrefix: null,
            breakdown_histogram_bin_count: null,
            decimalPlaces: null,
            display: 'ActionsLineGraphCumulative',
            formula: null,
            hiddenLegendIndexes: null,
            showAlertThresholdLines: false,
            showLabelsOnSeries: null,
            showLegend: false,
            showPercentStackView: false,
            showValuesOnSeries: false,
            smoothingIntervals: 1,
            yAxisScaleType: 'linear',
        },
    },
    credible_intervals: {
        control: [0.4044188718116908, 0.4512572135073295],
        test: [0.5561842304551912, 0.6107799173058627],
    },
    exposure_query: {
        aggregation_group_type_index: null,
        breakdownFilter: {
            breakdown: '$feature_flag_response',
            breakdown_group_type_index: null,
            breakdown_hide_other_aggregation: null,
            breakdown_histogram_bin_count: null,
            breakdown_limit: null,
            breakdown_normalize_url: null,
            breakdown_type: 'event',
            breakdowns: null,
        },
        compareFilter: null,
        conversionGoal: null,
        dateRange: {
            date_from: '2024-12-15T21:59:00+00:00',
            date_to: null,
            explicitDate: true,
        },
        filterTestAccounts: false,
        interval: 'day',
        kind: 'TrendsQuery',
        modifiers: null,
        properties: [
            {
                key: '$feature_flag_response',
                label: null,
                operator: 'exact',
                type: 'event',
                value: ['control', 'test'],
            },
            {
                key: '$feature_flag',
                label: null,
                operator: 'exact',
                type: 'event',
                value: ['storybook-experiment'],
            },
        ],
        response: null,
        samplingFactor: null,
        series: [
            {
                custom_name: null,
                event: '$feature_flag_called',
                fixedProperties: null,
                kind: 'EventsNode',
                limit: null,
                math: 'dau',
                math_group_type_index: null,
                math_hogql: null,
                math_property: null,
                math_property_type: null,
                name: null,
                orderBy: null,
                properties: null,
                response: null,
            },
        ],
        trendsFilter: {
            aggregationAxisFormat: 'numeric',
            aggregationAxisPostfix: null,
            aggregationAxisPrefix: null,
            breakdown_histogram_bin_count: null,
            decimalPlaces: null,
            display: 'ActionsLineGraphCumulative',
            formula: null,
            hiddenLegendIndexes: null,
            showAlertThresholdLines: false,
            showLabelsOnSeries: null,
            showLegend: false,
            showPercentStackView: false,
            showValuesOnSeries: false,
            smoothingIntervals: 1,
            yAxisScaleType: 'linear',
        },
    },
    insight: [
        {
            data: [29.0, 317.0, 586.0, 799.0, 1011.0, 1236.0, 1499.0, 1752.0],
            labels: [
                '15-Dec-2024',
                '16-Dec-2024',
                '17-Dec-2024',
                '18-Dec-2024',
                '19-Dec-2024',
                '20-Dec-2024',
                '21-Dec-2024',
                '22-Dec-2024',
            ],
            days: [
                '2024-12-15',
                '2024-12-16',
                '2024-12-17',
                '2024-12-18',
                '2024-12-19',
                '2024-12-20',
                '2024-12-21',
                '2024-12-22',
            ],
            count: 1752.0,
            label: 'test',
            filter: {
                insight: 'TRENDS',
                properties: [
                    {
                        key: '$feature/storybook-experiment',
                        label: null,
                        operator: 'exact',
                        type: 'event',
                        value: ['control', 'test'],
                    },
                ],
                filter_test_accounts: false,
                date_to: '2024-12-22T22:08:26.203828Z',
                date_from: '2024-12-15T21:59:00Z',
                entity_type: 'events',
                interval: 'day',
                aggregationAxisFormat: 'numeric',
                display: 'ActionsLineGraphCumulative',
                showAlertThresholdLines: false,
                showLegend: false,
                showPercentStackView: false,
                showValuesOnSeries: false,
                smoothingIntervals: 1,
                yAxisScaleType: 'linear',
                breakdown: '$feature/storybook-experiment',
                breakdown_type: 'event',
            },
            action: {
                days: [
                    '2024-12-15T00:00:00Z',
                    '2024-12-16T00:00:00Z',
                    '2024-12-17T00:00:00Z',
                    '2024-12-18T00:00:00Z',
                    '2024-12-19T00:00:00Z',
                    '2024-12-20T00:00:00Z',
                    '2024-12-21T00:00:00Z',
                    '2024-12-22T00:00:00Z',
                ],
                id: '$pageview',
                type: 'events',
                order: 0,
                name: '$pageview',
                custom_name: null,
                math: null,
                math_property: null,
                math_hogql: null,
                math_group_type_index: null,
                properties: {},
            },
            breakdown_value: 'test',
        },
        {
            data: [15.0, 193.0, 398.0, 580.0, 730.0, 925.0, 1142.0, 1279.0],
            labels: [
                '15-Dec-2024',
                '16-Dec-2024',
                '17-Dec-2024',
                '18-Dec-2024',
                '19-Dec-2024',
                '20-Dec-2024',
                '21-Dec-2024',
                '22-Dec-2024',
            ],
            days: [
                '2024-12-15',
                '2024-12-16',
                '2024-12-17',
                '2024-12-18',
                '2024-12-19',
                '2024-12-20',
                '2024-12-21',
                '2024-12-22',
            ],
            count: 1279.0,
            label: 'control',
            filter: {
                insight: 'TRENDS',
                properties: [
                    {
                        key: '$feature/storybook-experiment',
                        label: null,
                        operator: 'exact',
                        type: 'event',
                        value: ['control', 'test'],
                    },
                ],
                filter_test_accounts: false,
                date_to: '2024-12-22T22:08:26.203828Z',
                date_from: '2024-12-15T21:59:00Z',
                entity_type: 'events',
                interval: 'day',
                aggregationAxisFormat: 'numeric',
                display: 'ActionsLineGraphCumulative',
                showAlertThresholdLines: false,
                showLegend: false,
                showPercentStackView: false,
                showValuesOnSeries: false,
                smoothingIntervals: 1,
                yAxisScaleType: 'linear',
                breakdown: '$feature/storybook-experiment',
                breakdown_type: 'event',
            },
            action: {
                days: [
                    '2024-12-15T00:00:00Z',
                    '2024-12-16T00:00:00Z',
                    '2024-12-17T00:00:00Z',
                    '2024-12-18T00:00:00Z',
                    '2024-12-19T00:00:00Z',
                    '2024-12-20T00:00:00Z',
                    '2024-12-21T00:00:00Z',
                    '2024-12-22T00:00:00Z',
                ],
                id: '$pageview',
                type: 'events',
                order: 0,
                name: '$pageview',
                custom_name: null,
                math: null,
                math_property: null,
                math_hogql: null,
                math_group_type_index: null,
                properties: {},
            },
            breakdown_value: 'control',
        },
    ],
    is_cached: false,
    kind: 'ExperimentTrendsQuery',
    last_refresh: '2024-12-22T22:08:24.810830Z',
    next_allowed_client_refresh: '2024-12-22T22:09:24.810830Z',
    p_value: 2.239025579852012e-17,
    probability: {
        control: 0.0,
        test: 1.0,
    },
    query_status: null,
    significance_code: 'significant',
    significant: true,
    stats_version: 1,
    timezone: 'UTC',
    variants: [
        {
            absolute_exposure: 2994.0,
            count: 1279.0,
            exposure: 1.0,
            key: 'control',
        },
        {
            absolute_exposure: 3006.0,
            count: 1752.0,
            exposure: 1.0040080160320641,
            key: 'test',
        },
    ],
}

const EXPERIMENT_TRENDS_QUERY_1_RESULT: any = {
    cache_key: 'cache_3d2e9b4138067caf6aaf806d3ca63c0a',
    cache_target_age: '2024-12-23T09:15:41.196028Z',
    calculation_trigger: null,
    count_query: {
        aggregation_group_type_index: null,
        breakdownFilter: {
            breakdown: '$feature/storybook-experiment',
            breakdown_group_type_index: null,
            breakdown_hide_other_aggregation: null,
            breakdown_histogram_bin_count: null,
            breakdown_limit: null,
            breakdown_normalize_url: null,
            breakdown_type: 'event',
            breakdowns: null,
        },
        compareFilter: null,
        conversionGoal: null,
        dateRange: {
            date_from: '2024-12-15T21:59:00+00:00',
            date_to: null,
            explicitDate: true,
        },
        filterTestAccounts: false,
        interval: 'day',
        kind: 'TrendsQuery',
        modifiers: null,
        properties: [
            {
                key: '$feature/storybook-experiment',
                label: null,
                operator: 'exact',
                type: 'event',
                value: ['control', 'test'],
            },
        ],
        response: null,
        samplingFactor: null,
        series: [
            {
                custom_name: null,
                event: '$pageview',
                fixedProperties: null,
                kind: 'EventsNode',
                limit: null,
                math: null,
                math_group_type_index: null,
                math_hogql: null,
                math_property: null,
                math_property_type: null,
                name: '$pageview',
                orderBy: null,
                properties: null,
                response: null,
            },
        ],
        trendsFilter: {
            aggregationAxisFormat: 'numeric',
            aggregationAxisPostfix: null,
            aggregationAxisPrefix: null,
            breakdown_histogram_bin_count: null,
            decimalPlaces: null,
            display: 'ActionsLineGraphCumulative',
            formula: null,
            hiddenLegendIndexes: null,
            showAlertThresholdLines: false,
            showLabelsOnSeries: null,
            showLegend: false,
            showPercentStackView: false,
            showValuesOnSeries: false,
            smoothingIntervals: 1,
            yAxisScaleType: 'linear',
        },
    },
    credible_intervals: {
        control: [0.4099418686181875, 0.457090262591097],
        test: [0.5561842304551912, 0.6107799173058627],
    },
    exposure_query: {
        aggregation_group_type_index: null,
        breakdownFilter: {
            breakdown: '$feature_flag_response',
            breakdown_group_type_index: null,
            breakdown_hide_other_aggregation: null,
            breakdown_histogram_bin_count: null,
            breakdown_limit: null,
            breakdown_normalize_url: null,
            breakdown_type: 'event',
            breakdowns: null,
        },
        compareFilter: null,
        conversionGoal: null,
        dateRange: {
            date_from: '2024-12-15T21:59:00+00:00',
            date_to: null,
            explicitDate: true,
        },
        filterTestAccounts: false,
        interval: 'day',
        kind: 'TrendsQuery',
        modifiers: null,
        properties: [
            {
                key: '$feature_flag_response',
                label: null,
                operator: 'exact',
                type: 'event',
                value: ['control', 'test'],
            },
            {
                key: '$feature_flag',
                label: null,
                operator: 'exact',
                type: 'event',
                value: ['storybook-experiment'],
            },
        ],
        response: null,
        samplingFactor: null,
        series: [
            {
                custom_name: null,
                event: '$feature_flag_called',
                fixedProperties: null,
                kind: 'EventsNode',
                limit: null,
                math: 'dau',
                math_group_type_index: null,
                math_hogql: null,
                math_property: null,
                math_property_type: null,
                name: null,
                orderBy: null,
                properties: null,
                response: null,
            },
        ],
        trendsFilter: {
            aggregationAxisFormat: 'numeric',
            aggregationAxisPostfix: null,
            aggregationAxisPrefix: null,
            breakdown_histogram_bin_count: null,
            decimalPlaces: null,
            display: 'ActionsLineGraphCumulative',
            formula: null,
            hiddenLegendIndexes: null,
            showAlertThresholdLines: false,
            showLabelsOnSeries: null,
            showLegend: false,
            showPercentStackView: false,
            showValuesOnSeries: false,
            smoothingIntervals: 1,
            yAxisScaleType: 'linear',
        },
    },
    insight: [
        {
            data: [29.0, 317.0, 586.0, 799.0, 1011.0, 1236.0, 1499.0, 1752.0, 1752.0],
            labels: [
                '15-Dec-2024',
                '16-Dec-2024',
                '17-Dec-2024',
                '18-Dec-2024',
                '19-Dec-2024',
                '20-Dec-2024',
                '21-Dec-2024',
                '22-Dec-2024',
                '23-Dec-2024',
            ],
            days: [
                '2024-12-15',
                '2024-12-16',
                '2024-12-17',
                '2024-12-18',
                '2024-12-19',
                '2024-12-20',
                '2024-12-21',
                '2024-12-22',
                '2024-12-23',
            ],
            count: 1752.0,
            label: 'test',
            filter: {
                insight: 'TRENDS',
                properties: [
                    {
                        key: '$feature/storybook-experiment',
                        label: null,
                        operator: 'exact',
                        type: 'event',
                        value: ['control', 'test'],
                    },
                ],
                filter_test_accounts: false,
                date_to: '2024-12-23T09:15:28.190447Z',
                date_from: '2024-12-15T21:59:00Z',
                entity_type: 'events',
                interval: 'day',
                aggregationAxisFormat: 'numeric',
                display: 'ActionsLineGraphCumulative',
                showAlertThresholdLines: false,
                showLegend: false,
                showPercentStackView: false,
                showValuesOnSeries: false,
                smoothingIntervals: 1,
                yAxisScaleType: 'linear',
                breakdown: '$feature/storybook-experiment',
                breakdown_type: 'event',
            },
            action: {
                days: [
                    '2024-12-15T00:00:00Z',
                    '2024-12-16T00:00:00Z',
                    '2024-12-17T00:00:00Z',
                    '2024-12-18T00:00:00Z',
                    '2024-12-19T00:00:00Z',
                    '2024-12-20T00:00:00Z',
                    '2024-12-21T00:00:00Z',
                    '2024-12-22T00:00:00Z',
                    '2024-12-23T00:00:00Z',
                ],
                id: '$pageview',
                type: 'events',
                order: 0,
                name: '$pageview',
                custom_name: null,
                math: null,
                math_property: null,
                math_hogql: null,
                math_group_type_index: null,
                properties: {},
            },
            breakdown_value: 'test',
        },
        {
            data: [15.0, 193.0, 398.0, 580.0, 730.0, 925.0, 1142.0, 1296.0, 1296.0],
            labels: [
                '15-Dec-2024',
                '16-Dec-2024',
                '17-Dec-2024',
                '18-Dec-2024',
                '19-Dec-2024',
                '20-Dec-2024',
                '21-Dec-2024',
                '22-Dec-2024',
                '23-Dec-2024',
            ],
            days: [
                '2024-12-15',
                '2024-12-16',
                '2024-12-17',
                '2024-12-18',
                '2024-12-19',
                '2024-12-20',
                '2024-12-21',
                '2024-12-22',
                '2024-12-23',
            ],
            count: 1296.0,
            label: 'control',
            filter: {
                insight: 'TRENDS',
                properties: [
                    {
                        key: '$feature/storybook-experiment',
                        label: null,
                        operator: 'exact',
                        type: 'event',
                        value: ['control', 'test'],
                    },
                ],
                filter_test_accounts: false,
                date_to: '2024-12-23T09:15:28.192190Z',
                date_from: '2024-12-15T21:59:00Z',
                entity_type: 'events',
                interval: 'day',
                aggregationAxisFormat: 'numeric',
                display: 'ActionsLineGraphCumulative',
                showAlertThresholdLines: false,
                showLegend: false,
                showPercentStackView: false,
                showValuesOnSeries: false,
                smoothingIntervals: 1,
                yAxisScaleType: 'linear',
                breakdown: '$feature/storybook-experiment',
                breakdown_type: 'event',
            },
            action: {
                days: [
                    '2024-12-15T00:00:00Z',
                    '2024-12-16T00:00:00Z',
                    '2024-12-17T00:00:00Z',
                    '2024-12-18T00:00:00Z',
                    '2024-12-19T00:00:00Z',
                    '2024-12-20T00:00:00Z',
                    '2024-12-21T00:00:00Z',
                    '2024-12-22T00:00:00Z',
                    '2024-12-23T00:00:00Z',
                ],
                id: '$pageview',
                type: 'events',
                order: 0,
                name: '$pageview',
                custom_name: null,
                math: null,
                math_property: null,
                math_hogql: null,
                math_group_type_index: null,
                properties: {},
            },
            breakdown_value: 'control',
        },
    ],
    is_cached: true,
    kind: 'ExperimentTrendsQuery',
    last_refresh: '2024-12-23T09:15:26.196028Z',
    next_allowed_client_refresh: '2024-12-23T09:16:26.196028Z',
    p_value: 3.747966822123568e-16,
    probability: {
        control: 0.0,
        test: 1.0,
    },
    query_status: null,
    significance_code: 'significant',
    significant: true,
    stats_version: 1,
    timezone: 'UTC',
    variants: [
        {
            absolute_exposure: 2994.0,
            count: 1296.0,
            exposure: 1.0,
            key: 'control',
        },
        {
            absolute_exposure: 3006.0,
            count: 1752.0,
            exposure: 1.0040080160320641,
            key: 'test',
        },
    ],
}

const meta: Meta = {
    title: 'Scenes-App/Experiments',
    parameters: {
        layout: 'fullscreen',
        viewMode: 'story',
        mockDate: '2023-02-15', // To stabilize relative dates
    },
    decorators: [
        mswDecorator({
            get: {
                '/api/projects/:team_id/experiments/': toPaginatedResponse([MOCK_EXPERIMENT]),
                '/api/projects/:team_id/experiments/1/': MOCK_EXPERIMENT,
                '/api/projects/:team_id/experiment_holdouts/': null,
            },
            post: {
                '/api/environments/:team_id/query/': (req) => {
                    // return [200, EXPERIMENT_FUNNELS_QUERY_1_RESULT]
                    console.log(req.body.query.kind)
                    if ((req.body as any).query.kind === 'ExperimentFunnelsQuery') {
                        return [200, EXPERIMENT_FUNNELS_QUERY_1_RESULT]
                    }
                    return [200, EXPERIMENT_TRENDS_QUERY_1_RESULT]
                },
            },
        }),
    ],
}
export default meta
export const ExperimentForm: StoryFn = () => {
    useEffect(() => {
        router.actions.push(urls.experiment('new'))
    }, [])
    return <App />
}

export const ExperimentsList: StoryFn = () => {
    useEffect(() => {
        router.actions.push(urls.experiments())
    }, [])
    return <App />
}

export const RunningExperiment: StoryFn = () => {
    useEffect(() => {
        router.actions.push(urls.experiment(MOCK_EXPERIMENT.id))
    }, [])
    return <App />
}
