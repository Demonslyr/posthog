# Generated by Django 4.2.18 on 2025-03-14 07:55
from django.contrib.postgres.operations import AddConstraintNotValid
from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("posthog", "0687_remove_taxonomy_team_only_constraints"),
    ]

    operations = [
        migrations.RunSQL(
            sql="""
                -- Drop existing constraints
                ALTER TABLE "posthog_cohortpeople" DROP CONSTRAINT IF EXISTS "posthog_cohortpeople_person_id_33da7d3f_fk";
                ALTER TABLE "posthog_featureflaghashkeyoverride" DROP CONSTRAINT IF EXISTS "posthog_featureflaghashkeyoverride_person_id_7e517f7c_fk";
                ALTER TABLE "posthog_persondistinctid" DROP CONSTRAINT IF EXISTS "posthog_persondistinctid_person_id_5d655bba_fk";

                -- Change column types to bigint
                ALTER TABLE "posthog_person" ALTER COLUMN "id" TYPE bigint USING "id"::bigint;
                ALTER SEQUENCE IF EXISTS "posthog_person_id_seq" AS bigint;

                ALTER TABLE "posthog_cohortpeople" ALTER COLUMN "person_id" TYPE bigint USING "person_id"::bigint;
                ALTER TABLE "posthog_featureflaghashkeyoverride" ALTER COLUMN "person_id" TYPE bigint USING "person_id"::bigint;
                ALTER TABLE "posthog_persondistinctid" ALTER COLUMN "person_id" TYPE bigint USING "person_id"::bigint;

                ALTER TABLE "posthog_persondistinctid" ALTER COLUMN "id" TYPE bigint USING "id"::bigint;
                ALTER SEQUENCE IF EXISTS "posthog_persondistinctid_id_seq" AS bigint;
            """,
            reverse_sql=migrations.RunSQL.noop,
        ),
        # Safely add constraints back (without validation)
        AddConstraintNotValid(
            model_name="cohortpeople",
            constraint=models.ForeignKey(
                to="posthog.person",
                on_delete=models.CASCADE,
                db_constraint=True,
                db_column="person_id",
            ).db_constraint,
        ),
        AddConstraintNotValid(
            model_name="featureflaghashkeyoverride",
            constraint=models.ForeignKey(
                to="posthog.person",
                on_delete=models.CASCADE,
                db_constraint=True,
                db_column="person_id",
            ).db_constraint,
        ),
        AddConstraintNotValid(
            model_name="persondistinctid",
            constraint=models.ForeignKey(
                to="posthog.person",
                on_delete=models.CASCADE,
                db_constraint=True,
                db_column="person_id",
            ).db_constraint,
        ),
        # Validate constraints separately afterward (safe, no locking)
        migrations.RunSQL(
            sql="""
                ALTER TABLE "posthog_cohortpeople" VALIDATE CONSTRAINT "posthog_cohortpeople_person_id_33da7d3f_fk";
                ALTER TABLE "posthog_featureflaghashkeyoverride" VALIDATE CONSTRAINT "posthog_featureflaghashkeyoverride_person_id_7e517f7c_fk";
                ALTER TABLE "posthog_persondistinctid" VALIDATE CONSTRAINT "posthog_persondistinctid_person_id_5d655bba_fk";
            """,
            reverse_sql=migrations.RunSQL.noop,
        ),
    ]
