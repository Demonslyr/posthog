# Generated by Django 4.2.18 on 2025-06-04 20:34

from django.db import migrations, models
import structlog

logger = structlog.get_logger(__name__)


def consolidate_base_currency(apps, schema_editor):
    """
    Consolidate base_currency from revenue and marketing analytics configs into Team model.
    Priority: Revenue analytics base currency > Marketing analytics base currency > USD (default)
    """
    Team = apps.get_model("posthog", "Team")
    TeamRevenueAnalyticsConfig = apps.get_model("posthog", "TeamRevenueAnalyticsConfig")
    TeamMarketingAnalyticsConfig = apps.get_model("posthog", "TeamMarketingAnalyticsConfig")

    teams_updated = 0
    teams_with_revenue_currency = 0
    teams_with_marketing_currency = 0
    teams_with_default_currency = 0

    for team in Team.objects.iterator():
        try:
            base_currency = "USD"  # Default fallback
            currency_source = "default"

            # Check for marketing analytics config first (lower priority)
            try:
                marketing_config = TeamMarketingAnalyticsConfig.objects.get(team=team)
                if hasattr(marketing_config, "base_currency") and marketing_config.base_currency:
                    base_currency = marketing_config.base_currency
                    currency_source = "marketing"
                    teams_with_marketing_currency += 1
                    logger.debug("Found marketing base currency", team_id=team.id, currency=base_currency)
            except TeamMarketingAnalyticsConfig.DoesNotExist:
                pass

            # Check for revenue analytics config (higher priority, will override marketing)
            try:
                revenue_config = TeamRevenueAnalyticsConfig.objects.get(team=team)
                if hasattr(revenue_config, "base_currency") and revenue_config.base_currency:
                    if currency_source == "marketing":
                        teams_with_marketing_currency -= 1  # We're overriding marketing
                    base_currency = revenue_config.base_currency
                    currency_source = "revenue"
                    teams_with_revenue_currency += 1
                    logger.debug("Found revenue base currency (overriding)", team_id=team.id, currency=base_currency)
            except TeamRevenueAnalyticsConfig.DoesNotExist:
                pass

            # Count defaults only if no other currency was found
            if currency_source == "default":
                teams_with_default_currency += 1

            # Update the team with the determined base currency
            team.base_currency = base_currency
            team.save()
            teams_updated += 1

            logger.debug(
                "Updated team base currency", team_id=team.id, base_currency=base_currency, source=currency_source
            )

        except Exception as e:
            logger.error("Failed to migrate base currency for team", team_id=team.id, error=str(e), exc_info=True)
            continue

    logger.info(
        "Base currency consolidation completed",
        teams_updated=teams_updated,
        teams_with_revenue_currency=teams_with_revenue_currency,
        teams_with_marketing_currency=teams_with_marketing_currency,
        teams_with_default_currency=teams_with_default_currency,
    )


def reverse_consolidate_base_currency(apps, schema_editor):
    """
    Reverse migration - this is a no-op since we don't want to lose the consolidated data
    and the individual configs still maintain their own base_currency fields.
    """
    logger.info("Reverse migration - base currency consolidation is irreversible (data preserved)")


class Migration(migrations.Migration):
    dependencies = [
        ("posthog", "0753_teammarketinganalyticsconfig"),
        ("posthog", "0758_alter_externaldatasource_source_type"),
    ]

    operations = [
        # First, add the base_currency field to Team model
        migrations.AddField(
            model_name="team",
            name="base_currency",
            field=models.CharField(
                choices=[
                    ("AED", "AED"),
                    ("AFN", "AFN"),
                    ("ALL", "ALL"),
                    ("AMD", "AMD"),
                    ("ANG", "ANG"),
                    ("AOA", "AOA"),
                    ("ARS", "ARS"),
                    ("AUD", "AUD"),
                    ("AWG", "AWG"),
                    ("AZN", "AZN"),
                    ("BAM", "BAM"),
                    ("BBD", "BBD"),
                    ("BDT", "BDT"),
                    ("BGN", "BGN"),
                    ("BHD", "BHD"),
                    ("BIF", "BIF"),
                    ("BMD", "BMD"),
                    ("BND", "BND"),
                    ("BOB", "BOB"),
                    ("BRL", "BRL"),
                    ("BSD", "BSD"),
                    ("BTC", "BTC"),
                    ("BTN", "BTN"),
                    ("BWP", "BWP"),
                    ("BYN", "BYN"),
                    ("BZD", "BZD"),
                    ("CAD", "CAD"),
                    ("CDF", "CDF"),
                    ("CHF", "CHF"),
                    ("CLP", "CLP"),
                    ("CNY", "CNY"),
                    ("COP", "COP"),
                    ("CRC", "CRC"),
                    ("CVE", "CVE"),
                    ("CZK", "CZK"),
                    ("DJF", "DJF"),
                    ("DKK", "DKK"),
                    ("DOP", "DOP"),
                    ("DZD", "DZD"),
                    ("EGP", "EGP"),
                    ("ERN", "ERN"),
                    ("ETB", "ETB"),
                    ("EUR", "EUR"),
                    ("FJD", "FJD"),
                    ("GBP", "GBP"),
                    ("GEL", "GEL"),
                    ("GHS", "GHS"),
                    ("GIP", "GIP"),
                    ("GMD", "GMD"),
                    ("GNF", "GNF"),
                    ("GTQ", "GTQ"),
                    ("GYD", "GYD"),
                    ("HKD", "HKD"),
                    ("HNL", "HNL"),
                    ("HRK", "HRK"),
                    ("HTG", "HTG"),
                    ("HUF", "HUF"),
                    ("IDR", "IDR"),
                    ("ILS", "ILS"),
                    ("INR", "INR"),
                    ("IQD", "IQD"),
                    ("IRR", "IRR"),
                    ("ISK", "ISK"),
                    ("JMD", "JMD"),
                    ("JOD", "JOD"),
                    ("JPY", "JPY"),
                    ("KES", "KES"),
                    ("KGS", "KGS"),
                    ("KHR", "KHR"),
                    ("KMF", "KMF"),
                    ("KRW", "KRW"),
                    ("KWD", "KWD"),
                    ("KYD", "KYD"),
                    ("KZT", "KZT"),
                    ("LAK", "LAK"),
                    ("LBP", "LBP"),
                    ("LKR", "LKR"),
                    ("LRD", "LRD"),
                    ("LTL", "LTL"),
                    ("LVL", "LVL"),
                    ("LSL", "LSL"),
                    ("LYD", "LYD"),
                    ("MAD", "MAD"),
                    ("MDL", "MDL"),
                    ("MGA", "MGA"),
                    ("MKD", "MKD"),
                    ("MMK", "MMK"),
                    ("MNT", "MNT"),
                    ("MOP", "MOP"),
                    ("MRU", "MRU"),
                    ("MTL", "MTL"),
                    ("MUR", "MUR"),
                    ("MVR", "MVR"),
                    ("MWK", "MWK"),
                    ("MXN", "MXN"),
                    ("MYR", "MYR"),
                    ("MZN", "MZN"),
                    ("NAD", "NAD"),
                    ("NGN", "NGN"),
                    ("NIO", "NIO"),
                    ("NOK", "NOK"),
                    ("NPR", "NPR"),
                    ("NZD", "NZD"),
                    ("OMR", "OMR"),
                    ("PAB", "PAB"),
                    ("PEN", "PEN"),
                    ("PGK", "PGK"),
                    ("PHP", "PHP"),
                    ("PKR", "PKR"),
                    ("PLN", "PLN"),
                    ("PYG", "PYG"),
                    ("QAR", "QAR"),
                    ("RON", "RON"),
                    ("RSD", "RSD"),
                    ("RUB", "RUB"),
                    ("RWF", "RWF"),
                    ("SAR", "SAR"),
                    ("SBD", "SBD"),
                    ("SCR", "SCR"),
                    ("SDG", "SDG"),
                    ("SEK", "SEK"),
                    ("SGD", "SGD"),
                    ("SRD", "SRD"),
                    ("SSP", "SSP"),
                    ("STN", "STN"),
                    ("SYP", "SYP"),
                    ("SZL", "SZL"),
                    ("THB", "THB"),
                    ("TJS", "TJS"),
                    ("TMT", "TMT"),
                    ("TND", "TND"),
                    ("TOP", "TOP"),
                    ("TRY", "TRY"),
                    ("TTD", "TTD"),
                    ("TWD", "TWD"),
                    ("TZS", "TZS"),
                    ("UAH", "UAH"),
                    ("UGX", "UGX"),
                    ("USD", "USD"),
                    ("UYU", "UYU"),
                    ("UZS", "UZS"),
                    ("VES", "VES"),
                    ("VND", "VND"),
                    ("VUV", "VUV"),
                    ("WST", "WST"),
                    ("XAF", "XAF"),
                    ("XCD", "XCD"),
                    ("XOF", "XOF"),
                    ("XPF", "XPF"),
                    ("YER", "YER"),
                    ("ZAR", "ZAR"),
                    ("ZMW", "ZMW"),
                ],
                default="USD",
                max_length=3,
            ),
        ),
        # Then, consolidate currency data from analytics configs to Team model
        migrations.RunPython(
            consolidate_base_currency,
            reverse_consolidate_base_currency,
        ),
        # Finally, remove the base_currency fields from analytics configs
        migrations.RemoveField(
            model_name="teammarketinganalyticsconfig",
            name="base_currency",
        ),
        migrations.RemoveField(
            model_name="teamrevenueanalyticsconfig",
            name="base_currency",
        ),
    ]
